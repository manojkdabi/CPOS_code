<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCP-OS v2.0 Multi-Module</title>

  <style>
    /* GLOBAL VARIABLES & RESET */
    :root {
      --bg: #f5f6fb;
      --surface: #ffffff;
      --surface2: #f2f3f7;
      --surface3: #e9edf5;
      --text: #1f2937;
      --muted: #5b6472;
      --muted2: #7a8494;
      --stroke: rgba(31, 41, 55, 0.14);
      --stroke2: rgba(31, 41, 55, 0.10);
      --divider: rgba(31, 41, 55, 0.08);
      --brandBlue1: #2f6fb5;
      --brandBlue2: #3c83c9;
      --brandField: #8fbf78;
      --primary: #2f6fb5;
      --primary2: #245ea6;
      --lemon: #f4d06f;
      --ok: #3a8f4b;
      --warn: #e6a83a;
      --recommended: #3c64b1;
      --conditional: #d77a1f;
      --shadow: 0 10px 24px rgba(28, 38, 63, 0.16);
      --shadow2: 0 16px 40px rgba(28, 38, 63, 0.18);
      --radius: 16px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";

      /* Sidebar */
      --sidebar-width: 280px;
      --sidebar-collapsed: 70px;
      --sidebar-bg: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
      --sidebar-hover: rgba(255, 255, 255, 0.1);
      --sidebar-active: linear-gradient(135deg, rgba(47, 111, 181, 0.3), rgba(143, 191, 120, 0.3));
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* SIDEBAR LAYOUT */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
    }

    .sidebar.collapsed {
      width: var(--sidebar-collapsed);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(47, 111, 181, 0.95), rgba(143, 191, 120, 0.95));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 900;
      font-size: 18px;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .logo-text {
      color: white;
      opacity: 1;
      transition: opacity 0.3s;
      white-space: nowrap;
      overflow: hidden;
    }

    .sidebar.collapsed .logo-text {
      opacity: 0;
      width: 0;
    }

    .logo-title {
      font-size: 16px;
      font-weight: 900;
      margin: 0;
    }

    .logo-subtitle {
      font-size: 11px;
      opacity: 0.8;
    }

    .sidebar-toggle {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .sidebar-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
    }

    .nav-item {
      margin: 8px 12px;
      padding: 14px 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .nav-item:hover {
      background: var(--sidebar-hover);
      color: white;
    }

    .nav-item.active {
      background: var(--sidebar-active);
      color: white;
      box-shadow: 0 4px 12px rgba(47, 111, 181, 0.3);
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--brandField);
      border-radius: 0 4px 4px 0;
    }

    .nav-icon {
      font-size: 24px;
      flex-shrink: 0;
      width: 24px;
      text-align: center;
    }

    .nav-label {
      flex: 1;
      font-weight: 600;
      font-size: 14px;
      opacity: 1;
      transition: opacity 0.3s;
      white-space: nowrap;
      overflow: hidden;
    }

    .sidebar.collapsed .nav-label {
      opacity: 0;
      width: 0;
    }

    .nav-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      background: #dc3545;
      color: white;
      opacity: 1;
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .nav-badge {
      opacity: 0;
      width: 0;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      flex-shrink: 0;
    }

    .user-info {
      flex: 1;
      min-width: 0;
      opacity: 1;
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .user-info {
      opacity: 0;
      width: 0;
    }

    .user-name {
      font-size: 13px;
      font-weight: 600;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
    }

    /* MAIN CONTENT AREA */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 100vh;
    }

    .sidebar.collapsed+.main-content {
      margin-left: var(--sidebar-collapsed);
    }

    .module-container {
      display: none;
    }

    .module-container.active {
      display: block;
    }

    /* Module header for non-CSOP modules */
    .module-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px;
      text-align: center;
      color: white;
      border-radius: 0 0 30px 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .module-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .module-title {
      font-size: 36px;
      font-weight: 900;
      margin-bottom: 10px;
    }

    .module-subtitle {
      font-size: 16px;
      opacity: 0.9;
    }

    .coming-soon {
      display: inline-block;
      padding: 12px 24px;
      background: #ffd700;
      color: #333;
      font-weight: 700;
      border-radius: 999px;
      margin-top: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 12px;
    }

    .module-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 30px 30px;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
      margin-top: 30px;
    }

    .feature-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--stroke);
    }

    .feature-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--divider);
    }

    .feature-title {
      font-size: 16px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .feature-label {
      font-size: 12px;
      color: var(--muted);
    }

    .feature-list {
      list-style: none;
      padding: 0;
    }

    .feature-list li {
      padding: 10px 0;
      padding-left: 30px;
      position: relative;
      color: var(--text);
      line-height: 1.6;
    }

    .feature-list li::before {
      content: '‚Ä¢';
      position: absolute;
      left: 10px;
      color: var(--primary);
      font-size: 20px;
    }

    //  CSOP MODULE - All existing styles preserved
    #csopModule .app {
      max-width: 100%;
      margin: 0;
      padding: 20px 30px 30px;
    }

    /* Import all existing CSOP styles */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
      padding: 12px 20px;
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.00)),
        linear-gradient(90deg, var(--brandBlue2), var(--brandField));
      color: #fff;
      box-shadow: var(--shadow2);
      border: 1px solid rgba(255, 255, 255, 0.20);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(47, 111, 181, 0.95), rgba(143, 191, 120, 0.95));
      box-shadow: 0 12px 30px rgba(28, 38, 63, 0.22);
      position: relative;
    }

    .logo:after {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.35);
    }

    .titleblock .h1 {
      font-size: 18px;
      font-weight: 900;
      margin: 0;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.22);
      border: 1px solid rgba(255, 255, 255, 0.28);
      color: #fff;
      max-width: 520px;
    }

    .dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.65);
    }

    .dot.ok {
      background: var(--ok);
    }

    .dot.bad {
      background: #ef4444;
    }

    .status-text {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: rgba(255, 255, 255, 0.95);
    }

    .tabs {
      display: flex;
      gap: 10px;
      padding: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.70);
      border: 1px solid var(--stroke2);
      margin-bottom: 16px;
      overflow: auto;
      box-shadow: var(--shadow);
    }

    .tab {
      flex: 1;
      min-width: 260px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.85);
      color: var(--text);
      transition: all 120ms ease;
      user-select: none;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.95);
    }

    .tab.active {
      background: linear-gradient(180deg, rgba(244, 208, 111, 0.60), rgba(255, 255, 255, 0.92));
      border-color: rgba(244, 208, 111, 0.90);
      box-shadow: 0 10px 22px rgba(28, 38, 63, 0.14);
    }

    .badgeNum {
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      background: rgba(31, 41, 55, 0.08);
      border: 1px solid rgba(31, 41, 55, 0.12);
    }

    .tab.active .badgeNum {
      background: rgba(244, 208, 111, 0.65);
      border-color: rgba(244, 208, 111, 0.95);
    }

    .tabText {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .tab .label {
      font-weight: 900;
      font-size: 13px;
    }

    .tab .desc {
      font-size: 12px;
      color: var(--muted);
    }

    .grid {
      display: grid;
      grid-template-columns: 1.25fr 0.75fr;
      gap: 14px;
    }

    @media (max-width:980px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .cardHeader {
      padding: 14px 16px;
      border-bottom: 1px solid var(--divider);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(233, 237, 245, 0.75), rgba(255, 255, 255, 0));
    }

    .cardHeader .h2 {
      margin: 0;
      font-size: 13px;
      letter-spacing: 0.35px;
      font-weight: 950;
      text-transform: uppercase;
      color: var(--text);
    }

    .cardHeader .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .cardBody {
      padding: 14px 16px 16px;
    }

    .btnRow {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn {
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid var(--stroke2);
      background: rgba(233, 237, 245, 0.85);
      color: var(--text);
      cursor: pointer;
      font-weight: 900;
      font-size: 13px;
      transition: all 120ms ease;
      user-select: none;
    }

    .btn:hover {
      background: rgba(233, 237, 245, 1);
    }

    .btn.primary {
      background: linear-gradient(180deg, rgba(47, 111, 181, 0.95), rgba(36, 94, 166, 0.95));
      border-color: rgba(36, 94, 166, 0.85);
      color: #fff;
    }

    .btn.ghost {
      background: rgba(255, 255, 255, 0.90);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .formGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width:980px) {
      .formGrid {
        grid-template-columns: 1fr;
      }
    }

    .field {
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid var(--stroke2);
      border-radius: 14px;
      padding: 10px 12px;
    }

    .field label {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .field label .cat {
      font-size: 11px;
      color: rgb(35, 95, 55);
      border: 1px solid rgb(160, 215, 170);
      padding: 2px 8px;
      border-radius: 999px;
      background: rgb(220, 245, 225);
      white-space: nowrap;
      font-weight: 800;
    }

    .field>label>span:first-child {
      font-weight: 800;
      color: rgb(128, 0, 32);
    }

    input,
    textarea,
    select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--stroke2);
      background: rgba(255, 255, 255, 0.95);
      color: var(--text);
      padding: 10px 10px;
      font-size: 13px;
      outline: none;
    }

    textarea {
      min-height: 84px;
      resize: vertical;
    }

    .small {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.55;
    }

    .mutedBox {
      border: 1px dashed rgba(47, 111, 181, 0.28);
      border-radius: 14px;
      padding: 12px 12px;
      background: linear-gradient(180deg, rgba(47, 111, 181, 0.10), rgba(255, 255, 255, 0.92));
      color: #111827;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-line;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 11px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: rgba(255, 255, 255, 0.85);
      font-size: 13px;
      color: var(--text);
    }

    .chip .k {
      font-family: var(--mono);
      font-size: 11.5px;
      color: var(--muted2);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 7px 11px;
      font-weight: 950;
      font-size: 12px;
      letter-spacing: 0.25px;
      border: 1px solid var(--stroke2);
      background: rgba(233, 237, 245, 0.85);
      text-transform: uppercase;
      color: var(--text);
    }

    .pill.ok {
      background: rgba(58, 143, 75, 0.18);
      border-color: rgba(58, 143, 75, 0.35);
      color: #1f5f2f;
    }

    .pill.warn {
      background: rgba(215, 122, 31, 0.18);
      border-color: rgba(215, 122, 31, 0.35);
      color: #7a3f0a;
    }

    .pill.bad {
      background: rgba(239, 68, 68, 0.10);
      border-color: rgba(239, 68, 68, 0.35);
      color: #991b1b;
    }

    .pill.blue {
      background: rgba(60, 100, 177, 0.18);
      border-color: rgba(60, 100, 177, 0.35);
      color: #25408c;
    }

    .pathGrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    @media (max-width:980px) {
      .pathGrid {
        grid-template-columns: 1fr;
      }
    }

    .pathCard {
      position: relative;
      border: 1px solid rgba(31, 41, 55, 0.10);
      box-shadow: 0 10px 24px rgba(28, 38, 63, 0.10);
      overflow: hidden;
      border-radius: 18px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(47, 111, 181, 0.07), rgba(255, 255, 255, 1) 60%);
    }

    .pathCard::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      border-radius: 18px 0 0 18px;
      background: rgba(47, 111, 181, 0.55);
    }

    .pathCard.path-rp {
      background: linear-gradient(180deg, rgba(58, 143, 75, 0.10), rgba(255, 255, 255, 1) 60%);
    }

    .pathCard.path-rp::before {
      background: rgba(58, 143, 75, 0.60);
    }

    .pathCard.path-awd {
      background: linear-gradient(180deg, rgba(215, 122, 31, 0.10), rgba(255, 255, 255, 1) 60%);
    }

    .pathCard.path-awd::before {
      background: rgba(215, 122, 31, 0.60);
    }

    .pathCard.path-bio {
      background: linear-gradient(180deg, rgba(60, 100, 177, 0.10), rgba(255, 255, 255, 1) 60%);
    }

    .pathCard.path-bio::before {
      background: rgba(60, 100, 177, 0.60);
    }

    .pathCard.path-erw {
      background: linear-gradient(180deg, rgba(15, 118, 110, 0.10), rgba(255, 255, 255, 1) 60%);
    }

    .pathCard.path-erw::before {
      background: rgba(15, 118, 110, 0.60);
    }

    .pathTop {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
    }

    .pathName {
      font-weight: 1000;
      font-size: 15px;
      margin: 0;
      color: var(--text);
    }

    .pathMeta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .list {
      margin: 8px 0 0;
      padding-left: 16px;
      color: rgba(31, 41, 55, 0.78);
      font-size: 13px;
      line-height: 1.6;
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    .foot {
      margin-top: 14px;
      font-size: 12px;
      color: rgba(31, 41, 55, 0.45);
      text-align: center;
    }

    .warning-box {
      background: rgba(230, 168, 58, 0.1);
      border: 1px solid var(--warn);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
    }

    .probe-box {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border: 2px solid #2196F3;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .feature-grid {
        grid-template-columns: 1fr;
      }
    }

    //ADVANCED ASSESSMENT MODULE - INDEPENDENT STYLES

    /* Shimmer animation for progress bar */
    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    /* Advanced Option Grid */
    .adv-option-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }

    .adv-option-item {
      position: relative;
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 18px;
      background: white;
      border: 2px solid rgba(31, 41, 55, 0.1);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 70px;
    }

    .adv-option-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      border-color: rgba(47, 111, 181, 0.3);
      background: rgba(47, 111, 181, 0.02);
    }

    .adv-option-item.selected {
      background: linear-gradient(135deg, rgba(47, 111, 181, 0.15), rgba(143, 191, 120, 0.12));
      border-color: #2f6fb5;
      box-shadow: 0 8px 20px rgba(47, 111, 181, 0.25);
    }

    .adv-option-icon {
      font-size: 32px;
      flex-shrink: 0;
      width: 40px;
      text-align: center;
    }

    .adv-option-radio {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
      cursor: pointer;
      accent-color: #2f6fb5;
    }

    .adv-option-label {
      flex: 1;
      font-size: 15px;
      font-weight: 500;
      color: #1f2937;
      line-height: 1.4;
    }

    .adv-option-item.selected .adv-option-label {
      font-weight: 600;
      color: #2f6fb5;
    }

    /* Advanced Numeric Input */
    .adv-numeric-input {
      width: 100%;
      padding: 16px 20px;
      border-radius: 14px;
      border: 2px solid rgba(31, 41, 55, 0.12);
      background: rgba(255, 255, 255, 0.95);
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      transition: all 0.2s ease;
      text-align: center;
    }

    .adv-numeric-input:focus {
      outline: none;
      border-color: #2f6fb5;
      box-shadow: 0 0 0 4px rgba(47, 111, 181, 0.1);
    }

    /* Checkpoint Cards */
    .adv-checkpoint-card {
      background: white;
      border-radius: 20px;
      padding: 28px;
      margin: 24px 0;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      border: 2px solid #3b82f6;
    }

    .adv-checkpoint-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .adv-checkpoint-icon {
      font-size: 40px;
    }

    .adv-checkpoint-title {
      flex: 1;
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
    }

    .adv-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .adv-summary-stat {
      padding: 16px;
      background: linear-gradient(135deg, #f9fafb, #f3f4f6);
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      text-align: center;
    }

    .adv-summary-stat .label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .adv-summary-stat .value {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .adv-summary-stat .icon {
      font-size: 28px;
    }

    .adv-confidence-bar {
      margin: 20px 0;
      padding: 16px;
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-radius: 12px;
      border-left: 4px solid #f59e0b;
    }

    .adv-confidence-bar .label {
      font-size: 12px;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .adv-confidence-bar .bar {
      height: 10px;
      background: white;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .adv-confidence-bar .fill {
      height: 100%;
      background: linear-gradient(90deg, #f59e0b, #10b981);
      transition: width 0.3s ease;
    }

    .adv-confidence-bar .text {
      font-size: 14px;
      font-weight: 600;
      color: #92400e;
    }

    .adv-checkpoint-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    /* Disqualification Alert */
    .adv-disqualification {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      border: 2px solid #ef4444;
      border-radius: 20px;
      padding: 28px;
      margin: 24px 0;
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.2);
    }

    .adv-disqualification .header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .adv-disqualification .icon {
      font-size: 48px;
    }

    .adv-disqualification .title {
      font-size: 24px;
      font-weight: 700;
      color: #991b1b;
    }

    .adv-disqualification .reason {
      font-size: 16px;
      color: #7f1d1d;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .adv-disqualification .suggestion {
      background: white;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #f59e0b;
    }

    .adv-disqualification .suggestion-title {
      font-size: 15px;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 10px;
    }

    .adv-disqualification .suggestion-text {
      font-size: 15px;
      color: #1f2937;
      line-height: 1.6;
    }

    /* Results Dashboard */
    .adv-results-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }

    .adv-dimension-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 2px solid #e5e7eb;
      transition: all 0.3s ease;
    }

    .adv-dimension-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .adv-dimension-card .dim-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f3f4f6;
    }

    .adv-dimension-card .dim-icon {
      font-size: 32px;
    }

    .adv-dimension-card .dim-title {
      flex: 1;
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }

    .adv-dimension-card .dim-score {
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      margin: 16px 0;
    }

    .adv-dimension-card .dim-score.excellent {
      color: #10b981;
    }

    .adv-dimension-card .dim-score.good {
      color: #3b82f6;
    }

    .adv-dimension-card .dim-score.moderate {
      color: #f59e0b;
    }

    .adv-dimension-card .dim-score.poor {
      color: #ef4444;
    }

    .adv-dimension-card .dim-bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .adv-dimension-card .dim-bar .fill {
      height: 100%;
      transition: width 0.5s ease;
    }

    .adv-dimension-card .dim-bar .fill.excellent {
      background: linear-gradient(90deg, #10b981, #059669);
    }

    .adv-dimension-card .dim-bar .fill.good {
      background: linear-gradient(90deg, #3b82f6, #2563eb);
    }

    .adv-dimension-card .dim-bar .fill.moderate {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .adv-dimension-card .dim-bar .fill.poor {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .adv-option-grid {
        grid-template-columns: 1fr;
      }

      .adv-summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .adv-results-dashboard {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <!-- SIDEBAR NAVIGATION -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <div class="logo-icon">SC</div>
        <div class="logo-text">
          <div class="logo-title">SCP-OS</div>
          <div class="logo-subtitle">v2.0 Multi-Module</div>
        </div>
      </div>
      <button class="sidebar-toggle" onclick="toggleSidebar()">
        <span id="toggleIcon">‚óÄ</span>
      </button>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-item" onclick="switchModule('client')" id="nav-client" data-module="client">
        <span class="nav-icon">üìã</span>
        <span class="nav-label">Client Registration</span>
      </div>

      <div class="nav-item active" onclick="switchModule('csop')" id="nav-csop" data-module="csop">
        <span class="nav-icon">üéØ</span>
        <span class="nav-label">CSOP Assessment</span>
        <span class="nav-badge">Active</span>
      </div>

      <!-- Add this inside the sidebar, after the existing CSOP Assessment item -->
      <div class="nav-item" onclick="switchModule('advanced')" id="nav-advanced" data-module="advanced">
        <span class="nav-icon">üöÄ</span>
        <span class="nav-label">Advanced Assessment</span>
        <span class="nav-badge" style="background: linear-gradient(135deg, #10b981, #059669); color: white; font-size: 10px; padding: 3px 8px; border-radius: 10px; margin-left: auto;">NEW</span>
      </div>

      <div class="nav-item" onclick="switchModule('queries')" id="nav-queries" data-module="queries">
        <span class="nav-icon">üìä</span>
        <span class="nav-label">Queries & Analysis</span>
      </div>

      <div class="nav-item" onclick="switchModule('admin')" id="nav-admin" data-module="admin">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Admin Panel</span>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar">MK</div>
        <div class="user-info">
          <div class="user-name">Manoj Kumar</div>
          <div class="user-role">System Admin</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT AREA -->
  <div class="main-content" id="mainContent">

    <!-- ========== CLIENT REGISTRATION MODULE ========== -->
    <div class="module-container" id="clientModule">
      <div class="module-header">
        <div class="module-icon">üìã</div>
        <div class="module-title">Client Registration Module</div>
        <div class="module-subtitle">Register new clients and manage their profiles</div>
        <span class="coming-soon">COMING SOON</span>
      </div>

      <div class="module-content">
        <div class="feature-grid">
          <div class="feature-card">
            <div class="feature-header">
              <div class="feature-title">QUICK REGISTRATION</div>
              <div class="feature-label">Register new client</div>
            </div>
            <div>
              <p style="margin-bottom: 15px;">This module will allow you to:</p>
              <ul class="feature-list">
                <li>Register new farmer/client profiles</li>
                <li>Manage client contact information</li>
                <li>Track farm locations and sizes</li>
                <li>Maintain historical records</li>
              </ul>
            </div>
          </div>

          <div class="feature-card">
            <div class="feature-header">
              <div class="feature-title">RECENT REGISTRATIONS</div>
              <div class="feature-label">Last 5 clients</div>
            </div>
            <div style="padding: 40px; text-align: center; color: var(--muted);">
              <p>No registrations yet. This feature is under development.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== CSOP ASSESSMENT MODULE ========== -->
    <div class="module-container active" id="csopModule">
      <!-- INSERT YOUR COMPLETE CSOP CODE HERE -->
      <!-- This is where the entire content from full_working_frontend_130226_v2.txt goes -->

      <div class="app">
        <!-- Top Bar -->
        <div class="topbar">
          <div class="brand">
            <div class="logo"></div>
            <div class="titleblock">
              <div class="h1">Carbon Pathway-Optimization System (CSOP)</div>
            </div>
          </div>
          <div class="status-pill">
            <div id="statusDot" class="dot"></div>
            <div id="statusText" class="status-text">Loading‚Ä¶</div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs" role="tablist">
          <button class="tab active" data-step="0" onclick="goStep(0)">
            <span class="badgeNum">0</span>
            <span class="tabText">
              <span class="label">Adaptive Questionnaire</span>
              <span class="desc">Auto-fill Step 1 inputs</span>
            </span>
          </button>
          <button class="tab" data-step="1" onclick="goStep(1)">
            <span class="badgeNum">1</span>
            <span class="tabText">
              <span class="label">Land & Management</span>
              <span class="desc">Enter values</span>
            </span>
          </button>
          <button class="tab" data-step="2" onclick="goStep(2)">
            <span class="badgeNum">2</span>
            <span class="tabText">
              <span class="label">Carbon Analysis</span>
              <span class="desc">Scores ‚Ä¢ Eligibility</span>
            </span>
          </button>
          <button class="tab" data-step="3" onclick="goStep(3)">
            <span class="badgeNum">3</span>
            <span class="tabText">
              <span class="label">Decision Summary</span>
              <span class="desc">Stack + Save</span>
            </span>
          </button>
        </div>

        <!-- Language Selector -->
        <div
          style="display:flex;align-items:center;gap:20px;margin-bottom:20px;padding:12px 16px;background:rgba(255,255,255,0.95);border-radius:12px;border:1px solid var(--stroke2);box-shadow:0 2px 8px rgba(28,38,63,0.08);">
          <span style="font-weight:700;font-size:14px;color:#1f2937;white-space:nowrap;">Language / ‡§≠‡§æ‡§∑‡§æ:</span>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 12px;border-radius:8px;background:rgba(47,111,181,0.08);border:1px solid rgba(47,111,181,0.2);">
            <input type="radio" name="language" value="EN" id="langEN" checked style="width:18px;height:18px;margin:0;cursor:pointer;accent-color:#2f6fb5;">
            <span style="font-weight:600;font-size:14px;color:#1f2937;">English</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 12px;border-radius:8px;background:rgba(255,255,255,0.5);border:1px solid rgba(31,41,55,0.1);">
            <input type="radio" name="language" value="HI" id="langHI" style="width:18px;height:18px;margin:0;cursor:pointer;accent-color:#2f6fb5;">
            <span style="font-weight:600;font-size:14px;color:#1f2937;">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</span>
          </label>
        </div>

        <!-- Panel 0: Questionnaire -->
        <div id="panel0" class="panel active">
          <div class="grid">
            <div class="card">
              <div class="cardHeader">
                <h3 class="h2"><span id="cardTitleQuestionnaire">Adaptive Questionnaire</span></h3>
                <div class="hint"><span id="cardHintQuestionnaire">about 50 Q - Fast setup - Auto-fills Step 1</span>
                </div>
              </div>
              <div class="cardBody">

                <!-- Enhanced Progress Section -->
                <div id="progressSection"
                  style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; display: none; border: 1px solid var(--stroke2);">

                  <!-- Progress Header -->
                  <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                    <div>
                      <strong id="questionCounter" style="font-size: 15px; color: var(--text);">Question 1 of 25</strong>
                      <span id="progressPercentage" style="margin-left: 10px; color: var(--muted); font-size: 13px;">(0% complete)</span>
                    </div>
                    <div style="display: flex; gap: 15px; font-size: 13px; flex-wrap: wrap;">
                      <span id="answeredCounter" style="color: #28a745; font-weight: 600;">‚úì <strong>0</strong> answered</span>
                      <span id="signalsCounter" style="color: #007bff; font-weight: 600;">‚ö° <strong>0</strong> signals</span>
                      <span id="factorsCounter" style="color: #6f42c1; font-weight: 600;">üìä <strong>0</strong> factors</span>
                    </div>
                  </div>

                  <!-- Progress Bar -->
                  <div
                    style="background: #e9ecef; border-radius: 10px; height: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                    <div id="progressBar"
                      style="background: linear-gradient(90deg, #28a745, #007bff, #6f42c1); height: 100%; width: 0%; transition: width 0.4s ease; box-shadow: 0 0 10px rgba(40,167,69,0.5);">
                    </div>
                  </div>
                </div>

                <!-- Question Display Area -->
                <div style="margin-bottom: 15px;">
                  <div style="margin-top:10px" class="mutedBox" id="qQuestionText">
                    <span id="qQuestionTextDefault">Click Start to begin the questionnaire.</span>
                  </div>
                  <div id="qHelpText" class="small" style="margin-top:8px; color: var(--muted);"></div>
                </div>

                <!-- Answer Input Area -->
                <div id="qAnswerBox" style="margin-top:10px; margin-bottom: 15px;"></div>

                <!-- Status/Warning Messages -->
                <div id="qNavStatus" class="small" style="margin-top:8px; margin-bottom: 12px;"></div>

                <!-- START BUTTON (Centered, Only Before Questionnaire) -->
                <div style="display: flex; justify-content: center; margin-bottom: 12px;">
                  <button class="btn" id="btnQStart" onclick="qStart()" disabled style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: 700; border: none; box-shadow: 0 4px 12px rgba(40,167,69,0.3); min-width: 200px; padding: 14px 32px; font-size: 16px;">
                                <span id="btnQStartText">üöÄ Start Questionnaire</span>
                            </button>
                </div>

                <!-- Enhanced Navigation Buttons (During Questionnaire) -->
                <div
                  style="display: flex; gap: 10px; justify-content: space-between; flex-wrap: wrap; margin-bottom: 12px;">

                  <!-- Left Side Buttons -->
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn ghost" id="btnQBack" onclick="qBack()" disabled style="min-width: 80px;">
                                    <span id="btnQBackText">‚Üê Back</span>
                                </button>

                    <button class="btn ghost" id="btnQSkip" onclick="qSkip()" disabled style="min-width: 80px; background: rgba(255,193,7,0.08); border-color: rgba(255,193,7,0.4); color: #856404;">
                                    <span id="btnQSkipText">Skip ‚Üí</span>
                                </button>
                  </div>

                  <!-- Right Side Buttons -->
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn primary" id="btnQNext" onclick="qNext()" disabled style="display: none; font-weight: 700;">
                                    <span id="btnQNextText">Next ‚Üí</span>
                                </button>

                    <button class="btn ghost" id="btnQSave" onclick="saveProgress()" disabled style="display: none; background: rgba(23,162,184,0.1); border-color: #17a2b8; color: #117a8b;">
                                    <span id="btnQSaveText">üíæ Save Progress</span>
                                </button>

                    <button class="btn ghost" onclick="showDebugInfo()" style="font-size: 11px; padding: 8px 12px;">
                                    <span id="btnQDebugText">üêõ Debug</span>
                                </button>
                  </div>
                </div>

                <!-- üî¥ FINISH BUTTON ROW - Only shown when all rounds complete -->
                <div id="finishButtonRow"
                  style="display: none; margin-bottom: 12px; padding: 16px; background: linear-gradient(135deg, rgba(220,53,69,0.08), rgba(200,35,51,0.05)); border-radius: 12px; border: 2px dashed rgba(220,53,69,0.3);">
                  <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                    <div style="text-align: center;">
                      <div style="font-size: 13px; color: #721c24; font-weight: 600; margin-bottom: 8px;">
                        <span id="finishPromptText">‚úÖ All 3 Rounds Complete - Fully Validated Assessment</span>
                      </div>
                    </div>
                    <button class="btn" id="btnQFinish" onclick="qFinish()" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; font-weight: 700; border: none; min-width: 220px; padding: 14px 32px; font-size: 16px; box-shadow: 0 4px 12px rgba(220,53,69,0.4);">
                                    <span id="btnQFinishText">‚úì Finish & Apply Results</span>
                                </button>
                  </div>
                </div>

                <!-- Auto-save Indicator -->
                <div id="autoSaveIndicator"
                  style="padding: 10px; background: linear-gradient(135deg, #d1ecf1, #bee5eb); border: 1px solid #bee5eb; border-radius: 8px; color: #0c5460; font-size: 13px; display: none; text-align: center; font-weight: 600;">
                  <span id="autoSaveText">üíæ Progress auto-saved</span>
                </div>

              </div>
            </div>

            <!-- Derived Signals Card -->
            <div class="card">
              <div class="cardHeader">
                <h3 class="h2"><span id="cardTitleSignals">Derived Signals + Auto-filled Factors</span></h3>
                <div class="hint"><span id="cardHintSignals">Questionnaire explainability</span></div>
              </div>
              <div class="cardBody">
                <div id="qDerivedBox" class="mutedBox">
                  <span id="qDerivedBoxDefault">Signals and auto-filled factors will appear here.</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel 1: Inputs -->
        <div id="panel1" class="panel">
          <div class="grid">
            <div class="card">
              <div class="cardHeader">
                <h3 class="h2"><span id="cardTitleInputs">Inputs</span></h3>
                <div class="hint">
                  <span id="cardHintInputs">Grouped by Factor_Category ‚Ä¢ Select class for each factor</span>
                </div>
              </div>
              <div class="cardBody">
                <div class="formGrid" id="factorForm"></div>
                <div id="evalGate" style="margin-top:12px;">
                  <div class="btnRow">
                    <button class="btn ghost" onclick="clearSelections()">
                                    <span id="btnClearText">Clear</span>
                                </button>
                    <button class="btn primary" id="btnEvaluate" onclick="evaluateAndGo()" disabled>
                                    <span id="btnEvaluateText">Evaluate ‚Üí</span>
                                </button>
                  </div>
                  <div id="evalGateHint" class="small" style="margin-top:8px"></div>
                </div>
                <div style="margin-top:10px" class="small" id="selectionHint">
                  <span id="selectionHintText">Tip: Enter any soil + climate + management values you have. You can evaluate even with partial inputs.</span>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="cardHeader">
                <h3 class="h2"><span id="cardTitleExplain">Explainability</span></h3>
                <div class="hint"><span id="cardHintExplain">Weights √ó desirability + Pathway_context</span></div>
              </div>
              <div class="cardBody">
                <div id="notesBox" class="mutedBox">
                  <span id="notesBoxDefault">Enter values to view class, desirability, and pathway context here.</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel 2: Results -->
        <div id="panel2" class="panel">
          <div class="grid">
            <div class="card">
              <div class="cardHeader">
                <h3 class="h2"><span id="cardTitlePathways">Pathway Screening</span></h3>
                <div class="hint"><span id="cardHintPathways">Computed from Lite tables</span></div>
              </div>
              <div class="cardBody">
                <div id="screeningGrid" class="pathGrid"></div>
                <div style="margin-top:12px" class="btnRow">
                  <button class="btn ghost" onclick="goStep(1)">
                                <span id="btnBackToInputs">‚Üê Back</span>
                            </button>
                  <button class="btn primary" onclick="goStep(3)">
                                <span id="btnToSummary">Decision Summary ‚Üí</span>
                            </button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="cardHeader">
                <h3 class="h2"><span id="cardTitleCurrentInputs">Current Inputs</span></h3>
                <div class="hint"><span id="cardHintCurrentInputs">Observed_Value + classified Class_Label</span></div>
              </div>
              <div class="cardBody">
                <div id="selectionRecap" class="chips"></div>
                <div style="margin-top:12px" class="mutedBox" id="mrvStrip">
                  <span id="mrvStripDefault">MRV focus strip will appear after evaluation.</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel 3: Summary -->
        <div id="panel3" class="panel">
          <div class="grid">
            <div class="card">
              <div class="cardHeader">
                <h3 class="h2"><span id="cardTitleSummary">Decision Summary</span></h3>
                <div class="hint"><span id="cardHintSummary">Recommended stack + key cautions</span></div>
              </div>
              <div class="cardBody">
                <div id="headlineBox" class="mutedBox">
                  <span id="headlineBoxDefault">Evaluate at least one input to generate a decision summary.</span>
                </div>
                <div class="small" style="margin-bottom:8px;color:var(--muted)">
                  <b><span id="labelRecommended">Recommended</span></b>
                </div>
                <div id="recStack" class="chips" style="margin-bottom:12px"></div>
                <div class="small" style="margin-bottom:8px;color:var(--muted)">
                  <b><span id="labelConditional">Conditional</span></b>
                </div>
                <div id="condStack" class="chips" style="margin-bottom:12px"></div>
                <div class="small" style="margin-bottom:8px;color:var(--muted)">
                  <b><span id="labelExcluded">Excluded</span></b>
                </div>
                <div id="exclStack" class="chips" style="margin-bottom:8px"></div>

                <!-- Action Buttons -->
                <div
                  style="margin-top:12px; display: flex; gap: 10px; justify-content: space-between; flex-wrap: wrap;">
                  <!-- Left: Back button -->
                  <button class="btn ghost" onclick="goStep(2)">
                                <span id="btnBackToResults">‚Üê Back</span>
                            </button>

                  <!-- Right: Action buttons -->
                  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="restartEvaluation()" style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none; font-weight: 600;">
                                    <span id="btnRestartEval">üîÑ New Evaluation</span>
                                </button>
                    <button class="btn primary" onclick="saveAssessment()">
                                    <span id="btnSaveAssessment">Save Assessment</span>
                                </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="cardHeader">
                <h3 class="h2"><span id="cardTitleSaveAssess">Save Assessment</span></h3>
                <div class="hint"><span id="cardHintSaveAssess">Optional metadata</span></div>
              </div>
              <div class="cardBody">
                <div class="formGrid">
                  <div class="field">
                    <label><span id="labelClientId">Client_ID</span> <span class="cat">meta</span></label>
                    <input id="metaClientId" placeholder="Default">
                  </div>
                  <div class="field">
                    <label><span id="labelSiteId">Site_ID</span> <span class="cat">meta</span></label>
                    <input id="metaSiteId" placeholder="SITE-001">
                  </div>
                  <div class="field">
                    <label><span id="labelSiteName">Site_Name</span> <span class="cat">meta</span></label>
                    <input id="metaSiteName" placeholder="Village / Farm / Plot">
                  </div>
                  <div class="field">
                    <label><span id="labelCropSystem">Crop_System</span> <span class="cat">meta</span></label>
                    <input id="metaCropSystem" placeholder="Rice paddy / Upland cereal">
                  </div>
                  <div class="field" style="grid-column:1/-1">
                    <label><span id="labelNotes">Notes</span> <span class="cat">meta</span></label>
                    <textarea id="metaNotes" placeholder="Any assumptions, site notes‚Ä¶"></textarea>
                  </div>
                </div>
                <div id="saveStatus" style="margin-top:10px" class="small"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="foot">CP-OS v1.0 ‚Ä¢ CPOS-Lite (Full Features)</div>
      </div>
  </div>
            <!-- ADVANCED ASSESSMENT MODULE -->
        <div class="module-container" id="advancedModule">

          <!-- Module Header -->
          <div class="module-header">
            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 300px;">
                <h1
                  style="margin: 0; font-size: 28px; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 12px;">
                  üöÄ Advanced Multi-Dimensional Assessment
                </h1>
                <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 14px;">
                  Comprehensive feasibility analysis using Land Suitability + Implementation Readiness framework
                </p>
              </div>

              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn ghost" onclick="showAdvancedHelp()">
          <span style="font-size: 18px;">‚ùì</span>
          <span>How it works</span>
        </button>
                <button class="btn primary" onclick="startAdvancedAssessment()" id="btnStartAdvanced">
          <span style="font-size: 18px;">‚ñ∂Ô∏è</span>
          <span>Start Assessment</span>
        </button>
              </div>
            </div>
          </div>

          <!-- Welcome Screen -->
          <div id="advancedWelcome" class="content-section">

            <!-- Comparison Card -->
            <div
              style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <h2 style="margin: 0 0 20px 0; font-size: 20px; font-weight: 700; color: #1f2937;">
                Why Advanced Assessment?
              </h2>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">

                <!-- Standard Assessment -->
                <div
                  style="padding: 20px; background: linear-gradient(135deg, #f9fafb, #f3f4f6); border-radius: 12px; border: 2px solid #e5e7eb;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <span style="font-size: 32px;">üìä</span>
                    <div>
                      <div style="font-size: 16px; font-weight: 700; color: #1f2937;">Standard Assessment</div>
                      <div style="font-size: 13px; color: #6b7280;">Quick screening</div>
                    </div>
                  </div>

                  <ul style="margin: 0; padding-left: 20px; color: #4b5563; font-size: 14px; line-height: 1.8;">
                    <li>Simple weighted scoring (0-100%)</li>
                    <li>Single eligibility decision</li>
                    <li>~20 questions, 15 minutes</li>
                    <li>Good for large-scale screening</li>
                  </ul>
                </div>

                <!-- Advanced Assessment -->
                <div
                  style="padding: 20px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 12px; border: 2px solid #3b82f6;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <span style="font-size: 32px;">üöÄ</span>
                    <div>
                      <div style="font-size: 16px; font-weight: 700; color: #1e40af;">Advanced Assessment</div>
                      <div style="font-size: 13px; color: #1e3a8a;">Deep feasibility study</div>
                    </div>
                  </div>

                  <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; font-size: 14px; line-height: 1.8;">
                    <li><strong>11 dimensions</strong> (D1-D6, I1-I5)</li>
                    <li><strong>Land + Farmer</strong> readiness</li>
                    <li>~35-50 questions, 25-35 minutes</li>
                    <li>Confidence intervals &amp; risk analysis</li>
                    <li>Actionable gap closure plans</li>
                    <li>Investment-grade reports</li>
                  </ul>
                </div>

              </div>
            </div>

            <!-- Framework Overview -->
            <div
              style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <h2 style="margin: 0 0 20px 0; font-size: 20px; font-weight: 700; color: #1f2937;">
                Assessment Framework
              </h2>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">

                <!-- Land Suitability -->
                <div
                  style="padding: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border-left: 4px solid #f59e0b;">
                  <div style="font-size: 14px; font-weight: 700; color: #92400e; margin-bottom: 12px;">
                    üåç LAND SUITABILITY (D1-D6)
                  </div>
                  <div style="font-size: 13px; color: #78350f; line-height: 1.6;">
                    <strong>D1:</strong> Biophysical (soil, drainage)<br>
                    <strong>D2:</strong> Infrastructure (irrigation, bunds)<br>
                    <strong>D3:</strong> Location &amp; Context<br>
                    <strong>D4:</strong> Legal &amp; Carbon Eligibility<br>
                    <strong>D5:</strong> Economic Viability<br>
                    <strong>D6:</strong> Carbon Potential
                  </div>
                </div>

                <!-- Implementation Readiness -->
                <div
                  style="padding: 16px; background: linear-gradient(135deg, #ddd6fe, #c4b5fd); border-radius: 12px; border-left: 4px solid #8b5cf6;">
                  <div style="font-size: 14px; font-weight: 700; color: #5b21b6; margin-bottom: 12px;">
                    üë§ IMPLEMENTATION READINESS (I1-I5)
                  </div>
                  <div style="font-size: 13px; color: #4c1d95; line-height: 1.6;">
                    <strong>I1:</strong> Human Capital &amp; Capacity<br>
                    <strong>I2:</strong> Resources &amp; Labor<br>
                    <strong>I3:</strong> Financial Capacity<br>
                    <strong>I4:</strong> Risk Management<br>
                    <strong>I5:</strong> Support &amp; Extension
                  </div>
                </div>

                <!-- Real Feasibility -->
                <div
                  style="padding: 16px; background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 12px; border-left: 4px solid #10b981;">
                  <div style="font-size: 14px; font-weight: 700; color: #065f46; margin-bottom: 12px;">
                    üéØ REAL FEASIBILITY
                  </div>
                  <div style="font-size: 13px; color: #064e3b; line-height: 1.6;">
                    <strong>Combined Score:</strong><br>
            ‚àö(Land √ó Implementation)<br><br>
                    <strong>Decision Logic:</strong><br>
            Threshold-based recommendations<br>
            Gap identification &amp; closure plans<br>
            Monte Carlo uncertainty analysis
                  </div>
                </div>

              </div>
            </div>

            <!-- Call to Action -->
            <div style="text-align: center; padding: 32px;">
              <button class="btn primary" onclick="startAdvancedAssessment()" style="font-size: 16px; padding: 16px 32px;">
        <span style="font-size: 24px;">üöÄ</span>
        <span>Start Advanced Assessment Now</span>
      </button>
            </div>

          </div>

          <!-- Assessment Interface (Initially Hidden) -->
          <div id="advancedInterface" style="display: none;">

            <!-- Progress Section -->
            <div id="advancedProgress"
              style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 16px; padding: 20px; margin-bottom: 24px; border: 2px solid #bae6fd;">

              <!-- Progress Header -->
              <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">

                <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                  <!-- Tier Badge -->
                  <div id="advTierBadge"
                    style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 20px; font-size: 13px; font-weight: 700; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <span>üìç</span>
                    <span>Land Suitability</span>
                  </div>

                  <!-- Question Counter -->
                  <div id="advQuestionCounter" style="font-size: 15px; font-weight: 600; color: #1f2937;">
                    Question 1 of 8
                  </div>
                </div>

                <!-- Stats -->
                <div style="display: flex; gap: 20px; font-size: 13px; flex-wrap: wrap;">
                  <div style="display: flex; align-items: center; gap: 6px; font-weight: 600;">
                    <span style="font-size: 16px;">üìä</span>
                    <span id="advProgressPercent" style="color: #0369a1; font-weight: 700;">0%</span>
                  </div>

                  <div style="display: flex; align-items: center; gap: 6px; font-weight: 600;">
                    <span style="font-size: 16px;">‚úì</span>
                    <span>Answered:</span>
                    <span id="advAnsweredCount" style="color: #0369a1; font-weight: 700;">0</span>
                  </div>

                  <div style="display: flex; align-items: center; gap: 6px; font-weight: 600;">
                    <span style="font-size: 16px;">‚è±Ô∏è</span>
                    <span id="advTimeEstimate">~25 min left</span>
                  </div>
                </div>

              </div>

              <!-- Progress Bar -->
              <div
                style="background: white; border-radius: 12px; height: 14px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1); position: relative;">
                <div id="advProgressBar"
                  style="height: 100%; width: 0%; background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6); transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); position: relative; overflow: hidden;">
                  <div
                    style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); animation: shimmer 2s infinite;">
                  </div>
                </div>
              </div>

            </div>

            <!-- Question Card -->
            <div id="advQuestionCard"
              style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 24px; margin-bottom: 20px; color: white; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">

              <div id="advQuestionNumber"
                style="display: inline-block; background: rgba(255, 255, 255, 0.2); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-bottom: 12px; letter-spacing: 0.5px;">
                QUESTION 1
              </div>

              <div id="advQuestionText"
                style="font-size: 20px; font-weight: 600; line-height: 1.4; margin-bottom: 12px;">
                Loading question...
              </div>

              <div id="advQuestionContext"
                style="display: none; align-items: flex-start; gap: 10px; background: rgba(255, 255, 255, 0.15); padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.5; margin-top: 12px; border-left: 4px solid rgba(255, 255, 255, 0.4);">
                <div style="font-size: 20px; flex-shrink: 0;">üí°</div>
                <div id="advContextText"></div>
              </div>

            </div>

            <!-- Answer Options -->
            <div id="advAnswerBox" style="margin-bottom: 24px;">
              <!-- Dynamic content -->
            </div>

            <!-- Navigation Buttons -->
            <div style="display: flex; gap: 12px; justify-content: space-between; flex-wrap: wrap;">

              <button class="btn ghost" onclick="advGoBack()" id="btnAdvBack" style="display: none;">
        <span>‚Üê</span>
        <span>Back</span>
      </button>

              <div style="flex: 1;"></div>

              <button class="btn ghost" onclick="advSkipQuestion()" id="btnAdvSkip">
        <span>‚è≠Ô∏è</span>
        <span>Skip</span>
      </button>

              <button class="btn primary" onclick="advNextQuestion()" id="btnAdvNext" disabled>
        <span id="advNextLabel">Next</span>
        <span>‚Üí</span>
      </button>

            </div>

          </div>

          <!-- Results Section (Initially Hidden) -->
          <div id="advancedResults" style="display: none;">
            <!-- Results will be rendered here -->
          </div>

        </div>






        //--==========QUERIES & ANALYSIS MODULE==========
        <div class="module-container" id="queriesModule">
          <div class="module-header">
            <div class="module-icon">üìä</div>
            <div class="module-title">Queries & Analysis Module</div>
            <div class="module-subtitle">Advanced data queries and visual analytics</div>
            <span class="coming-soon">COMING SOON</span>
          </div>
          <div class="module-content">
            <div class="feature-grid">
              <div class="feature-card">
                <div class="feature-header">
                  <div class="feature-title">SAVED QUERIES</div>
                  <div class="feature-label">Quick access reports</div>
                </div>
                <div>
                  <p style="margin-bottom: 15px;">This module will provide:</p>
                  <ul class="feature-list">
                    <li>Custom query builder for assessment data</li>
                    <li>Cross-site pathway comparison</li>
                    <li>Temporal trend analysis</li>
                    <li>Export functionality for reports</li>
                  </ul>
                </div>
              </div>
              <div class="feature-card">
                <div class="feature-header">
                  <div class="feature-title">VISUAL ANALYTICS</div>
                  <div class="feature-label">Charts & graphs</div>
                </div>
                <div style="padding: 40px; text-align: center; color: var(--muted);">
                  <p>Interactive dashboards and visualizations coming soon.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        //--==========ADMIN PANEL MODULE==========
        <div class="module-container" id="adminModule">
          <div class="module-header">
            <div class="module-icon">‚öôÔ∏è</div>
            <div class="module-title">Admin Panel</div>
            <div class="module-subtitle">System configuration and user management</div>
            <span class="coming-soon">COMING SOON</span>
          </div>
          <div class="module-content">
            <div class="feature-grid">
              <div class="feature-card">
                <div class="feature-header">
                  <div class="feature-title">USER MANAGEMENT</div>
                  <div class="feature-label">Manage system users</div>
                </div>
                <div>
                  <p style="margin-bottom: 15px;">This module will allow you to:</p>
                  <ul class="feature-list">
                    <li>Create and manage user accounts</li>
                    <li>Set role-based permissions</li>
                    <li>Monitor user activity</li>
                    <li>Configure system settings</li>
                  </ul>
                </div>
              </div>
              <div class="feature-card">
                <div class="feature-header">
                  <div class="feature-title">SYSTEM STATUS</div>
                  <div class="feature-label">Health monitoring</div>
                </div>
                <div style="padding: 40px; text-align: center; color: var(--muted);">
                  <p>System health monitoring dashboard coming soon.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
        // MULTI-MODULE SPA NAVIGATION

          let currentModule='csop';
          let sidebarCollapsed=false;

          function switchModule(moduleName) {
  document.querySelectorAll('.module-container').forEach(m => {
    m.classList.remove('active');
  });

  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.remove('active');
  });

  const moduleMap = {
    'client': 'clientModule',
    'csop': 'csopModule',
    'queries': 'queriesModule',
    'admin': 'adminModule',
    'advanced': 'advancedModule'
  };

  if (!moduleMap[moduleName]) {
    console.error('[Module] Unknown module:', moduleName);
    return;
  }

  var moduleElement = document.getElementById(moduleMap[moduleName]);
  if (moduleElement) {
    moduleElement.classList.add('active');
  } else {
    console.error('[Module] Module element not found:', moduleMap[moduleName]);
  }

  var navElement = document.getElementById('nav-' + moduleName) || document.querySelector('.nav-item[data-module="' + moduleName + '"]');  if (navElement) {
    navElement.classList.add('active');
  } else {
    console.error('[Module] Nav element not found: nav-' + moduleName);
  }

  currentModule = moduleName;

  console.log('[Module] Switched to:', moduleName);

}

 window.switchModule = switchModule;

          function toggleSidebar() {
            const sidebar=document.getElementById('sidebar');
            const toggleIcon=document.getElementById('toggleIcon');

            sidebar.classList.toggle('collapsed');
            sidebarCollapsed= !sidebarCollapsed;

            toggleIcon.textContent=sidebarCollapsed ? '‚ñ∂': '‚óÄ';

            console.log('[Sidebar] Collapsed:', sidebarCollapsed);
          }


            window.toggleSidebar = toggleSidebar;

          // Mobile menu toggle (optional)
          function toggleMobileMenu() {
            const sidebar=document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
          }

          // CSOP MODULE - ALL YOUR EXISTING JAVASCRIPT

          // Global state object (from your existing code)
          window.CPOSL= {

            language: 'EN',
            PATHWAYS: ['RP-SOC',
            'AWD-CH‚ÇÑ',
            'BIOCHAR',
            'ERW'],
            data: {
              bounds: [], desirability: [], weights: []
            }

            ,
            idx: {
              boundsByVar: new Map(),
                desirIdx: new Map(),
                wIdx: new Map()
            }

            ,
            selections: {}

            ,
            lastResults: null,
            aspectsMap: {}

            ,
            q: {

              available: false,
              bank: [],
              options: [],
              derivationRules: [],
              routingRules: [],
              signalToLiteMap: [],
              idx: {
                qBankById: new Map(),
                  qOptionsByQ: new Map(),
                  qDerivByWhenQ: new Map(),
                  qRoutesByCurrentQ: new Map(),
                  qSignalMapByKey: new Map(),
                  startQuestions: []
              }
            }

            ,
            qState: {

              mode: 'BASIC',
              sessionId: null,
              answered: {}

              ,
              signals: {}

              ,
              skippedQuestions: {}

              ,
              queue: [],
              current: null,
              history: [],
              answeredCount: 0,
              minTarget: 5,
              maxCap: 50,
              stop: false,
              probeCount: 0,
              pendingProbe: null,
              pendingWarning: null,
              lastAutoSave: 0,
              startedAt: null,
              domainSequence: null
            }

            ,
            rounds: {

              current: 0,
              total: 3,
              questionsPerRound: 15,
              config: {
                1: {
                  name: 'Quick Overview',
                    description: 'Get a broad picture of your farm',
                    strategy: 'DOMAIN_ROTATION',
                    domains: ['SOIL', 'CROP', 'MANAGEMENT', 'TILLAGE', 'RESIDUE', 'FERTILIZER', 'AGRICULTURE'],
                    maxPerDomain: 3
                }

                ,
                2: {
                  name: 'Detailed Analysis',
                    description: 'Deep dive into key areas',
                    strategy: 'SIGNAL_DRIVEN',
                    focusOn: ['HIGH_PRIORITY_SIGNALS', 'UNCERTAIN_AREAS']
                }

                ,
                3: {
                  name: 'Validation Check',
                    description: 'Verify key information',
                    strategy: 'CONSISTENCY_CHECK',
                    validationPairs: []
                }
              }

              ,
              answered: {
                1: [],
                  2: [],
                  3: []
              }
            }
          }

          ;

// INSERT ALL YOUR EXISTING JAVASCRIPT FUNCTIONS HERE

          // Utilities
          function setStatus(ok, msg) {
            const dot=document.getElementById('statusDot');
            const text=document.getElementById('statusText');

            if (dot) {
              dot.classList.remove('ok', 'bad');
              dot.classList.add(ok ? 'ok' : 'bad');
            }

            if (text) text.textContent=msg || (ok ? 'Ready' : 'Error');
          }

          function goStep(n) {
            document.querySelectorAll('.tab').forEach(function(el) {
                var isActive=Number(el.dataset.step)===n;
                el.classList.toggle('active', isActive);
              }

            );

            for (var i=0; i <=3; i++) {
              var panel=document.getElementById('panel'+ i);
              if (panel) panel.classList.toggle('active', i===n);
            }
          }

          function escapeHtml(s) {
            return String(s==null ? '' : s) .replace(/&/g, '&amp;') .replace(/</g, '&lt;') .replace(/>/g, '&gt;') .replace(/"/g, '&quot;');

            }

            function toNum(v) {
              if (v==null) return null;
              var n=Number(v);
              return Number.isFinite(n) ? n : null;
            }

            function toBool(v) {
              if (typeof v==='boolean') return v;
              var s=String(v || '').trim().toLowerCase();
              return s==='true'|| s==='1'|| s==='yes';
            }

            function normKey(s) {
              return String(s==null ? '' : s).trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            }

            function getField(row, keys, fallback) {
              if ( !row || typeof row !=='object') return fallback !==undefined ? fallback : '';

              for (var i=0; i < keys.length; i++) {
                var k=keys[i];

                if (row[k] !==undefined && row[k] !==null && String(row[k]).trim() !=='') {
                  return row[k];
                }
              }

              return fallback !==undefined ? fallback : '';
            }

            // Backend API calls
            function gsRun(fnName) {
              var args=Array.prototype.slice.call(arguments, 1);

              return new Promise(function(resolve, reject) {
                  if (typeof google==='undefined'|| !google.script || !google.script.run) {
                    reject(new Error('Apps Script runtime not available'));
                    return;
                  }

                  var runner=google.script.run .withSuccessHandler(resolve) .withFailureHandler(reject);

                  if (typeof runner[fnName] !=='function') {
                    reject(new Error('Function not found: '+ fnName));
                    return;
                  }

                  runner[fnName].apply(runner, args);
                }

              );
            }

            function getCPOSLiteTables() {
              return gsRun('getCPOSLiteTables');
            }

            function getCPOSQuestionnaireConfig() {
              return gsRun('getCPOSQuestionnaireConfig');
            }

            // INITIALIZATION

            document.addEventListener('DOMContentLoaded', function() {
                console.log('[SPA] Multi-Module Application initialized');
                console.log('[SPA] Active module:', currentModule);

                // Initialize CSOP module if it's the active one
                if (currentModule==='csop') {
                  initCSOP();
                }
              }

            );

            function initCSOP() {
              console.log('[CSOP] Initializing CSOP module...');
              setStatus(false, 'Loading...');

              // Load your CSOP data
              Promise.all([ getCPOSLiteTables(),
                getCPOSQuestionnaireConfig()]).then(function(results) {
                  console.log('[CSOP] Data loaded successfully');
                  setStatus(true, 'Ready');

                  // Continue with your existing initialization code...

                }

              ).catch(function(err) {
                  console.error('[CSOP] Failed to load:', err);
                  setStatus(false, 'Error loading data');
                }

              );
            }

            // INSERT ALL REMAINING JAVASCRIPT FROM YOUR WORKING FILE

            /* 
     * Copy and paste ALL the remaining JavaScript code from 
     * full_working_frontend_130226_v2.txt here, including:
     * 
     * - All questionnaire functions
     * - Signal processing
     * - Factor mapping
     * - Evaluation logic
     * - UI update functions
     * - Everything else from your working code
     */

            // CPOS-LITE FRONTEND - COMPLETE VERSION WITH ALL FEATURES

            // Global state object
            window.CPOSL= {

              language: 'EN',
              PATHWAYS: ['RP-SOC', 'AWD-CH‚ÇÑ', 'BIOCHAR', 'ERW'],
              data: {
                bounds: [],
                desirability: [],
                weights: []
              }

              ,
              idx: {
                boundsByVar: new Map(),
                desirIdx: new Map(),
                wIdx: new Map()
              }

              ,
              selections: {}

              ,
              lastResults: null,
              aspectsMap: {}

              ,
              q: {

                available: false,
                bank: [],
                options: [],
                derivationRules: [],
                routingRules: [],
                signalToLiteMap: [],
                idx: {
                  qBankById: new Map(),
                  qOptionsByQ: new Map(),
                  qDerivByWhenQ: new Map(),
                  qRoutesByCurrentQ: new Map(),
                  qSignalMapByKey: new Map(),
                  startQuestions: []
                }
              }

              ,
              qState: {

                mode: 'BASIC',
                sessionId: null,
                answered: {}

                ,
                signals: {}

                ,
                skippedQuestions: {}

                ,
                queue: [],
                current: null,
                history: [],
                answeredCount: 0,
                minTarget: 5,
                maxCap: 50,
                stop: false,
                probeCount: 0,
                pendingProbe: null,
                pendingWarning: null,
                lastAutoSave: 0,
                startedAt: null,
                domainSequence: null
              }

              ,
              rounds: {

                current: 0,
                total: 3,
                questionsPerRound: 15,
                config: {
                  1: {
                    name: 'Quick Overview',
                    description: 'Get a broad picture of your farm',
                    strategy: 'DOMAIN_ROTATION',
                    // üî¥ UPDATED: Only use domains that actually have questions
                    domains: ['SOIL', 'CROP', 'MANAGEMENT', 'TILLAGE', 'RESIDUE', 'FERTILIZER', 'AGRICULTURE'],
                    maxPerDomain: 3 // 7 domains √ó 3 = 21 max (we only need 15)
                  }

                  ,
                  2: {
                    name: 'Detailed Analysis',
                    description: 'Deep dive into key areas',
                    strategy: 'SIGNAL_DRIVEN',
                    focusOn: ['HIGH_PRIORITY_SIGNALS', 'UNCERTAIN_AREAS']
                  }

                  ,
                  3: {
                    name: 'Validation Check',
                    description: 'Verify key information',
                    strategy: 'CONSISTENCY_CHECK',
                    validationPairs: []
                  }
                }

                ,
                answered: {
                  1: [],
                  2: [],
                  3: []
                }
              }
            }

            ;


            /**
             * Discover available domains from question bank
             */
            function discoverAvailableDomains() {
              var domainCounts= {}

              ;

              Array.from(CPOSL.q.idx.qBankById.values()).forEach(function(q) {
                  if (q.Is_Active===false) return;
                  var domain=extractDomain(q.Question_ID);
                  domainCounts[domain]=(domainCounts[domain] || 0) + 1;
                }

              );

              // Sort by count (most questions first)
              var sortedDomains=Object.keys(domainCounts) .filter(function(d) {
                  return domainCounts[d] > 0;
                }

              ) .sort(function(a, b) {
                  return domainCounts[b] - domainCounts[a];
                }

              );

              console.log('[Discovery] Available domains:', domainCounts);
              console.log('[Discovery] Sorted by count:', sortedDomains);

              return sortedDomains;
            }

            // UTILITIES
            function setStatus(ok, msg) {
              const dot=document.getElementById('statusDot');
              const text=document.getElementById('statusText');

              if (dot) {
                dot.classList.remove('ok', 'bad');
                dot.classList.add(ok ? 'ok' : 'bad');
              }

              if (text) text.textContent=msg || (ok ? 'Ready' : 'Error');
            }

            function goStep(n) {
              document.querySelectorAll('.tab').forEach(function(el) {
                  var isActive=Number(el.dataset.step)===n;
                  el.classList.toggle('active', isActive);
                }

              );

              for (var i=0; i <=3; i++) {
                var panel=document.getElementById('panel'+ i);
                if (panel) panel.classList.toggle('active', i===n);
              }
            }

            function escapeHtml(s) {
              return String(s==null ? '' : s) .replace(/&/g, '&amp;') .replace(/</g, '&lt;') .replace(/>/g, '&gt;') .replace(/"/g, '&quot;');

              }

              function toNum(v) {
                if (v==null) return null;
                var n=Number(v);
                return Number.isFinite(n) ? n : null;
              }

              function toBool(v) {
                if (typeof v==='boolean') return v;
                var s=String(v || '').trim().toLowerCase();
                return s==='true'|| s==='1'|| s==='yes';
              }

              function normKey(s) {
                return String(s==null ? '' : s).trim().toLowerCase().replace(/[^a-z0-9]/g, '');
              }

              function getField(row, keys, fallback) {
                if ( !row || typeof row !=='object') return fallback !==undefined ? fallback : '';

                for (var i=0; i < keys.length; i++) {
                  var k=keys[i];

                  if (row[k] !==undefined && row[k] !==null && String(row[k]).trim() !=='') {
                    return row[k];
                  }
                }

                return fallback !==undefined ? fallback : '';
              }

              // CONSISTENCY RULES - Validate answer coherence
              var CONSISTENCY_RULES=[ {

                id: 'RULE_SOIL_01',
                name: 'Drainage-Texture Contradiction',
                check: function(signals) {
                  var drainage=signals['DRAINAGE'] ? signals['DRAINAGE'].value : null;
                  var texture=signals['TEXTURE'] ? signals['TEXTURE'].value : null;

                  if ((drainage==='POOR'|| drainage==='VERYPOOR') && (texture==='SANDY'|| texture==='LIGHTSANDY')) {
                    return {
                      valid: false,
                      severity: 'HIGH',
                      message: 'Sandy soils typically drain quickly. If water stays for 2-3 days, your soil likely has some clay content.',
                      conflictingQuestions: ['Q_S015', 'Q_S008']
                    }

                    ;
                  }

                  return {
                    valid: true
                  }

                  ;
                }
              }

              ,
                {

                id: 'RULE_SOIL_02',
                name: 'Compaction-Tillage Contradiction',
                check: function(signals) {
                  var compaction=signals['COMPACTION'] ? signals['COMPACTION'].value : null;
                  var tillage=signals['TILLAGE'] ? signals['TILLAGE'].value : null;

                  if (compaction==='HIGH'&& tillage==='ZEROTILL') {
                    return {
                      valid: false,
                      severity: 'MEDIUM',
                      message: 'Zero-till practices can initially cause surface compaction, but after 2-3 years it typically improves.',
                      conflictingQuestions: ['Q_M021', 'Q_M009']
                    }

                    ;
                  }

                  return {
                    valid: true
                  }

                  ;
                }
              }

              ,
                {

                id: 'RULE_NUMERIC_01',
                name: 'SOC Physical Bounds',
                check: function(signals) {
                  var socSignal=signals['SOC_MEASURED'];
                  var socValue=socSignal ? parseFloat(socSignal.value) : null;

                  if (socValue && socValue > 10) {
                    return {
                      valid: false,
                      severity: 'HIGH',
                      message: 'Soil organic carbon above 10% is rare in mineral soils. Please verify the value.',
                      conflictingQuestions: ['Q_S003']
                    }

                    ;
                  }

                  return {
                    valid: true
                  }

                  ;
                }
              }

              ,
                {

                id: 'RULE_CROP_01',
                name: 'Rice-Rainfed Contradiction',
                check: function(signals) {
                  var hasCrop=function(cropName) {
                    return Object.keys(signals).some(function(k) {
                        return k.indexOf('CROP') >=0 && signals[k].value && String(signals[k].value).toUpperCase().indexOf(cropName) >=0;
                      }

                    );
                  }

                  ;

                  var irrigation=signals['IRRIGATION'] ? signals['IRRIGATION'].value : null;

                  if (hasCrop('RICE') && irrigation==='NONE') {
                    return {
                      valid: false,
                      severity: 'MEDIUM',
                      message: 'Rice usually needs consistent water. Are you growing upland/aerobic rice, or is your area naturally flooded during monsoon?',
                      conflictingQuestions: ['Q_A1', 'Q_M015']
                    }

                    ;
                  }

                  return {
                    valid: true
                  }

                  ;
                }
              }

              ,
                {

                id: 'RULE_MGT_01',
                name: 'High Nitrogen - Low Yield Contradiction',
                check: function(signals) {
                  var nRate=toNum(signals['NITROGEN_RATE'] ? signals['NITROGEN_RATE'].value : null);
                  var yieldVal=toNum(signals['CROP_YIELD'] ? signals['CROP_YIELD'].value : null);
                  var crop=signals['CROP'] ? signals['CROP'].value : null;

                  if (nRate && nRate > 200 && yieldVal && yieldVal < 3 && (crop==='RICE'|| crop==='WHEAT'|| crop==='MAIZE')) {
                    return {
                      valid: false,
                      severity: 'HIGH',
                      message: 'High nitrogen ('+ nRate + ' kg/ha) with low yield ('+ yieldVal + ' t/ha) suggests inefficiency. Please verify.',
                      conflictingQuestions: ['Q_M019', 'Q_A003']
                    }

                    ;
                  }

                  return {
                    valid: true
                  }

                  ;
                }
              }

              ];

              function checkAnswerConsistency() {
                var violations=[];

                CONSISTENCY_RULES.forEach(function(rule) {
                    try {
                      var result=rule.check(CPOSL.qState.signals);

                      if ( !result.valid) {
                        violations.push( {
                            ruleId: rule.id,
                            ruleName: rule.name,
                            severity: result.severity,
                            message: result.message,
                            conflictingQuestions: result.conflictingQuestions || []
                          }

                        );
                      }
                    }

                    catch (err) {
                      console.warn('[Consistency] Rule '+ rule.id + ' failed:', err);
                    }
                  }

                );

                return violations;
              }

              function showConsistencyWarning(violation) {
                var lang=CPOSL.language;
                var warningHtml='<div class="warning-box">'+ '<div style="display:flex;gap:10px;align-items:flex-start">'+ '<span style="font-size:24px">‚ö†Ô∏è</span>'+ '<div style="flex:1">'+ '<div style="font-weight:700;margin-bottom:6px;color:var(--warn)">'+ (lang==='HI'? '‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§ú‡§æ‡§Å‡§ö' : 'Quick Check') + '</div>'+ '<div style="font-size:13px;line-height:1.5;margin-bottom:10px">'+ escapeHtml(violation.message) + '</div>'+ '<div style="display:flex;gap:8px;flex-wrap:wrap">'+ '<button class="btn ghost" onclick="reviewConflict(\''+ violation.ruleId + '\')">'+ (lang==='HI'? '‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§ñ‡•á‡§Ç' : 'Review Previous Answers') + '</button>'+ '<button class="btn primary" onclick="continueAnyway()">'+ (lang==='HI'? '‡§´‡§ø‡§∞ ‡§≠‡•Ä ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç' : 'Continue Anyway') + '</button>'+ '</div></div></div></div>';

                document.getElementById('qNavStatus').innerHTML=warningHtml;
                CPOSL.qState.pendingWarning=violation;
              }

              function reviewConflict(ruleId) {
                var violation=CPOSL.qState.pendingWarning;

                if (violation && violation.conflictingQuestions && violation.conflictingQuestions.length > 0) {
                  alert('Conflicting answers from questions: '+ violation.conflictingQuestions.join(', '));
                }

                document.getElementById('qNavStatus').textContent='Review your answers, then click Next.';
                CPOSL.qState.pendingWarning=null;
              }

              function continueAnyway() {
                var violation=CPOSL.qState.pendingWarning;

                if (violation && violation.conflictingQuestions) {
                  violation.conflictingQuestions.forEach(function(qid) {
                      var ans=CPOSL.qState.answered[qid];

                      if (ans && ans.derivedSignals) {
                        Object.keys(ans.derivedSignals).forEach(function(sigKey) {
                            if (CPOSL.qState.signals[sigKey]) {
                              CPOSL.qState.signals[sigKey].confidence *=0.8;
                              CPOSL.qState.signals[sigKey].hasConflict=true;
                            }
                          }

                        );
                      }
                    }

                  );
                }

                document.getElementById('qNavStatus').textContent='';
                CPOSL.qState.pendingWarning=null;
                proceedToNextQuestion();
              }

              // PROBE SYSTEM - Follow-up clarification questions
          
              var PROBE_TEMPLATES= {
                'RESIDUE_USE_CONFLICT': {
                  text: 'You mentioned both removing and retaining residue. Can you estimate what % stays in field?',
                  text_hi: '‡§Ü‡§™‡§®‡•á ‡§Ö‡§µ‡§∂‡•á‡§∑ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡•á ‡§î‡§∞ ‡§∞‡§ñ‡§®‡•á ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§ï‡§ø‡§Ø‡§æ‡•§ ‡§ï‡§ø‡§§‡§®‡§æ % ‡§ñ‡•á‡§§ ‡§Æ‡•á‡§Ç ‡§∞‡§π‡§§‡§æ ‡§π‡•à?',
                  answerType: 'single_select',
                  options: ['0-25%', '25-50%', '50-75%', '75-100%'],
                  confidenceBoost: 0.3
                }

                ,
                'ZERO_TILL_CONFIRMATION': {
                  text: 'You said zero-till, but mentioned multiple passes. Do you use a direct seeding machine?',
                  text_hi: '‡§Ü‡§™‡§®‡•á ‡§ú‡•Ä‡§∞‡•ã-‡§ü‡§ø‡§≤ ‡§ï‡§π‡§æ, ‡§≤‡•á‡§ï‡§ø‡§® ‡§ï‡§à ‡§¨‡§æ‡§∞ ‡§ú‡•Å‡§§‡§æ‡§à ‡§ï‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§ï‡§ø‡§Ø‡§æ‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§∏‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§Æ‡§∂‡•Ä‡§® ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç?',
                  answerType: 'single_select',
                  options: ['True zero-till with direct seeding', 'Very light surface scratching only', 'Some shallow cultivation before planting'],
                  confidenceBoost: 0.4
                }

                ,
                'IRRIGATION_CLARIFY': {
                  text: 'You said rainfed, but mentioned irrigation events. Are those supplemental irrigations?',
                  text_hi: '‡§Ü‡§™‡§®‡•á ‡§µ‡§∞‡•ç‡§∑‡§æ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§ï‡§π‡§æ, ‡§≤‡•á‡§ï‡§ø‡§® ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§ï‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§ï‡§ø‡§Ø‡§æ‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡•á ‡§™‡•Ç‡§∞‡§ï ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§π‡•à‡§Ç?',
                  answerType: 'single_select',
                  options: ['Only rainwater - no irrigation', 'Life-saving irrigation 1-2 times', 'Regular supplemental irrigation'],
                  confidenceBoost: 0.35
                }

                ,
                'NITROGEN_RATE_VERIFY': {
                  text: 'The nitrogen rate seems quite high. How many bags of urea (50kg) per hectare?',
                  text_hi: '‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§® ‡§ï‡•Ä ‡§¶‡§∞ ‡§ï‡§æ‡§´‡•Ä ‡§Ö‡§ß‡§ø‡§ï ‡§≤‡§ó‡§§‡•Ä ‡§π‡•à‡•§ ‡§™‡•ç‡§∞‡§§‡§ø ‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ ‡§Ø‡•Ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§ï‡§ø‡§§‡§®‡•á ‡§¨‡•ã‡§∞‡•á?',
                  answerType: 'number',
                  options: null,
                  confidenceBoost: 0.35
                }

                ,
                'YIELD_UNIT_CHECK': {
                  text: 'The yield seems low. Are you reporting in tonnes/ha or quintals/ha?',
                  text_hi: '‡§â‡§™‡§ú ‡§ï‡§Æ ‡§≤‡§ó‡§§‡•Ä ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ü‡§®/‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ ‡§Ø‡§æ ‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤/‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ ‡§Æ‡•á‡§Ç ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç?',
                  answerType: 'single_select',
                  options: ['Tonnes per hectare (t/ha)', 'Quintals per hectare (q/ha)', 'Kilograms per hectare (kg/ha)'],
                  confidenceBoost: 0.4
                }
              }

              ;

              function detectProbeNeeds() {
                var probeNeeds=[];
                var signals=CPOSL.qState.signals;
                var answered=CPOSL.qState.answered;

                if (CPOSL.qState.probeCount >=4) return [];

                // Check for residue conflict
                if (answered['QC019'] && answered['QC017']) {
                  var removal=String(answered['QC019'].Answer_Raw || '');
                  var retention=String(answered['QC017'].Answer_Raw || '');

                  if ((removal.indexOf('YES') >=0 || removal.indexOf('ALL') >=0) && parseInt(retention) > 30) {
                    probeNeeds.push( {
                        signal: 'RESIDUE_USE_CONFLICT',
                        reason: 'Contradictory residue use',
                        priority: 95
                      }

                    );
                  }
                }

                // Check for zero-till conflict
                if (signals['TILLAGE_TYPE'] && signals['TILLAGE_TYPE'].value==='ZERO_TILL'&& answered['QM001']) {
                  var passes=parseInt(answered['QM001'].Answer_Raw || 0);

                  if (passes > 0) {
                    probeNeeds.push( {
                        signal: 'ZERO_TILL_CONFIRMATION',
                        reason: 'Zero-till but passes > 0',
                        priority: 90
                      }

                    );
                  }
                }

                // Check for high nitrogen
                if (answered['QM019']) {
                  var nRate=parseFloat(answered['QM019'].Answer_Raw || 0);

                  if (nRate > 200) {
                    probeNeeds.push( {
                        signal: 'NITROGEN_RATE_VERIFY',
                        reason: 'Unusually high N rate',
                        priority: 85
                      }

                    );
                  }
                }

                probeNeeds.sort(function(a, b) {
                    return b.priority - a.priority;
                  }

                );
                return probeNeeds;
              }

              function getProbeQuestion(probeNeed) {
                var template=PROBE_TEMPLATES[probeNeed.signal];
                if ( !template) return null;

                var lang=CPOSL.language;
                var questionText=(lang==='HI'&& template.text_hi) ? template.text_hi : template.text;

                return {
                  probeId: probeNeed.signal,
                  questionText: questionText,
                  answerType: template.answerType,
                  options: template.options,
                  confidenceBoost: template.confidenceBoost,
                  reason: probeNeed.reason
                }

                ;
              }

              function renderProbeQuestion() {
                var probe=CPOSL.qState.pendingProbe;
                if ( !probe) return;

                var lang=CPOSL.language;
                var elQ=document.getElementById('qQuestionText');
                var elH=document.getElementById('qHelpText');
                var elA=document.getElementById('qAnswerBox');

                elQ.innerHTML='<div class="probe-box">'+ '<div style="display:flex;align-items:center;gap:12px">'+ '<div style="font-size:28px">‚ùì</div>'+ '<div style="flex:1">'+ '<div style="background:#2196F3;color:white;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;display:inline-block;margin-bottom:6px">'+ (lang==='HI'? '‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§®' : 'QUICK VERIFICATION') + '</div>'+ '<div style="font-weight:600;color:#1976D2">'+ escapeHtml(probe.questionText) + '</div>'+ '</div></div></div>';

                elH.innerHTML='<div style="font-size:12px;color:#1976D2;padding:8px;background:white;border-radius:6px;border-left:4px solid #2196F3">'+ (lang==='HI'? '‡§ï‡§æ‡§∞‡§£' : 'Reason') + ': '+ escapeHtml(probe.reason) + '</div>';

                elA.innerHTML='';

                if (probe.answerType==='single_select'&& probe.options) {
                  probe.options.forEach(function(opt, idx) {
                      var div=document.createElement('div');
                      div.style.cssText='display:flex;align-items:center;gap:10px;margin-bottom:8px';
                      div.innerHTML='<input type="radio" name="probeAnswer" value="'+ escapeHtml(opt) + '" id="probe_'+ idx + '">'+ '<label for="probe_'+ idx + '" style="cursor:pointer">'+ escapeHtml(opt) + '</label>';
                      elA.appendChild(div);
                      div.querySelector('input').addEventListener('change', updateQuestionnaireUIState);
                    }

                  );
                }

                else if (probe.answerType==='number') {
                  var inp=document.createElement('input');
                  inp.type='number';
                  inp.id='probeNumInput';
                  inp.placeholder=lang==='HI'? '‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç' : 'Enter number';
                  inp.style.cssText='width:100%;padding:10px;border-radius:12px;border:2px solid #2196F3';
                  elA.appendChild(inp);
                  inp.addEventListener('input', updateQuestionnaireUIState);
                }
              }

              function processProbeAnswer(probeId, answer) {
                CPOSL.qState.answered['PROBE_'+ probeId]= {
                  Answer_Raw: answer,
                  IsProbe: true
                }

                ;
                CPOSL.qState.probeCount++;

                var probe=CPOSL.qState.pendingProbe;
                var boost=probe ? probe.confidenceBoost : 0.3;
                var relatedSignal=probeId.split('_')[0];

                Object.keys(CPOSL.qState.signals).forEach(function(sigKey) {
                    if (sigKey.indexOf(relatedSignal) >=0) {
                      var signal=CPOSL.qState.signals[sigKey];
                      signal.confidence=Math.min(1.0, (signal.confidence || 0.5) + boost);
                    }
                  }

                );

                CPOSL.qState.pendingProbe=null;
              }

              // CROP PARSER - Intelligent crop/season detection
              function parseCropAnswer(rawText) {
                if ( !rawText || typeof rawText !=='string') return null;

                var text=rawText.toLowerCase().trim();
                if ( !text) return null;

                var cropMap= {
                  'rice': 'RICE',
                  'paddy': 'RICE',
                  'dhan': 'RICE',
                  'wheat': 'WHEAT',
                  'gehu': 'WHEAT',
                  'gehun': 'WHEAT',
                  'maize': 'MAIZE',
                  'corn': 'MAIZE',
                  'makka': 'MAIZE',
                  'sugarcane': 'SUGARCANE',
                  'ganna': 'SUGARCANE',
                  'cotton': 'COTTON',
                  'kapas': 'COTTON',
                  'soybean': 'SOYBEAN',
                  'soya': 'SOYBEAN',
                  'chickpea': 'CHICKPEA',
                  'chana': 'CHICKPEA',
                  'mustard': 'MUSTARD',
                  'sarso': 'MUSTARD',
                  'potato': 'POTATO',
                  'aloo': 'POTATO',
                  'vegetables': 'VEGETABLES',
                  'sabzi': 'VEGETABLES'
                }

                ;

                var seasonKeywords= {
                  'kharif': 'KHARIF',
                  'rabi': 'RABI',
                  'summer': 'SUMMER',
                  'zaid': 'SUMMER',
                  'monsoon': 'KHARIF',
                  'winter': 'RABI'
                }

                ;

                var result= {

                  crops: [],
                  cropSeasons: {}

                  ,
                  signals: {}
                }

                ;
                var words=text.replace(/[, ; ]/g, ' ').split(/\s+/);

                words.forEach(function(word) {
                    Object.keys(cropMap).forEach(function(pattern) {
                        if (word===pattern || word===pattern + 's') {
                          var cropCode=cropMap[pattern];

                          if (result.crops.indexOf(cropCode) < 0) {
                            result.crops.push(cropCode);
                          }
                        }
                      }

                    );

                    Object.keys(seasonKeywords).forEach(function(kw) {
                        if (word===kw) {
                          // Associate with last detected crop
                          var lastCrop=result.crops[result.crops.length - 1];

                          if (lastCrop) {
                            if ( !result.cropSeasons[lastCrop]) result.cropSeasons[lastCrop]=[];
                            var season=seasonKeywords[kw];

                            if (result.cropSeasons[lastCrop].indexOf(season) < 0) {
                              result.cropSeasons[lastCrop].push(season);
                            }
                          }
                        }
                      }

                    );
                  }

                );

                // Generate signals
                if (result.crops.indexOf('RICE') >=0) {
                  result.signals['CROP_RICE_DETECTED']= {
                    value: 'YES',
                    confidence: 0.9
                  }

                  ;
                }

                if (result.crops.indexOf('WHEAT') >=0) {
                  result.signals['CROP_WHEAT_DETECTED']= {
                    value: 'YES',
                    confidence: 0.9
                  }

                  ;
                }

                if (result.crops.length >=3) {
                  result.signals['CROP_DIVERSITY']= {
                    value: 'HIGH',
                    confidence: 0.8
                  }

                  ;
                }

                else if (result.crops.length===2) {
                  result.signals['CROP_DIVERSITY']= {
                    value: 'MEDIUM',
                    confidence: 0.8
                  }

                  ;
                }

                else if (result.crops.length===1) {
                  result.signals['CROP_DIVERSITY']= {
                    value: 'LOW',
                    confidence: 0.8
                  }

                  ;
                }

                return result;
              }

              // ESTIMATION RULES - Convert qualitative to quantitative
              var ESTIMATION_RULES= {
                'TEXTUREPROXY_CLAYEY': {
                  factors: [ {
                    varName: 'clayfraction',
                    estimate: 30,
                    confidence: 0.6
                  }

                  ,
                    {
                    varName: 'sandfraction',
                    estimate: 25,
                    confidence: 0.5
                  }

                  ]
                }

                ,
                'TEXTUREPROXY_SANDY': {
                  factors: [ {
                    varName: 'sandfraction',
                    estimate: 70,
                    confidence: 0.65
                  }

                  ,
                    {
                    varName: 'clayfraction',
                    estimate: 10,
                    confidence: 0.55
                  }

                  ]
                }

                ,
                'DISTURBANCE_HIGH': {
                  factors: [ {
                    varName: 'tillageintensity',
                    estimate: 5,
                    confidence: 0.7
                  }

                  ]
                }

                ,
                'DISTURBANCE_LOW': {
                  factors: [ {
                    varName: 'tillageintensity',
                    estimate: 0,
                    confidence: 0.8
                  }

                  ]
                }

                ,
                'RESIDUERETENTION_HIGH': {
                  factors: [ {
                    varName: 'residuequantity',
                    estimate: 4.5,
                    confidence: 0.7
                  }

                  ]
                }

                ,
                'RESIDUERETENTION_LOW': {
                  factors: [ {
                    varName: 'residuequantity',
                    estimate: 1.0,
                    confidence: 0.6
                  }

                  ]
                }
              }

              ;

              function applyEstimationMappings() {
                var estimated=[];
                var signals=CPOSL.qState.signals;

                Object.keys(signals).forEach(function(signalKey) {
                    var sigValue=signals[signalKey].value;
                    var ruleKey=signalKey + '_'+ sigValue;
                    var rule=ESTIMATION_RULES[ruleKey];

                    if ( !rule) return;

                    rule.factors.forEach(function(est) {
                        var varKey=normKey(est.varName);
                        var varData=CPOSL.idx.boundsByVar.get(varKey);
                        if ( !varData || varData.length===0) return;

                        // Only estimate if not already set
                        if ( !CPOSL.selections[est.varName]) {
                          // Find matching class for estimated value
                          var matchedClass=null;

                          varData.forEach(function(row) {
                              var lower=toNum(getField(row, ['Lower_Bound', 'LowerBound']));
                              var upper=toNum(getField(row, ['Upper_Bound', 'UpperBound']));

                              if ((lower===null || est.estimate >=lower) && (upper===null || est.estimate <=upper)) {
                                matchedClass=getField(row, ['Class_Label', 'ClassLabel']);
                              }
                            }

                          );

                          if (matchedClass) {
                            CPOSL.selections[est.varName]=matchedClass;

                            estimated.push( {
                                variable: est.varName,
                                estimatedValue: est.estimate,
                                classLabel: matchedClass,
                                confidence: est.confidence,
                                fromSignal: signalKey
                              }

                            );
                          }
                        }
                      }

                    );
                  }

                );

                return estimated;
              }

              /**
             * Normalize signal names to match mapping expectations
             * Maps actual derivation signal names ‚Üí expected mapping signal names
             */
              function normalizeSignalKeys() {
                console.log('[Normalize] Before normalization:', Object.keys(CPOSL.qState.signals));

                var aliases= {
                  // Texture signals
                  'SOIL_TEXTURE': 'TEXTURE_PROXY',
                  'TEXTURE': 'TEXTURE_PROXY',

                  // Drainage signals
                  'SOIL_DRAINAGE': 'DRAINAGE_PROXY',
                  'DRAINAGE': 'DRAINAGE_PROXY',

                  // Tillage/Disturbance signals
                  'TILLAGE_INTENSITY': 'DISTURBANCE',
                  'SOIL_DISTURBANCE': 'DISTURBANCE',
                  'TILLAGE_TYPE': 'TILLAGE',

                  // Residue signals
                  'RESIDUE_AMOUNT': 'RESIDUE_RETENTION',
                  'RESIDUE_PERCENT': 'RESIDUE_RETENTION',

                  // Organic amendment signals
                  'ORGANIC_INPUT': 'ORG_AMENDMENT',
                  'ORGANIC_AMENDMENT': 'ORG_AMENDMENT',
                  'FYM_FREQUENCY': 'ORG_AMENDMENT_INTENSITY',

                  // Crop signals
                  'CROP_TYPE': 'MAIN_CROP',
                  'PRIMARY_CROP': 'MAIN_CROP',

                  // Water/Irrigation signals
                  'IRRIGATION_TYPE': 'IRRIGATION',
                  'WATER_SOURCE': 'IRRIGATION',
                  'FLOODING_PATTERN': 'AWD_READINESS',
                  'IRRIGATION_CONTROL': 'IRR_CONTROL',

                  // Soil chemistry
                  'PH_LEVEL': 'SOIL_PH',
                  'SOIL_PH_VALUE': 'SOIL_PH',

                  // Physical properties
                  'SOIL_COMPACTION': 'COMPACTION_RISK',
                  'FIELD_SLOPE_PCT': 'SLOPE',
                  'TILLAGE_COUNT': 'TILLAGE_PASSES',

                  // Management
                  'COVER_CROPPING': 'COVER_CROP',
                  'GREEN_MANURE': 'COVER_CROP',
                  'NUTRIENT_MANAGEMENT': 'INTEGRATED_NUTRIENT',
                  'RESIDUE_BURNING_PRACTICE': 'RESIDUE_BURNING',
                  'RESIDUE_INCORPORATION': 'RESIDUE_INCORPORATED',
                  'FALLOW_DURATION': 'LIVING_ROOT_MONTHS'
                }

                ;

                var aliased=0;

                Object.keys(aliases).forEach(function(actualKey) {
                    if (CPOSL.qState.signals[actualKey]) {
                      var aliasKey=aliases[actualKey];

                      if ( !CPOSL.qState.signals[aliasKey]) {
                        CPOSL.qState.signals[aliasKey]=CPOSL.qState.signals[actualKey];
                        console.log('[Normalize] ‚úì Aliased:', actualKey, '‚Üí', aliasKey, '=', CPOSL.qState.signals[actualKey].value);
                        aliased++;
                      }
                    }
                  }

                );

                console.log('[Normalize] After normalization:', Object.keys(CPOSL.qState.signals));
                console.log('[Normalize] Created', aliased, 'aliases');
              }



              // SIGNAL TO LITE FACTOR MAPPING
              function applySignalMappings() {
                var mappings=CPOSL.q.signalToLiteMap || [];
                var mapped=[];

                console.log('[Mapping] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('[Mapping] Starting with', mappings.length, 'mapping rules');
                console.log('[Mapping] Current signals:', Object.keys(CPOSL.qState.signals));
                console.log('[Mapping] Current factors:', Object.keys(CPOSL.selections).length);

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // NORMALIZE EXISTING SELECTIONS (convert strings to objects)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                Object.keys(CPOSL.selections).forEach(function(key) {
                    var val=CPOSL.selections[key];

                    if (typeof val==='string') {
                      CPOSL.selections[key]= {
                        value: val,
                        auto: false,
                        source: 'legacy',
                        confidence: 0.5
                      }

                      ;
                      console.log('[Mapping] ‚öôÔ∏è Normalized legacy string:', key, '=', val);
                    }
                  }

                );

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // APPLY SIGNAL MAPPINGS
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                mappings.forEach(function(m) {

                    // Check if mapping is active
                    if ( !toBool(getField(m, ['Is_Active', 'IsActive'], true))) {
                      return;
                    }

                    // Extract field values with fallbacks
                    var sigKey=m.SignalKey || m.Signal_Key;
                    var varName=m.LiteVariableName || m.Lite_Variable_Name || m.Variable_Name;
                    var whenValue=m.Signal_Value || m.When_Signal_Value || m.WhenValue;
                    var thenClass=m.Lite_Class_Label || m.Then_Lite_Class || m.ThenClass;
                    var conf=toNum(m.Confidence_0_1 || m.Confidence) || 0.8;

                    // Validate required fields
                    if ( !sigKey || !varName) {
                      return;
                    }

                    // Check if we have this signal
                    var signal=CPOSL.qState.signals[sigKey];

                    if ( !signal) {
                      return;
                    }

                    // Extract signal value (handle both object and primitive formats)
                    var sigValue=signal.value !==undefined ? signal.value : signal;

                    // Check if signal value matches the mapping condition
                    if (whenValue && sigValue !==whenValue) {
                      return;
                    }

                    // üî¥ FIX: Use CPOSL.idx not CPOSL.wIdx
                    var varKey=normKey(varName);
                    var varBounds=CPOSL.idx.boundsByVar.get(varKey);

                    if ( !varBounds || varBounds.length===0) {
                      console.warn('[Mapping] ‚ö†Ô∏è Variable not found in bounds:', varName, '(key:', varKey + ')');
                      return;
                    }

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // DECIDE WHETHER TO APPLY THIS MAPPING
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    var existing=CPOSL.selections[varName];
                    var shouldApply=false;
                    var reason='';

                    if ( !existing) {
                      // No existing value - apply mapping
                      shouldApply=true;
                      reason='new factor';

                    }

                    else if (typeof existing==='string') {
                      // Legacy string format - convert and apply
                      shouldApply=true;
                      reason='replacing legacy string';

                    }

                    else if ( !existing.auto) {
                      // Existing value is manual - don't override
                      shouldApply=false;
                      reason='manual entry exists';

                    }

                    else if (existing.auto && (existing.confidence || 0) < conf) {
                      // Existing is auto but lower confidence - upgrade
                      shouldApply=true;
                      reason='higher confidence ('+ conf + ' > '+ (existing.confidence || 0) + ')';

                    }

                    else {
                      // Existing is auto with equal/higher confidence - keep existing
                      shouldApply=false;
                      reason='existing has equal/higher confidence';
                    }

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // APPLY MAPPING IF DECIDED
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    if (shouldApply) {
                      CPOSL.selections[varName]= {
                        value: thenClass,
                        auto: true,
                        source: sigKey,
                        confidence: conf,
                        mappedFrom: sigKey + '='+ sigValue,
                        timestamp: new Date().toISOString()
                      }

                      ;

                      mapped.push( {
                          signal: sigKey,
                          signalValue: sigValue,
                          variable: varName,
                          classLabel: thenClass,
                          confidence: conf,
                          reason: reason
                        }

                      );

                      console.log('[Mapping] ‚úÖ', sigKey, '=', sigValue, '‚Üí', varName, '=', thenClass,
                        '(conf:', conf, '|', reason + ')');
                    }

                    else {
                      console.log('[Mapping] ‚è≠Ô∏è  Skipped:', varName, '(', reason + ')');
                    }
                  }

                );

                console.log('[Mapping] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('[Mapping] ‚úì Complete. Mapped', mapped.length, 'factors');
                console.log('[Mapping] Total factors now:', Object.keys(CPOSL.selections).length);
                console.log('[Mapping] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                return mapped;
              }

              // BACKEND API CALLS
              function gsRun(fnName) {
                var args=Array.prototype.slice.call(arguments, 1);

                return new Promise(function(resolve, reject) {
                    if (typeof google==='undefined'|| !google.script || !google.script.run) {
                      reject(new Error('Apps Script runtime not available'));
                      return;
                    }

                    var runner=google.script.run .withSuccessHandler(resolve) .withFailureHandler(reject);

                    if (typeof runner[fnName] !=='function') {
                      reject(new Error('Function not found: '+ fnName));
                      return;
                    }

                    runner[fnName].apply(runner, args);
                  }

                );
              }

              function getCPOSLiteTables() {
                return gsRun('getCPOSLiteTables');
              }

              function getCPOSQuestionnaireConfig() {
                return gsRun('getCPOSQuestionnaireConfig');
              }

              // INDEX BUILDERS
              function buildLiteIndexes() {
                var bounds=CPOSL.data.bounds || [];
                var desir=CPOSL.data.desirability || [];
                var wts=CPOSL.data.weights || [];

                var boundsByVar=new Map();

                bounds.forEach(function(r) {
                    var varName=getField(r, ['Variable_Name', 'VariableName', 'variable_name']);
                    if ( !varName) return;
                    var key=normKey(varName);
                    if ( !boundsByVar.has(key)) boundsByVar.set(key, []);
                    boundsByVar.get(key).push(r);
                  }

                );

                boundsByVar.forEach(function(list) {
                    list.sort(function(a, b) {
                        return (toNum(a.Class_Order) || 0) - (toNum(b.Class_Order) || 0);
                      }

                    );
                  }

                );

                var desirIdx=new Map();

                desir.forEach(function(r) {
                    var varName=getField(r, ['Variable_Name', 'VariableName']);
                    var cls=getField(r, ['Class_Label', 'ClassLabel']);
                    var pw=getField(r, ['Pathway', 'pathway']);
                    var d=toNum(getField(r, ['Desirability_0_1', 'Desirability']));
                    if ( !varName || !cls || !pw || d===null) return;
                    desirIdx.set(normKey(varName) + '|'+ normKey(cls) + '|'+ normKey(pw), Math.max(0, Math.min(1, d)));
                  }

                );

                var wIdx=new Map();

                wts.forEach(function(r) {
                    var varName=getField(r, ['Variable_Name', 'VariableName']);
                    var pw=getField(r, ['Pathway', 'pathway']);
                    var w=toNum(getField(r, ['Sensitivity_Weight_0_10', 'weight']));
                    if ( !varName || !pw || w===null) return;
                    wIdx.set(normKey(varName) + '|'+ normKey(pw), Math.max(0, Math.min(10, w)));
                  }

                );

                CPOSL.idx.boundsByVar=boundsByVar;
                CPOSL.idx.desirIdx=desirIdx;
                CPOSL.idx.wIdx=wIdx;

                console.log('[CPOS] Lite indexes built:', {
                    boundsVars: boundsByVar.size,
                    desirKeys: desirIdx.size,
                    weightKeys: wIdx.size
                  }

                );
              }

              function buildQuestionnaireIndexes() {
                var idx=CPOSL.q.idx;
                idx.qBankById=new Map();
                idx.qOptionsByQ=new Map();
                idx.qDerivByWhenQ=new Map();
                idx.qRoutesByCurrentQ=new Map();
                idx.qSignalMapByKey=new Map();
                idx.startQuestions=[];

                var bank=CPOSL.q.bank || [];
                var options=CPOSL.q.options || [];
                var deriv=CPOSL.q.derivationRules || [];
                var routes=CPOSL.q.routingRules || [];
                var signalMap=CPOSL.q.signalToLiteMap || [];

                bank.forEach(function(r) {
                    var qid=getField(r, ['Question_ID', 'QuestionID', 'question_id']);
                    if ( !qid) return;
                    var active=toBool(getField(r, ['Is_Active', 'IsActive', 'is_active'], true));
                    if ( !active) return;

                    r.Question_ID=qid;
                    r.Is_Active=active;
                    r.Sequence=toNum(getField(r, ['Sequence', 'sequence'])) || 999;
                    r.Is_Required=toBool(getField(r, ['Is_Required', 'IsRequired'], false));

                    idx.qBankById.set(qid, r);
                  }

                );

                var sorted=Array.from(idx.qBankById.values()).sort(function(a, b) {
                    return a.Sequence - b.Sequence;
                  }

                );

                if (sorted.length > 0) {
                  idx.startQuestions=[sorted[0].Question_ID];
                }

                options.forEach(function(o) {
                    var qid=getField(o, ['Question_ID', 'QuestionID']);
                    if ( !qid) return;
                    if ( !idx.qOptionsByQ.has(qid)) idx.qOptionsByQ.set(qid, []);
                    idx.qOptionsByQ.get(qid).push(o);
                  }

                );

                deriv.forEach(function(d) {
                    var whenQ=getField(d, ['When_Question_ID', 'WhenQuestionID']);
                    if ( !whenQ) return;
                    if ( !idx.qDerivByWhenQ.has(whenQ)) idx.qDerivByWhenQ.set(whenQ, []);
                    idx.qDerivByWhenQ.get(whenQ).push(d);
                  }

                );

                routes.forEach(function(r) {
                    var fromQ=getField(r, ['From_Question_ID', 'FromQuestionID', 'Current_Question_ID']);
                    if ( !fromQ) return;
                    if ( !idx.qRoutesByCurrentQ.has(fromQ)) idx.qRoutesByCurrentQ.set(fromQ, []);
                    idx.qRoutesByCurrentQ.get(fromQ).push(r);
                  }

                );

                signalMap.forEach(function(sm) {
                    var sig=getField(sm, ['Signal_Key', 'SignalKey']);
                    if ( !sig) return;
                    if ( !idx.qSignalMapByKey.has(sig)) idx.qSignalMapByKey.set(sig, []);
                    idx.qSignalMapByKey.get(sig).push(sm);
                  }

                );

                CPOSL.q.available=idx.qBankById.size > 0 && idx.startQuestions.length > 0;

                console.log('[CPOS][Q] Questionnaire indexes built:', {
                    bank: idx.qBankById.size,
                    options: idx.qOptionsByQ.size,
                    deriv: idx.qDerivByWhenQ.size,
                    routes: idx.qRoutesByCurrentQ.size,
                    signalMap: idx.qSignalMapByKey.size,
                    starts: idx.startQuestions,
                    available: CPOSL.q.available
                  }

                );
              }

              // UI BUILDERS
              function buildFactorForm() {
                var container=document.getElementById('factorForm');
                if ( !container) return;
                container.innerHTML='';

                var boundsByVar=CPOSL.idx.boundsByVar;

                if ( !boundsByVar || boundsByVar.size===0) {
                  container.innerHTML='<div class="small" style="color:#991b1b">No factors loaded.</div>';
                  return;
                }

                boundsByVar.forEach(function(rows, varKey) {
                    var firstRow=rows[0] || {}

                    ;
                    var varName=getField(firstRow, ['Variable_Name', 'VariableName']) || varKey;
                    var displayName=getField(firstRow, ['Factor_Display_Name', 'FactorDisplayName']) || varName;
                    var unit=getField(firstRow, ['Unit', 'unit']) || '';
                    var cat=getField(firstRow, ['Factor_Category', 'FactorCategory']) || '';

                    var field=document.createElement('div');
                    field.className='field';

                    var optionsHtml='<option value="">‚Äî Select ‚Äî</option>';

                    rows.forEach(function(r) {
                        var cls=getField(r, ['Class_Label', 'ClassLabel']);
                        optionsHtml +='<option value="'+ escapeHtml(cls) + '">'+ escapeHtml(cls) + '</option>';
                      }

                    );


                    var isAutoFilled=CPOSL.selections[varName] && CPOSL.qState.signals && Object.keys(CPOSL.qState.signals).length > 0;

                    var lockIcon=isAutoFilled ? ' üîí' : '';
                    var lockStyle=isAutoFilled ? 'background:#e8f5e9;border:2px solid #4caf50;cursor:not-allowed;' : '';
                    var disabledAttr=isAutoFilled ? 'disabled title="Auto-filled from questionnaire - locked for data integrity"' : '';
                    var lockBadge=isAutoFilled ? '<span style="display:inline-block;padding:2px 8px;background:#4caf50;color:white;border-radius:12px;font-size:10px;font-weight:700;margin-left:8px;">AUTO-FILLED</span>' : '';

                    field.innerHTML='<label>'+ '<span>'+ escapeHtml(displayName) + lockIcon + lockBadge + '</span>'+ '<span class="cat">'+ escapeHtml(unit || cat) + '</span>'+ '</label>'+ '<select id="sel_'+ escapeHtml(varKey) + '" data-var="'+ escapeHtml(varName) + '" '+ disabledAttr + ' style="'+ lockStyle + '">'+ optionsHtml + '</select>';

                    container.appendChild(field);

                    var sel=field.querySelector('select');

                    if (sel && CPOSL.selections[varName]) {
                      // ‚úÖ FIX: Extract value from object or use string directly
                      var selection=CPOSL.selections[varName];
                      var selectedValue='';

                      if (typeof selection==='object'&& selection.value !==undefined) {
                        selectedValue=selection.value;
                      }

                      else if (typeof selection==='string') {
                        selectedValue=selection;
                      }

                      if (selectedValue) {
                        sel.value=selectedValue;
                      }
                    }


                    if (sel && !isAutoFilled) {
                      sel.addEventListener('change', function() {
                          onSelectionChange(varName, sel.value);
                        }

                      );
                    }
                  }

                );

                updateEvalGate();
              }

              function onSelectionChange(varName, classLabel) {
                if (classLabel) {
                  CPOSL.selections[varName]=classLabel;
                }

                else {
                  delete CPOSL.selections[varName];
                }

                updateEvalGate();
                updateExplainBox();
              }

              function updateEvalGate() {
                var btn=document.getElementById('btnEvaluate');
                var hint=document.getElementById('evalGateHint');
                var count=Object.keys(CPOSL.selections).length;

                if (btn) btn.disabled=count===0;
                if (hint) hint.textContent=count > 0 ? count + ' factor(s) selected' : '';
              }

              function updateExplainBox() {
                var box=document.getElementById('notesBox');
                if ( !box) return;

                var sels=CPOSL.selections;
                var keys=Object.keys(sels);

                if (keys.length===0) {
                  box.textContent='Enter values to view class, desirability, and pathway context here.';
                  return;
                }

                var text='';
                var autoCount=0;
                var manualCount=0;

                keys.forEach(function(varName) {
                    var selection=sels[varName];

                    var displayValue='';
                    var isAuto=false;
                    var source='';

                    if (typeof selection==='object'&& selection.value !==undefined) {
                      displayValue=selection.value;
                      isAuto=selection.auto===true;
                      source=selection.source || '';
                      if (isAuto) autoCount++;
                      else manualCount++;
                    }

                    else if (typeof selection==='string') {
                      displayValue=selection;
                      manualCount++;
                    }

                    if (displayValue) {
                      var badge=isAuto ? ' [AUTO]' : ' [MANUAL]';
                      var fromText=source ? ' (from '+ source + ')' : '';
                      text +=varName + ': '+ displayValue + badge + fromText + '\n';
                    }
                  }

                );

                // Calculate completeness
                var totalFactors=36; // Total possible factors
                var percentComplete=Math.round((keys.length / totalFactors) * 100);

                // Add summary header with progress bar
                var summary='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                summary +='üìä FACTOR SUMMARY\n';
                summary +='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                summary +='Total factors: '+ keys.length + ' / '+ totalFactors + ' ('+ percentComplete + '% complete)\n';
                summary +='Auto-filled: '+ autoCount + ' | Manual: '+ manualCount + '\n';

                // Quality indicator
                if (percentComplete < 30) {
                  summary +='‚ö†Ô∏è Low data coverage - add more factors\n';
                }

                else if (percentComplete < 60) {
                  summary +='‚úì Moderate data coverage - good progress\n';
                }

                else {
                  summary +='‚úÖ High data coverage - excellent!\n';
                }

                summary +='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';

                box.textContent=summary + text;
              }

              function clearSelections() {
                CPOSL.selections= {}

                ;

                document.querySelectorAll('#factorForm select').forEach(function(sel) {
                    sel.value='';
                  }

                );
                updateEvalGate();
                updateExplainBox();
              }

              // QUESTIONNAIRE UI
              function updateQuestionnaireUIState() {
                var state=CPOSL.qState;
                var idx=CPOSL.q.idx;

                var hasBank=idx.qBankById && idx.qBankById.size > 0;
                var hasStart=idx.startQuestions && idx.startQuestions.length > 0;
                var qReady=hasBank && hasStart;
                var inProgress= ! !state.current;
                var isProbe=state.current && String(state.current).indexOf('PROBE_')===0;

                var btnStart=document.getElementById('btnQStart');
                var btnBack=document.getElementById('btnQBack');
                var btnSkip=document.getElementById('btnQSkip');
                var btnNext=document.getElementById('btnQNext');
                var btnFinish=document.getElementById('btnQFinish');
                var btnSave=document.getElementById('btnQSave');
                var finishRow=document.getElementById('finishButtonRow');

                // START BUTTON - ONLY VISIBLE BEFORE QUESTIONNAIRE STARTS
                if (btnStart) {

                  // Check if questionnaire has truly started (robust check for empty strings)
                  var hasAnswered=Object.keys(state.answered || {}

                  ).length > 0;
                  var hasValidSession=state.sessionId && String(state.sessionId).trim().length > 0;
                  var isInActiveRound=CPOSL.rounds && CPOSL.rounds.current > 0;

                  var hasStarted=inProgress || hasAnswered || hasValidSession || isInActiveRound;

                  btnStart.disabled= !qReady || hasStarted;
                  btnStart.style.display=hasStarted ? 'none' : 'block';

                  // Also hide the center container (parent div)
                  if (btnStart.parentElement) {
                    btnStart.parentElement.style.display=hasStarted ? 'none' : 'flex';
                  }
                }

                // NAVIGATION BUTTONS

                // Back button - left side
                if (btnBack) {
                  var canGoBack=inProgress && state.history.length > 0;

                  btnBack.disabled= !canGoBack;
                  btnBack.style.display=inProgress ? 'inline-block' : 'none';
                  btnBack.style.visibility='visible'; // Ensure visible when displayed
                }

                // Skip button - left side
                if (btnSkip) {
                  var canSkip=inProgress && !isProbe;

                  btnSkip.disabled= !canSkip;
                  btnSkip.style.display=inProgress ? 'inline-block' : 'none';
                  btnSkip.style.visibility='visible'; // Ensure visible when displayed
                }

                // Next button - right side, PRIMARY ACTION
                var hasAnswer=inProgress && validateAnswer(readAnswerFromUI());

                if (btnNext) {
                  btnNext.disabled= !hasAnswer;
                  btnNext.style.display=inProgress ? 'inline-block' : 'none';
                }

                // FINISH BUTTON - Controlled by toggleFinishButton()
                // (Don't automatically show/hide here - managed by round transitions)

                // SAVE PROGRESS BUTTON
                var answeredCount=Object.keys(state.answered).length;

                if (btnSave) {
                  btnSave.disabled=answeredCount < 3;
                  btnSave.style.display=inProgress ? 'inline-block' : 'none';
                }

                updateButtonLabels();
              }

              /**
             * FORMAT OPTION LABEL - HYBRID APPROACH
             * 1. Database labels (primary source)
             * 2. Critical hardcoded labels (reliable fallback)
             * 3. Pattern matching (last resort)
             */
              function formatOptionLabel(code, lang) {
                if ( !code) return '';

                // CRITICAL HARDCODED LABELS (Most common/important only)
                // These ensure the system works even if database fails
                var criticalLabels= {
                  // YES/NO (most common)
                  'YES': 'Yes',
                  'NO': 'No',
                  'SOILTEST_YES': 'Yes',
                  'SOILTEST_NO': 'No',

                  // Colors (frequently used)
                  'COLOR_BLACK': 'Black',
                  'COLOR_BROWN': 'Brown',
                  'COLOR_GREY': 'Grey',
                  'COLOR_RED': 'Red',
                  'COLOR_LIGHT': 'Light',

                  // Soil types (core question)
                  'SOIL_SANDY': 'Sandy soil',
                  'SOIL_LOAMY': 'Loamy soil',
                  'SOIL_CLAYEY': 'Clayey soil',

                  // Weather (common)
                  'Wx Hot Humid': 'Hot and Humid',
                  'Wx Hot Dry': 'Hot and Dry',
                  'Wx Moderate': 'Moderate',
                  'Wx Cool': 'Cool',

                  // Duration (standardized)
                  'Dur Lt1': 'Less than 1 year',
                  'Dur 1 2': '1-2 years',
                  'Dur 3 5': '3-5 years',
                  'Dur 5 10': '5-10 years',
                  'Dur 10p': 'More than 10 years',

                  // Residue (critical pathway question)
                  'Res Burn All': 'Burn all residue',
                  'Res Burn Most': 'Burn most',
                  'Res Burn Some': 'Burn some',
                  'Res Burn None': 'Do not burn',

                  // Flooding (AWD pathway)
                  'Flood Cont': 'Continuous flooding',
                  'Flood Int': 'Intermittent flooding',
                  'Flood Moist': 'Keep moist',
                  'Flood Aerobic': 'Aerobic (no flooding)'
                }

                ;

                // Check critical labels first
                if (criticalLabels[code]) {
                  return criticalLabels[code];
                }

                // PATTERN-BASED FALLBACK (for non-critical codes)
                var formatted=code .replace(/^(COLOR|SOIL|CROP|TILLAGE|DRAIN|PUDDLE|FLOOD|IRR|ORG|RES|WX|DUR|FREQ|QTY)_/i, '') .replace(/_/g, ' ') .toLowerCase() .replace(/\b\w/g, function(c) {
                    return c.toUpperCase();
                  }

                ) .replace(/\bLt\s*(\d)/gi, 'Less than $1') .replace(/(\d+)\s*[Pp]\b/g, '$1+') .replace(/\bCont\b/gi, 'Continuous') .replace(/\bInt\b/gi, 'Intermittent') .trim();

                return formatted;
              }

              function renderQuestionUI() {
                var qid=CPOSL.qState.current;
                var elQ=document.getElementById('qQuestionText');
                var elH=document.getElementById('qHelpText');
                var elA=document.getElementById('qAnswerBox');

                if ( !elQ || !elH || !elA) return;

                // Handle probe questions
                if (qid && String(qid).indexOf('PROBE_')===0) {
                  if (typeof renderProbeQuestion==='function') {
                    renderProbeQuestion();
                  }

                  return;
                }

                if ( !qid) {
                  elQ.textContent='No current question.';
                  elH.textContent='';
                  elA.innerHTML='';
                  return;
                }

                var qRow=CPOSL.q.idx.qBankById.get(qid);

                if ( !qRow) {
                  elQ.textContent='Question '+ qid + ' not found.';
                  elH.textContent='';
                  elA.innerHTML='';
                  return;
                }

                var lang=CPOSL.language;
                var questionText=(lang==='HI'&& qRow.Question_Text_HI) ? qRow.Question_Text_HI : (getField(qRow, ['Question_Text_EN', 'Question_Text', 'QuestionText']) || qid);
                var helpText=(lang==='HI'&& qRow.Help_Text_HI) ? qRow.Help_Text_HI : (getField(qRow, ['Help_Text_EN', 'Help_Text', 'HelpText']) || '');

                elQ.textContent=questionText;
                elH.textContent=helpText;
                elA.innerHTML='';

                var prevAnswer=CPOSL.qState.answered[qid];
                var prevRaw=prevAnswer ? prevAnswer.Answer_Raw : '';

                // üî¥ READ Answer_Type FROM SHEET - RESPECT IT!
                var qType=String(getField(qRow, ['Answer_Type', 'AnswerType']) || '').toLowerCase().trim();
                var opts=CPOSL.q.idx.qOptionsByQ.get(qid) || [];

                console.log('[Q]', qid, '‚Üí Type:', qType, '| Options:', opts.length);

                // SINGLE SELECT (RADIO BUTTONS) ‚óã
                if (qType==='single_select'&& opts.length > 0) {
                  // Create container with responsive grid
                  var gridContainer=document.createElement('div');
                  gridContainer.style.cssText='display: grid; '+ 'grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); '+ 'gap: 10px; '+ 'margin-bottom: 10px;';

                  opts.forEach(function(opt) {
                      var code=getField(opt, ['Option_Code', 'OptionCode'], '');

                      // Extract labels using correct key names
                      var labelEN=getField(opt, ['OptionLabelEN', 'Option_Label_EN', 'OptionLabel_EN', 'Label_EN'], '');
                      var labelHI=getField(opt, ['OptionLabelHI', 'Option_Label_HI', 'OptionLabel_HI', 'Label_HI'], '');

                      // Choose label based on language preference
                      var label='';

                      if (lang==='HI'&& labelHI) {
                        label=labelHI;
                      }

                      else if (labelEN) {
                        label=labelEN;
                      }

                      else if (typeof formatOptionLabel==='function') {
                        label=formatOptionLabel(code, lang);
                      }

                      else {
                        label=code;
                      }

                      var checked=prevRaw===code ? 'checked' : '';

                      var div=document.createElement('div');
                      div.style.cssText='display: flex; '+ 'align-items: center; '+ 'gap: 12px; '+ 'padding: 10px 14px; '+ 'background: rgba(255,255,255,0.6); '+ 'border-radius: 10px; '+ 'border: 1px solid rgba(31,41,55,0.08); '+ 'transition: all 0.2s ease; '+ 'cursor: pointer; '+ 'min-height: 44px;'; // Ensure touch-friendly height

                      div.innerHTML='<input type="radio" name="q_'+ escapeHtml(qid) + '" value="'+ escapeHtml(code) + '" '+ 'id="q_'+ qid + '_'+ code + '" '+ checked + ' '+ 'style="margin:0;width:20px;height:20px;cursor:pointer;flex-shrink:0;accent-color:#2f6fb5;">'+ '<label for="q_'+ qid + '_'+ code + '" '+ 'style="cursor:pointer;margin:0;flex:1;font-size:14px;line-height:1.5;color:#1f2937;font-weight:500;word-wrap:break-word;overflow-wrap:break-word;">'+ escapeHtml(label) + '</label>';

                      gridContainer.appendChild(div);

                      var radio=div.querySelector('input');

                      radio.addEventListener('change', function() {
                          updateQuestionnaireUIState();

                          gridContainer.querySelectorAll('div').forEach(function(d) {
                              d.style.background='rgba(255,255,255,0.6)';
                              d.style.borderColor='rgba(31,41,55,0.08)';
                              d.style.boxShadow='none';
                            }

                          );

                          if (radio.checked) {
                            div.style.background='linear-gradient(135deg, rgba(47,111,181,0.12), rgba(143,191,120,0.08))';
                            div.style.borderColor='rgba(47,111,181,0.3)';
                            div.style.boxShadow='0 2px 8px rgba(47,111,181,0.15)';
                          }
                        }

                      );

                      div.addEventListener('mouseenter', function() {
                          if ( !radio.checked) {
                            div.style.background='rgba(47,111,181,0.06)';
                            div.style.borderColor='rgba(47,111,181,0.15)';
                          }
                        }

                      );

                      div.addEventListener('mouseleave', function() {
                          if ( !radio.checked) {
                            div.style.background='rgba(255,255,255,0.6)';
                            div.style.borderColor='rgba(31,41,55,0.08)';
                          }
                        }

                      );

                      div.addEventListener('click', function(e) {
                          if (e.target.tagName !=='INPUT') {
                            radio.checked=true;
                            radio.dispatchEvent(new Event('change'));
                          }
                        }

                      );

                      if (checked) {
                        div.style.background='linear-gradient(135deg, rgba(47,111,181,0.12), rgba(143,191,120,0.08))';
                        div.style.borderColor='rgba(47,111,181,0.3)';
                        div.style.boxShadow='0 2px 8px rgba(47,111,181,0.15)';
                      }
                    }

                  );

                  elA.appendChild(gridContainer);
                }

                // MULTI SELECT (CHECKBOXES) ‚òë
                else if (qType==='multi_select'&& opts.length > 0) {
                  var prevCodes=String(prevRaw || '').split(',').map(function(x) {
                      return x.trim();
                    }

                  );

                  // Create container with responsive grid
                  var gridContainer=document.createElement('div');
                  gridContainer.style.cssText='display: grid; '+ 'grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); '+ 'gap: 10px; '+ 'margin-bottom: 10px;';

                  opts.forEach(function(opt) {
                      var code=getField(opt, ['Option_Code', 'OptionCode'], '');

                      // Extract labels using correct key names
                      var labelEN=getField(opt, ['OptionLabelEN', 'Option_Label_EN', 'OptionLabel_EN', 'Label_EN'], '');
                      var labelHI=getField(opt, ['OptionLabelHI', 'Option_Label_HI', 'OptionLabel_HI', 'Label_HI'], '');

                      // Choose label based on language preference
                      var label='';

                      if (lang==='HI'&& labelHI) {
                        label=labelHI;
                      }

                      else if (labelEN) {
                        label=labelEN;
                      }

                      else if (typeof formatOptionLabel==='function') {
                        label=formatOptionLabel(code, lang);
                      }

                      else {
                        label=code;
                      }

                      var checked=prevCodes.indexOf(code) >=0 ? 'checked' : '';

                      var div=document.createElement('div');
                      div.style.cssText='display: flex; '+ 'align-items: center; '+ 'gap: 12px; '+ 'padding: 10px 14px; '+ 'background: rgba(255,255,255,0.6); '+ 'border-radius: 10px; '+ 'border: 1px solid rgba(31,41,55,0.08); '+ 'transition: all 0.2s ease; '+ 'cursor: pointer; '+ 'min-height: 44px;';

                      div.innerHTML='<input type="checkbox" name="q_'+ escapeHtml(qid) + '" value="'+ escapeHtml(code) + '" '+ 'id="q_'+ qid + '_'+ code + '" '+ checked + ' '+ 'style="margin:0;width:20px;height:20px;cursor:pointer;flex-shrink:0;accent-color:#2f6fb5;">'+ '<label for="q_'+ qid + '_'+ code + '" '+ 'style="cursor:pointer;margin:0;flex:1;font-size:14px;line-height:1.5;color:#1f2937;font-weight:500;word-wrap:break-word;overflow-wrap:break-word;">'+ escapeHtml(label) + '</label>';

                      gridContainer.appendChild(div);

                      var checkbox=div.querySelector('input');

                      checkbox.addEventListener('change', function() {
                          updateQuestionnaireUIState();

                          if (checkbox.checked) {
                            div.style.background='linear-gradient(135deg, rgba(47,111,181,0.12), rgba(143,191,120,0.08))';
                            div.style.borderColor='rgba(47,111,181,0.3)';
                            div.style.boxShadow='0 2px 8px rgba(47,111,181,0.15)';
                          }

                          else {
                            div.style.background='rgba(255,255,255,0.6)';
                            div.style.borderColor='rgba(31,41,55,0.08)';
                            div.style.boxShadow='none';
                          }
                        }

                      );

                      div.addEventListener('mouseenter', function() {
                          if ( !checkbox.checked) {
                            div.style.background='rgba(47,111,181,0.06)';
                            div.style.borderColor='rgba(47,111,181,0.15)';
                          }
                        }

                      );

                      div.addEventListener('mouseleave', function() {
                          if ( !checkbox.checked) {
                            div.style.background='rgba(255,255,255,0.6)';
                            div.style.borderColor='rgba(31,41,55,0.08)';
                          }
                        }

                      );

                      div.addEventListener('click', function(e) {
                          if (e.target.tagName !=='INPUT') {
                            checkbox.checked= !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                          }
                        }

                      );

                      if (checked) {
                        div.style.background='linear-gradient(135deg, rgba(47,111,181,0.12), rgba(143,191,120,0.08))';
                        div.style.borderColor='rgba(47,111,181,0.3)';
                        div.style.boxShadow='0 2px 8px rgba(47,111,181,0.15)';
                      }
                    }

                  );

                  elA.appendChild(gridContainer);
                }

                // NUMBER INPUT
                else if (qType==='number') {
                  console.log('[Q] Rendering NUMBER INPUT for:', qid);

                  var inp=document.createElement('input');
                  inp.type='number';
                  inp.id='q_'+ qid + '_num';
                  inp.placeholder=lang==='HI'? '‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç' : 'Enter numeric value';
                  inp.value=prevRaw || '';
                  inp.style.cssText='width:100%;padding:12px 16px;border-radius:12px;border:2px solid rgba(31,41,55,0.12);background:rgba(255,255,255,0.95);font-size:15px;font-weight:500;color:#1f2937;transition:all 0.2s ease;';

                  inp.addEventListener('focus', function() {
                      inp.style.borderColor='#2f6fb5';
                      inp.style.boxShadow='0 0 0 3px rgba(47,111,181,0.1)';
                    }

                  );

                  inp.addEventListener('blur', function() {
                      inp.style.borderColor='rgba(31,41,55,0.12)';
                      inp.style.boxShadow='none';
                    }

                  );

                  elA.appendChild(inp);
                  inp.addEventListener('input', updateQuestionnaireUIState);
                }

                // TEXT INPUT (DEFAULT)
                else {
                  console.log('[Q] Rendering TEXT INPUT for:', qid, '(type:', qType, ')');

                  var inp=document.createElement('input');
                  inp.type='text';
                  inp.id='q_'+ qid + '_text';
                  inp.placeholder=lang==='HI'? '‡§Ö‡§™‡§®‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç' : 'Enter your answer';
                  inp.value=prevRaw || '';
                  inp.style.cssText='width:100%;padding:12px 16px;border-radius:12px;border:2px solid rgba(31,41,55,0.12);background:rgba(255,255,255,0.95);font-size:15px;font-weight:500;color:#1f2937;transition:all 0.2s ease;';

                  inp.addEventListener('focus', function() {
                      inp.style.borderColor='#2f6fb5';
                      inp.style.boxShadow='0 0 0 3px rgba(47,111,181,0.1)';
                    }

                  );

                  inp.addEventListener('blur', function() {
                      inp.style.borderColor='rgba(31,41,55,0.12)';
                      inp.style.boxShadow='none';
                    }

                  );

                  elA.appendChild(inp);
                  inp.addEventListener('input', updateQuestionnaireUIState);
                }
              }

              function readAnswerFromUI() {
                var qid=CPOSL.qState.current;
                if ( !qid) return null;

                // Handle probe questions
                if (String(qid).indexOf('PROBE_')===0) {
                  var radio=document.querySelector('input[name="probeAnswer"]:checked');
                  if (radio) return radio.value;
                  var numInput=document.getElementById('probeNumInput');
                  if (numInput && numInput.value.trim()) return numInput.value.trim();
                  return null;
                }

                var qRow=CPOSL.q.idx.qBankById.get(qid);
                if ( !qRow) return null;

                var qType=String(getField(qRow, ['Answer_Type', 'AnswerType']) || '').toLowerCase();

                if (qType==='single_select') {
                  var radio=document.querySelector('input[name="q_'+ qid + '"]:checked');
                  return radio ? radio.value : null;
                }

                else if (qType==='multi_select') {
                  var boxes=document.querySelectorAll('input[name="q_'+ qid + '"]:checked');
                  var codes=[];

                  boxes.forEach(function(b) {
                      codes.push(b.value);
                    }

                  );
                  return codes.length ? codes.join(',') : null;
                }

                else if (qType==='number') {
                  var inp=document.getElementById('q_'+ qid + '_num');
                  return inp ? inp.value.trim() : null;
                }

                else {
                  var inp=document.getElementById('q_'+ qid + '_text');
                  return inp ? inp.value.trim() : null;
                }
              }

              function validateAnswer(answerRaw) {
                return answerRaw !==null && answerRaw !==undefined && String(answerRaw).trim() !=='';
              }

              function updateDerivedBox() {
                var box=document.getElementById('qDerivedBox');
                if ( !box) return;

                var signals=CPOSL.qState.signals;
                var keys=Object.keys(signals);

                if (keys.length===0) {
                  box.textContent='Signals and auto-filled factors will appear here.';
                  return;
                }

                var html='<b>Derived Signals ('+ keys.length + '):</b>\n';

                keys.forEach(function(k) {
                    var sig=signals[k];
                    var conf=sig.confidence ? (sig.confidence * 100).toFixed(0) + '%' : '‚Äî';
                    html +='‚Ä¢ '+ escapeHtml(k) + ': '+ escapeHtml(sig.value) + ' (conf: '+ conf + ')\n';
                  }

                );


                var mapped=Object.keys(CPOSL.selections);

                if (mapped.length > 0) {
                  html +='\n<b>Auto-filled Factors ('+ mapped.length + '):</b>\n';

                  mapped.forEach(function(k) {
                      var selection=CPOSL.selections[k];

                      // ‚úÖ FIX: Extract value from object or string
                      var displayValue='';
                      var isAuto=false;
                      var source='';

                      if (typeof selection==='object'&& selection.value !==undefined) {
                        displayValue=selection.value;
                        isAuto=selection.auto===true;
                        source=selection.source || '';
                      }

                      else if (typeof selection==='string') {
                        displayValue=selection;
                      }

                      if (displayValue) {
                        var badge=isAuto ? ' <span style="color:#4caf50;font-size:0.85em;">(AUTO)</span>' : '';
                        var fromText=source ? ' <span style="color:#666;font-size:0.85em;">from '+ source + '</span>' : '';
                        html +='‚Ä¢ '+ escapeHtml(k) + ' ‚Üí '+ escapeHtml(displayValue) + badge + fromText + '\n';
                      }
                    }

                  );
                }

                box.innerHTML=html;
              }

              //  * UI TRANSLATIONS - ENGLISH & HINDI

              /**
             * UI TRANSLATIONS - ENGLISH & HINDI (COMPLETE)
             */
              /**
             * UI TRANSLATIONS - ENGLISH & HINDI (CORRECTED)
             */
              var UI_TRANSLATIONS= {
                EN: {
                  // BUTTONS
                  btnStart: 'üöÄ Start Questionnaire',
                  btnNext: 'Next ‚Üí',
                  btnBack: '‚Üê Back',
                  btnSkip: 'Skip ‚Üí',
                  btnFinish: '‚úì Finish & Apply',
                  btnSave: 'üíæ Save Progress',
                  btnDebug: 'üêõ Debug',
                  btnStartRound: 'Start Round {{round}} ‚Üí',
                  btnClear: 'Clear',
                  btnEvaluate: 'Evaluate ‚Üí',
                  btnBackToInputs: '‚Üê Back',
                  btnToSummary: 'Decision Summary ‚Üí',
                  btnBackToResults: '‚Üê Back',
                  btnSaveAssessment: 'Save Assessment',
                  btnRestartEval: 'üîÑ New Evaluation',

                  // PROGRESS
                  progressRound: 'Round {{current}}/{{total}} - Question {{answered}} of {{total}}',
                  progressPercent: '({{percent}}% of Round {{round}})',
                  progressAnswered: '‚úì <strong>{{count}}</strong> total',
                  progressSignals: '‚ö° <strong>{{count}}</strong> signals',
                  progressFactors: 'üìä <strong>{{count}}</strong> factors',

                  // ROUND TRANSITIONS
                  roundComplete: '‚úÖ Round {{round}} Complete!',
                  roundCompleteSubtitle: 'Answered: {{answered}} questions | Signals: {{signals}} | Factors: {{factors}}',
                  roundNext: 'üéØ Round {{round}}: {{name}}',
                  allRoundsComplete: 'üéâ All 3 Rounds Complete!',
                  allRoundsSubtitle: 'Click Finish to see your results.',

                  // MESSAGES
                  msgNoQuestion: 'No current question.',
                  msgQuestionNotFound: 'Question {{qid}} not found.',
                  msgProvideAnswer: 'Please provide an answer.',
                  msgCannotSkipRequired: 'This question is required and cannot be skipped.',
                  msgCannotSkipProbe: 'Cannot skip verification questions.',
                  msgQuestionnaireComplete: 'Questionnaire complete! Answered {{answered}} questions, derived {{signals}} signals, auto-filled {{factors}} factors.',
                  msgClickFinish: 'Click Step 1 to review auto-filled factors, or Step 2 for pathway analysis.',
                  msgAutoSaved: 'üíæ Progress auto-saved',
                  msgClickStart: 'Click Start to begin the questionnaire.',
                  msgSignalsWillAppear: 'Signals and auto-filled factors will appear here.',
                  msgEnterValues: 'Enter values to view class, desirability, and pathway context here.',
                  msgMrvWillAppear: 'MRV focus strip will appear after evaluation.',
                  msgEvaluateToSummary: 'Evaluate at least one input to generate a decision summary.',
                  msgSelectionHint: 'Tip: Enter any soil + climate + management values you have. You can evaluate even with partial inputs.',

                  // STATUS
                  statusLoading: 'Loading...',
                  statusReady: 'Ready',
                  statusStarted: 'Round {{round}}/3 started',
                  statusComplete: 'Questionnaire complete: {{answered}} answers, {{factors}} factors',

                  // PLACEHOLDERS
                  placeholderNumber: 'Enter numeric value',
                  placeholderText: 'Enter your answer',

                  // ROUND NAMES
                  round1Name: 'Quick Overview',
                  round1Desc: 'Get a broad picture of your farm',
                  round2Name: 'Detailed Analysis',
                  round2Desc: 'Deep dive into key areas',
                  round3Name: 'Validation Check',
                  round3Desc: 'Verify key information',

                  // PANEL TITLES
                  cardTitleQuestionnaire: 'Adaptive Questionnaire',
                  cardHintQuestionnaire: 'about 50 Q - Fast setup - Auto-fills Step 1',
                  cardTitleSignals: 'Derived Signals + Auto-filled Factors',
                  cardHintSignals: 'Questionnaire explainability',
                  cardTitleInputs: 'Inputs',
                  cardHintInputs: 'Grouped by Factor_Category ‚Ä¢ Select class for each factor',
                  cardTitleExplain: 'Explainability',
                  cardHintExplain: 'Weights √ó desirability + Pathway_context',
                  cardTitlePathways: 'Pathway Screening',
                  cardHintPathways: 'Computed from Lite tables',
                  cardTitleCurrentInputs: 'Current Inputs',
                  cardHintCurrentInputs: 'Observed_Value + classified Class_Label',
                  cardTitleSummary: 'Decision Summary',
                  cardHintSummary: 'Recommended stack + key cautions',
                  cardTitleSaveAssess: 'Save Assessment',
                  cardHintSaveAssess: 'Optional metadata',

                  // LABELS
                  labelRecommended: 'Recommended',
                  labelConditional: 'Conditional',
                  labelExcluded: 'Excluded',
                  labelClientId: 'Client_ID',
                  labelSiteId: 'Site_ID',
                  labelSiteName: 'Site_Name',
                  labelCropSystem: 'Crop_System',
                  labelNotes: 'Notes',

                  // EARLY FINISH
                  earlyFinishWarning: '‚ö†Ô∏è You can finish now, but continuing improves data quality and confidence.',
                  btnFinishEarly: 'Finish Early',
                  btnContinueRound: 'Continue to Round {{round}} ‚Üí',
                  round1FinishNote: 'Round 1 complete gives basic recommendations. Rounds 2-3 add validation and depth.',
                  round2FinishNote: 'Round 2 complete gives good confidence. Round 3 validates consistency.',
                  allRoundsNote: 'All 3 rounds complete - Maximum confidence and validation!',
                  finishPromptComplete: '‚úÖ All 3 Rounds Complete - Fully Validated Assessment',
                  finishPromptEarly: '‚ö†Ô∏è Early Finish Available - Continue for Better Results',
                  confirmRestart: 'Are you sure you want to start a new evaluation? Current progress will be lost.'
                }

                ,

                HI: {
                  // BUTTONS
                  btnStart: 'üöÄ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§µ‡§≤‡•Ä ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç',
                  btnNext: '‡§Ö‡§ó‡§≤‡§æ ‚Üí',
                  btnBack: '‚Üê ‡§™‡•Ä‡§õ‡•á',
                  btnSkip: '‡§õ‡•ã‡§°‡§º‡•á‡§Ç ‚Üí',
                  btnFinish: '‚úì ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§≤‡§æ‡§ó‡•Ç ‡§ï‡§∞‡•á‡§Ç',
                  btnSave: 'üíæ ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§∏‡§π‡•á‡§ú‡•á‡§Ç',
                  btnDebug: 'üêõ ‡§°‡§ø‡§¨‡§ó',
                  btnStartRound: '‡§ö‡§∞‡§£ {{round}} ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç ‚Üí',
                  btnClear: '‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç',
                  btnEvaluate: '‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§ï‡§∞‡•á‡§Ç ‚Üí',
                  btnBackToInputs: '‚Üê ‡§™‡•Ä‡§õ‡•á',
                  btnToSummary: '‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‚Üí',
                  btnBackToResults: '‚Üê ‡§™‡•Ä‡§õ‡•á',
                  btnSaveAssessment: '‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§∏‡§π‡•á‡§ú‡•á‡§Ç',
                  btnRestartEval: 'üîÑ ‡§®‡§Ø‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§®',

                  // PROGRESS
                  progressRound: '‡§ö‡§∞‡§£ {{current}}/{{total}} - ‡§™‡•ç‡§∞‡§∂‡•ç‡§® {{answered}}, ‡§ï‡•Å‡§≤ {{total}}',
                  progressPercent: '(‡§ö‡§∞‡§£ {{round}} ‡§ï‡§æ {{percent}}%)',
                  progressAnswered: '‚úì <strong>{{count}}</strong> ‡§ï‡•Å‡§≤',
                  progressSignals: '‚ö° <strong>{{count}}</strong> ‡§∏‡§Ç‡§ï‡•á‡§§',
                  progressFactors: 'üìä <strong>{{count}}</strong> ‡§ï‡§æ‡§∞‡§ï',

                  // ROUND TRANSITIONS
                  roundComplete: '‚úÖ ‡§ö‡§∞‡§£ {{round}} ‡§™‡•Ç‡§∞‡•ç‡§£!',
                  roundCompleteSubtitle: '‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡§ø‡§è: {{answered}} ‡§™‡•ç‡§∞‡§∂‡•ç‡§® | ‡§∏‡§Ç‡§ï‡•á‡§§: {{signals}} | ‡§ï‡§æ‡§∞‡§ï: {{factors}}',
                  roundNext: 'üéØ ‡§ö‡§∞‡§£ {{round}}: {{name}}',
                  allRoundsComplete: 'üéâ ‡§∏‡§≠‡•Ä 3 ‡§ö‡§∞‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£!',
                  allRoundsSubtitle: '‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§',

                  // MESSAGES
                  msgNoQuestion: '‡§ï‡•ã‡§à ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç‡•§',
                  msgQuestionNotFound: '‡§™‡•ç‡§∞‡§∂‡•ç‡§® {{qid}} ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§',
                  msgProvideAnswer: '‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§Ç‡•§',
                  msgCannotSkipRequired: '‡§Ø‡§π ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à ‡§î‡§∞ ‡§á‡§∏‡•á ‡§õ‡•ã‡§°‡§º‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ‡•§',
                  msgCannotSkipProbe: '‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡•ã ‡§õ‡•ã‡§°‡§º‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ‡•§',
                  msgQuestionnaireComplete: '‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§µ‡§≤‡•Ä ‡§™‡•Ç‡§∞‡•ç‡§£! {{answered}} ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡§ø‡§è, {{signals}} ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§ø‡§è, {{factors}} ‡§ï‡§æ‡§∞‡§ï ‡§∏‡•ç‡§µ‡§§‡§É ‡§≠‡§∞‡•á ‡§ó‡§è‡•§',
                  msgClickFinish: '‡§∏‡•ç‡§µ‡§§‡§É ‡§≠‡§∞‡•á ‡§ó‡§è ‡§ï‡§æ‡§∞‡§ï‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ö‡§∞‡§£ 1 ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç, ‡§Ø‡§æ ‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ö‡§∞‡§£ 2 ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§',
                  msgAutoSaved: 'üíæ ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§∏‡•ç‡§µ‡§§‡§É ‡§∏‡§π‡•á‡§ú‡•Ä ‡§ó‡§à',
                  msgClickStart: '‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§µ‡§≤‡•Ä ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Start ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§',
                  msgSignalsWillAppear: '‡§∏‡§Ç‡§ï‡•á‡§§ ‡§î‡§∞ ‡§∏‡•ç‡§µ‡§§‡§É ‡§≠‡§∞‡•á ‡§ó‡§è ‡§ï‡§æ‡§∞‡§ï ‡§Ø‡§π‡§æ‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§Ç‡§ó‡•á‡•§',
                  msgEnterValues: '‡§µ‡§∞‡•ç‡§ó, ‡§µ‡§æ‡§Ç‡§õ‡§®‡•Ä‡§Ø‡§§‡§æ ‡§î‡§∞ ‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§æ‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§',
                  msgMrvWillAppear: '‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§ï‡•á ‡§¨‡§æ‡§¶ MRV ‡§´‡•ã‡§ï‡§∏ ‡§™‡§ü‡•ç‡§ü‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§ó‡•Ä‡•§',
                  msgEvaluateToSummary: '‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§á‡§®‡§™‡•Å‡§ü ‡§ï‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§ï‡§∞‡•á‡§Ç‡•§',
                  msgSelectionHint: '‡§∏‡•Å‡§ù‡§æ‡§µ: ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ú‡•ã ‡§≠‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä + ‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å + ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§Æ‡§æ‡§® ‡§π‡•à‡§Ç ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ü‡§™ ‡§Ü‡§Ç‡§∂‡§ø‡§ï ‡§á‡§®‡§™‡•Å‡§ü ‡§ï‡•á ‡§∏‡§æ‡§• ‡§≠‡•Ä ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§',

                  // STATUS
                  statusLoading: '‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
                  statusReady: '‡§§‡•à‡§Ø‡§æ‡§∞',
                  statusStarted: '‡§ö‡§∞‡§£ {{round}}/3 ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•Å‡§Ü',
                  statusComplete: '‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§µ‡§≤‡•Ä ‡§™‡•Ç‡§∞‡•ç‡§£: {{answered}} ‡§â‡§§‡•ç‡§§‡§∞, {{factors}} ‡§ï‡§æ‡§∞‡§ï',

                  // PLACEHOLDERS
                  placeholderNumber: '‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç',
                  placeholderText: '‡§Ö‡§™‡§®‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç',

                  // ROUND NAMES
                  round1Name: '‡§§‡•ç   ‡§∞‡§ø‡§§ ‡§Ö‡§µ‡§≤‡•ã‡§ï‡§®',
                  round1Desc: '‡§Ö‡§™‡§®‡•á ‡§ñ‡•á‡§§ ‡§ï‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§™‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç',
                  round2Name: '‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£',
                  round2Desc: '‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ó‡§π‡§® ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä',
                  round3Name: '‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§® ‡§ú‡§æ‡§Ç‡§ö',
                  round3Desc: '‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç',

                  // PANEL TITLES
                  cardTitleQuestionnaire: '‡§Ö‡§®‡•Å‡§ï‡•Ç‡§≤‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§µ‡§≤‡•Ä',
                  cardHintQuestionnaire: '‡§≤‡§ó‡§≠‡§ó 50 ‡§™‡•ç‡§∞‡§∂‡•ç‡§® - ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§∏‡•á‡§ü‡§Ö‡§™ - ‡§∏‡•ç‡§µ‡§§‡§É ‡§≠‡§∞‡§§‡§æ ‡§π‡•à ‡§ö‡§∞‡§£ 1',
                  cardTitleSignals: '‡§µ‡•ç‡§Ø‡•Å‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§∏‡§Ç‡§ï‡•á‡§§ + ‡§∏‡•ç‡§µ‡§§‡§É ‡§≠‡§∞‡•á ‡§ó‡§è ‡§ï‡§æ‡§∞‡§ï',
                  cardHintSignals: '‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§µ‡§≤‡•Ä ‡§ï‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ',
                  cardTitleInputs: '‡§á‡§®‡§™‡•Å‡§ü',
                  cardHintInputs: '‡§ï‡§æ‡§∞‡§ï_‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡§Æ‡•Ç‡§π‡•Ä‡§ï‡•É‡§§ ‚Ä¢ ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§ï‡§æ‡§∞‡§ï ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§∞‡•ç‡§ó ‡§ö‡•Å‡§®‡•á‡§Ç',
                  cardTitleExplain: '‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ',
                  cardHintExplain: '‡§≠‡§æ‡§∞ √ó ‡§µ‡§æ‡§Ç‡§õ‡§®‡•Ä‡§Ø‡§§‡§æ + ‡§Æ‡§æ‡§∞‡•ç‡§ó_‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠',
                  cardTitlePathways: '‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§ú‡§æ‡§Ç‡§ö',
                  cardHintPathways: 'Lite ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ‡§ì‡§Ç ‡§∏‡•á ‡§ó‡§£‡§®‡§æ ‡§ï‡•Ä ‡§ó‡§à',
                  cardTitleCurrentInputs: '‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§á‡§®‡§™‡•Å‡§ü',
                  cardHintCurrentInputs: '‡§Ö‡§µ‡§≤‡•ã‡§ï‡§ø‡§§_‡§Æ‡§æ‡§® + ‡§µ‡§∞‡•ç‡§ó‡•Ä‡§ï‡•É‡§§ Class_Label',
                  cardTitleSummary: '‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂',
                  cardHintSummary: '‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§ø‡§§ ‡§∏‡•ç‡§ü‡•à‡§ï + ‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡§ø‡§Ø‡§æ‡§Å',
                  cardTitleSaveAssess: '‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§∏‡§π‡•á‡§ú‡•á‡§Ç',
                  cardHintSaveAssess: '‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ',

                  // LABELS
                  labelRecommended: '‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§ø‡§§',
                  labelConditional: '‡§∏‡§∂‡§∞‡•ç‡§§',
                  labelExcluded: '‡§¨‡§π‡§ø‡§∑‡•ç‡§ï‡•É‡§§',
                  labelClientId: '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï_‡§Ü‡§à‡§°‡•Ä',
                  labelSiteId: '‡§∏‡§æ‡§á‡§ü_‡§Ü‡§à‡§°‡•Ä',
                  labelSiteName: '‡§∏‡§æ‡§á‡§ü_‡§®‡§æ‡§Æ',
                  labelCropSystem: '‡§´‡§∏‡§≤_‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä',
                  labelNotes: '‡§ü‡§ø‡§™‡•ç‡§™‡§£‡§ø‡§Ø‡§æ‡§Å',

                  // EARLY FINISH
                  earlyFinishWarning: '‚ö†Ô∏è ‡§Ü‡§™ ‡§Ö‡§≠‡•Ä ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§≤‡•á‡§ï‡§ø‡§® ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§®‡•á ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§¨‡•á‡§π‡§§‡§∞ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§',
                  btnFinishEarly: '‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç',
                  btnContinueRound: '‡§ö‡§∞‡§£ {{round}} ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç ‚Üí',
                  round1FinishNote: '‡§ö‡§∞‡§£ 1 ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§¨‡•Å‡§®‡§ø‡§Ø‡§æ‡§¶‡•Ä ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∂‡•á‡§Ç ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à‡§Ç‡•§ ‡§ö‡§∞‡§£ 2-3 ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§® ‡§î‡§∞ ‡§ó‡§π‡§∞‡§æ‡§à ‡§ú‡•ã‡§°‡§º‡§§‡•á ‡§π‡•à‡§Ç‡•§',
                  round2FinishNote: '‡§ö‡§∞‡§£ 2 ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§Æ‡§ø‡§≤‡§§‡§æ ‡§π‡•à‡•§ ‡§ö‡§∞‡§£ 3 ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§',
                  allRoundsNote: '‡§∏‡§≠‡•Ä 3 ‡§ö‡§∞‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£ - ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ   ‡§î‡§∞ ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§®!',
                  finishPromptComplete: '‚úÖ ‡§∏‡§≠‡•Ä 3 ‡§ö‡§∞‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£ - ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§®',
                  finishPromptEarly: '‚ö†Ô∏è ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß - ‡§¨‡•á‡§π‡§§‡§∞ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç',
                  confirmRestart: '‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§ñ‡•ã ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§'
                }
              }

              ;

              /**
             * Get translated text with placeholder replacement
             * @param {string} key - Translation key
             * @param {object} replacements - Key-value pairs for {{placeholder}} replacement
             * @returns {string} Translated text
             */
              function t(key, replacements) {
                var lang=CPOSL.language || 'EN';
                var text=UI_TRANSLATIONS[lang][key] || UI_TRANSLATIONS.EN[key] || key;

                // Replace placeholders like {{count}} with actual values
                if (replacements) {
                  Object.keys(replacements).forEach(function(k) {
                      text=text.replace(new RegExp('{{'+ k + '}}', 'g'), replacements[k]);
                    }

                  );
                }

                return text;
              }

              /**
             * Update all UI labels based on current language
             * Called when language changes or page initializes
             */
              function updateAllUILabels() {
                var setText=function(id, key, replacements) {
                  var el=document.getElementById(id);

                  if (el) {
                    var text=t(key, replacements);

                    // Use innerHTML for elements that contain HTML (like <strong> tags)
                    if (text.indexOf('<strong>') >=0) {
                      el.innerHTML=text;
                    }

                    else {
                      el.textContent=text;
                    }
                  }
                }

                ;

                // PANEL TITLES & HINTS
                setText('cardTitleQuestionnaire', 'cardTitleQuestionnaire');
                setText('cardHintQuestionnaire', 'cardHintQuestionnaire');
                setText('cardTitleSignals', 'cardTitleSignals');
                setText('cardHintSignals', 'cardHintSignals');
                setText('cardTitleInputs', 'cardTitleInputs');
                setText('cardHintInputs', 'cardHintInputs');
                setText('cardTitleExplain', 'cardTitleExplain');
                setText('cardHintExplain', 'cardHintExplain');
                setText('cardTitlePathways', 'cardTitlePathways');
                setText('cardHintPathways', 'cardHintPathways');
                setText('cardTitleCurrentInputs', 'cardTitleCurrentInputs');
                setText('cardHintCurrentInputs', 'cardHintCurrentInputs');
                setText('cardTitleSummary', 'cardTitleSummary');
                setText('cardHintSummary', 'cardHintSummary');
                setText('cardTitleSaveAssess', 'cardTitleSaveAssess');
                setText('cardHintSaveAssess', 'cardHintSaveAssess');

                // BUTTONS
                setText('btnQStartText', 'btnStart');
                setText('btnQNextText', 'btnNext');
                setText('btnQBackText', 'btnBack');
                setText('btnQSkipText', 'btnSkip');
                setText('btnQFinishText', 'btnFinish');
                setText('btnQSaveText', 'btnSave');
                setText('btnQDebugText', 'btnDebug');
                setText('btnClearText', 'btnClear');
                setText('btnEvaluateText', 'btnEvaluate');
                setText('btnBackToInputs', 'btnBackToInputs');
                setText('btnToSummary', 'btnToSummary');
                setText('btnBackToResults', 'btnBackToResults');
                setText('btnSaveAssessment', 'btnSaveAssessment');

                // LABELS
                setText('labelRecommended', 'labelRecommended');
                setText('labelConditional', 'labelConditional');
                setText('labelExcluded', 'labelExcluded');
                setText('labelClientId', 'labelClientId');
                setText('labelSiteId', 'labelSiteId');
                setText('labelSiteName', 'labelSiteName');
                setText('labelCropSystem', 'labelCropSystem');
                setText('labelNotes', 'labelNotes');

                // DEFAULT MESSAGES
                setText('qQuestionTextDefault', 'msgClickStart');
                setText('qDerivedBoxDefault', 'msgSignalsWillAppear');
                setText('notesBoxDefault', 'msgEnterValues');
                setText('mrvStripDefault', 'msgMrvWillAppear');
                setText('headlineBoxDefault', 'msgEvaluateToSummary');
                setText('selectionHintText', 'msgSelectionHint');
                setText('autoSaveText', 'msgAutoSaved');

                // FINISH BUTTON PROMPTS (üî¥ NEW)
                setText('finishPromptText', 'finishPromptComplete');

                setText('btnRestartEval', 'btnRestartEval');

                console.log('[UI] Updated all labels to:', CPOSL.language);
              }


              // QUESTIONNAIRE ACTIONS
              function qStart() {
                console.log('[Q] Starting questionnaire...');

                var starts=CPOSL.q.idx.startQuestions;

                if ( !starts || starts.length===0) {
                  alert('No start questions available.');
                  console.error('[Q] No start questions found!');
                  return;
                }

                // Generate unique session ID
                CPOSL.qState.sessionId='SES-'+ Date.now() + '-'+ Math.random().toString(36).substring(2, 6).toUpperCase();
                console.log('[Q] Generated session ID:', CPOSL.qState.sessionId);

                // Initialize Round 1
                CPOSL.rounds.current=1; // ‚úÖ Set to 1 when starting

                // Reset state
                CPOSL.qState.answered= {}

                ;

                CPOSL.qState.signals= {}

                ;
                CPOSL.qState.history=[];
                CPOSL.qState.current=starts[0];
                CPOSL.qState.stop=false;
                CPOSL.qState.probeCount=0;
                CPOSL.qState.pendingProbe=null;
                CPOSL.qState.pendingWarning=null;
                CPOSL.qState.lastAutoSave=0;
                CPOSL.qState.domainSequence=null;

                CPOSL.qState.skippedQuestions= {}

                ;

                // Reset rounds
                CPOSL.rounds.current=1;

                CPOSL.rounds.answered= {
                  1: [],
                  2: [],
                  3: []
                }

                ;
                CPOSL.rounds.config[3].validationPairs=[];
                // üî¥ NEW: Auto-discover available domains
                var availableDomains=discoverAvailableDomains();

                // Update Round 1 config with discovered domains (use top 8)
                CPOSL.rounds.config[1].domains=availableDomains.slice(0, 8);

                console.log('[Q] Round 1 will use domains:', CPOSL.rounds.config[1].domains);

                // Reset selections
                CPOSL.selections= {}

                ;

                // Track start time for duration calculation
                CPOSL.qState.startedAt=new Date().toISOString();

                console.log('[Q] State reset. Starting Round 1 with question:', starts[0]);

                // Show progress section
                toggleProgressSection(true);

                // Render UI
                renderQuestionUI();
                updateProgress();
                updateQuestionnaireUIState();
                setStatus(true, 'Round 1/3 started');
              }

              function qNext() {
                var qid=CPOSL.qState.current;
                console.log('[qNext] Current question:', qid);

                if ( !qid) {
                  console.warn('[qNext] No current question!');
                  return;
                }

                var answer=readAnswerFromUI();
                console.log('[qNext] Read answer from UI:', answer);

                if ( !validateAnswer(answer)) {
                  alert('Please provide an answer.');
                  return;
                }

                // Handle probe answer
                if (String(qid).indexOf('PROBE_')===0) {
                  var probeId=qid.replace('PROBE_', '');

                  if (typeof processProbeAnswer==='function') {
                    processProbeAnswer(probeId, answer);
                  }

                  proceedToNextQuestion();
                  return;
                }

                // Parse special answers (e.g., crop lists)
                var parsedData=null;
                var normalizedAnswer=answer;

                if (qid==='Q_A1'|| qid==='Q_A2') {
                  if (typeof parseCropAnswer==='function') {
                    parsedData=parseCropAnswer(answer);

                    if (parsedData && parsedData.crops.length > 0) {
                      normalizedAnswer=parsedData.crops.join(',');

                      Object.keys(parsedData.signals).forEach(function(key) {
                          var sig=parsedData.signals[key];

                          CPOSL.qState.signals[key]= {
                            value: sig.value,
                            confidence: sig.confidence,
                            sourceQ: qid
                          }

                          ;
                        }

                      );
                    }
                  }
                }

                // Save answer to state
                CPOSL.qState.answered[qid]= {
                  Question_ID: qid,
                  Answer_Raw: answer,
                  Answer_Normalized: normalizedAnswer,
                  Parsed_Data: parsedData,
                  Answered_At: new Date().toISOString(),
                  Round: CPOSL.rounds.current
                }

                ;

                // Track in round-specific list
                if ( !CPOSL.rounds.answered[CPOSL.rounds.current]) {
                  CPOSL.rounds.answered[CPOSL.rounds.current]=[];
                }

                CPOSL.rounds.answered[CPOSL.rounds.current].push(qid);

                console.log('[qNext] ‚úì Saved answer:', qid, '=', normalizedAnswer, '| Round:', CPOSL.rounds.current);

                // Apply derivations immediately
                console.log('[qNext] Applying derivations for', qid);
                var signalsBefore=Object.keys(CPOSL.qState.signals).length;
                applyDerivationsForQuestion(qid, normalizedAnswer);

                // Normalize values immediately
                if (typeof normalizeSignalValues==='function') {
                  normalizeSignalValues();
                }

                var signalsAfter=Object.keys(CPOSL.qState.signals).length;
                console.log('[qNext] Signals after derivation:', signalsAfter);

                // Save individual response to backend (async, non-blocking)
                if (CPOSL.qState.sessionId && typeof google !=='undefined'&& google.script) {
                  var derivedSignals=[];

                  Object.keys(CPOSL.qState.signals).forEach(function(key) {
                      var signal=CPOSL.qState.signals[key];

                      if (signal.sourceQ===qid) {
                        derivedSignals.push( {
                            key: key,
                            value: signal.value,
                            confidence: signal.confidence
                          }

                        );
                      }
                    }

                  );

                  var responsePayload= {
                    Session_ID: CPOSL.qState.sessionId,
                    Question_ID: qid,
                    Answer_Raw: answer,
                    Derived_Signals: derivedSignals,
                    Confidence: 1.0
                  }

                  ;

                  google.script.run .withSuccessHandler(function(result) {
                      if (result.ok && !result.skipped) {
                        console.log('[qNext] Response saved:', result.Response_ID);
                      }
                    }

                  ) .withFailureHandler(function(error) {
                      console.warn('[qNext] Response save failed (non-critical):', error.message);
                    }

                  ) .saveCPOSResponse(responsePayload);
                }

                // Apply routing rules
                if (typeof applyRoutingForQuestion==='function') {
                  applyRoutingForQuestion(qid, normalizedAnswer);
                }

                // Check consistency (only every 5 questions)
                var answeredCount=Object.keys(CPOSL.qState.answered).length;

                if (answeredCount % 5===0) {
                  if (typeof checkAnswerConsistency==='function') {
                    var violations=checkAnswerConsistency();

                    if (violations.length > 0) {
                      var highSeverity=violations.filter(function(v) {
                          return v.severity==='HIGH';
                        }

                      );

                      if (highSeverity.length > 0) {
                        if (typeof showConsistencyWarning==='function') {
                          showConsistencyWarning(highSeverity[0]);
                          return;
                        }
                      }
                    }
                  }
                }

                // Check for auto-save
                checkAutoSave();

                proceedToNextQuestion();
              }

              function proceedToNextQuestion() {
                var qid=CPOSL.qState.current;

                // Remove PROBE_ prefix if present
                if (qid && String(qid).indexOf('PROBE_')===0) {
                  qid=null;
                }

                else if (qid) {
                  CPOSL.qState.history.push(qid);
                }

                // Check if round is complete
                var currentRound=CPOSL.rounds.current;
                var answeredInRound=CPOSL.rounds.answered[currentRound] ? CPOSL.rounds.answered[currentRound].length : 0;
                var questionsPerRound=CPOSL.rounds.questionsPerRound;

                if (answeredInRound >=questionsPerRound) {
                  // Round complete
                  showRoundTransition();
                  CPOSL.qState.current=null;
                  updateQuestionnaireUIState();
                  updateDerivedBox();
                  updateProgress();
                  return;
                }

                // Find next question
                var next=findNextQuestion(qid);

                if (next) {
                  CPOSL.qState.current=next;
                  renderQuestionUI();
                }

                else {
                  CPOSL.qState.current=null;
                  var elQ=document.getElementById('qQuestionText');
                  var elH=document.getElementById('qHelpText');
                  var elA=document.getElementById('qAnswerBox');

                  if (elQ) elQ.textContent='Questionnaire complete! Click Finish to apply results.';
                  if (elH) elH.textContent='';
                  if (elA) elA.innerHTML='';
                }

                updateQuestionnaireUIState();
                updateDerivedBox();
                updateProgress();
              }

              /**
             * Show round transition
             */
              function showRoundTransition() {
                var currentRound=CPOSL.rounds.current;
                var nextRound=currentRound + 1;
                var lang=CPOSL.language;

                console.log('[Round Transition] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê');
                console.log('[Round Transition] Current round:', currentRound, '‚Üí Next:', nextRound);

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // REBUILD SIGNALS AND FACTORS BEFORE TRANSITION
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                console.log('[Round Transition] Rebuilding signals and factors...');

                if (typeof rebuildSignalsFromAllAnswers==='function') {
                  rebuildSignalsFromAllAnswers();
                }

                if (typeof applySignalMappings==='function') {
                  var mapped=applySignalMappings();
                  console.log('[Round Transition] ‚úì Mapped', mapped.length, 'signals to factors');
                }

                if (typeof applyEstimationMappings==='function') {
                  var estimated=applyEstimationMappings();
                  console.log('[Round Transition] ‚úì Applied', estimated.length, 'estimations');
                }

                // Update progress display
                if (typeof updateProgress==='function') {
                  updateProgress();
                }

                var signalsCount=Object.keys(CPOSL.qState.signals).length;
                var factorsCount=Object.keys(CPOSL.selections).length;

                console.log('[Round Transition] Now have:', signalsCount, 'signals,', factorsCount, 'factors');

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // CHECK IF ALL ROUNDS COMPLETE (üî¥ FIXED CONDITION)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                if (currentRound >=CPOSL.rounds.total) {
                  // Just completed the FINAL round!
                  console.log('[Round Transition] üéâ ALL ROUNDS COMPLETE!');

                  // Increment to mark as beyond last round
                  CPOSL.rounds.current=CPOSL.rounds.total + 1; // Set to 4
                  console.log('[Round Transition] Set rounds.current to:', CPOSL.rounds.current);

                  // Show completion message
                  document.getElementById('qQuestionText').innerHTML='<div style="padding:24px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border-radius:12px;text-align:center;box-shadow:0 4px 12px rgba(40,167,69,0.3)">'+ '<div style="font-size:32px;margin-bottom:12px">üéâ</div>'+ '<div style="font-size:24px;font-weight:700;margin-bottom:10px">'+ t('allRoundsComplete') + '</div>'+ '<div style="font-size:14px;margin-bottom:12px">'+ t('allRoundsSubtitle') + '</div>'+ '<div style="background:rgba(255,255,255,0.2);border-radius:8px;padding:10px;font-size:13px;margin-top:12px">'+ '‚úì '+ t('allRoundsNote') + '</div>'+ '</div>';

                  document.getElementById('qHelpText').textContent='';
                  document.getElementById('qAnswerBox').innerHTML='';

                  // üî¥ CRITICAL: Show finish button (not early, fully complete)
                  console.log('[Round Transition] Calling toggleFinishButton(true, false)...');
                  toggleFinishButton(true, false);

                  CPOSL.qState.current=null;
                  updateQuestionnaireUIState();

                  console.log('[Round Transition] Finish button should now be visible');
                  console.log('[Round Transition] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                  return;
                }

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // ROUND 1 or 2 COMPLETE - OFFER EARLY FINISH
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                console.log('[Round Transition] Round', currentRound, 'complete, offering early finish or continue');

                var prevRound=currentRound;
                var prevAnswered=CPOSL.rounds.answered[prevRound].length;

                var roundNameKey='round'+ nextRound + 'Name';
                var roundDescKey='round'+ nextRound + 'Desc';
                var roundName=t(roundNameKey);
                var roundDesc=t(roundDescKey);

                // Get round-specific note
                var noteKey=prevRound===1 ? 'round1FinishNote' : 'round2FinishNote';
                var roundNote=t(noteKey);

                document.getElementById('qQuestionText').innerHTML='<div style="padding:20px;background:linear-gradient(135deg,#007bff,#0056b3);color:white;border-radius:12px">'+ // Round complete message

                '<div style="font-size:20px;font-weight:700;margin-bottom:10px">'+ t('roundComplete', {
                    round: prevRound
                  }

                ) + '</div>'+ '<div style="font-size:14px;margin-bottom:15px">'+ t('roundCompleteSubtitle', {
                    answered: prevAnswered,
                    signals: signalsCount,
                    factors: factorsCount
                  }

                ) + '</div>'+ // Next round info

                '<div style="border-top:1px solid rgba(255,255,255,0.3);padding-top:15px;margin-top:10px">'+ '<div style="font-size:18px;font-weight:700;margin-bottom:8px">'+ t('roundNext', {
                    round: nextRound,
                    name: roundName
                  }

                ) + '</div>'+ '<div style="font-size:13px;opacity:0.95;margin-bottom:12px">'+ roundDesc + '</div>'+ '</div>'+ // Early finish option with warning

                '<div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.3)">'+ '<div style="background:rgba(255,193,7,0.25);border-radius:8px;padding:10px;margin-bottom:12px">'+ '<div style="font-size:12px;font-weight:600;margin-bottom:6px">'+ t('earlyFinishWarning') + '</div>'+ '<div style="font-size:11px;opacity:0.9">'+ roundNote + '</div>'+ '</div>'+ '<div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">'+ '<button class="btn" onclick="qFinish()" style="background:rgba(255,193,7,0.3);border:1px solid rgba(255,255,255,0.5);color:white;font-size:13px;padding:10px 20px;min-width:140px;">'+ t('btnFinishEarly') + '</button>'+ '<button class="btn primary" onclick="startNextRound()" style="background:rgba(255,255,255,0.95);color:#007bff;font-size:14px;padding:10px 24px;font-weight:700;border:none;min-width:180px;">'+ t('btnContinueRound', {
                    round: nextRound
                  }

                ) + '</button>'+ '</div>'+ '</div>'+ '</div>';

                document.getElementById('qHelpText').textContent='';
                document.getElementById('qAnswerBox').innerHTML='';

                // Hide the main finish button row (user will click inline buttons)
                toggleFinishButton(false, false);
                CPOSL.qState.current=null;
                updateQuestionnaireUIState();

                console.log('[Round Transition] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
              }


              /**
             * Toggle finish button visibility
             * @param {boolean} show - Whether to show the finish button
             * @param {boolean} isEarly - Whether this is an early finish (before Round 3)
             */
              function toggleFinishButton(show, isEarly) {
                var finishRow=document.getElementById('finishButtonRow');
                var finishPrompt=document.getElementById('finishPromptText');
                var btnFinish=document.getElementById('btnQFinish');

                // üî¥ ADD NULL CHECK
                if ( !finishRow) {
                  console.error('[Finish Button] ERROR: finishButtonRow element not found in HTML!');
                  return;
                }

                finishRow.style.display=show ? 'block' : 'none';

                if (show && finishPrompt) {
                  var promptKey=isEarly ? 'finishPromptEarly' : 'finishPromptComplete';
                  finishPrompt.textContent=t(promptKey);

                  if (isEarly) {
                    finishRow.style.background='linear-gradient(135deg, rgba(255,193,7,0.08), rgba(255,193,7,0.05))';
                    finishRow.style.borderColor='rgba(255,193,7,0.4)';
                  }

                  else {
                    finishRow.style.background='linear-gradient(135deg, rgba(220,53,69,0.08), rgba(200,35,51,0.05))';
                    finishRow.style.borderColor='rgba(220,53,69,0.3)';
                  }
                }

                if (btnFinish) {
                  btnFinish.disabled= !show;
                }

                console.log('[Finish Button]', show ? 'SHOWN' : 'HIDDEN', '| Early:', isEarly);
              }

              /**
             * Start next round
             */
              function startNextRound() {
                var nextRound=CPOSL.rounds.current + 1;
                CPOSL.rounds.current=nextRound;

                console.log('[Round] Starting Round', nextRound);

                // Rebuild signals before Round 2 & 3
                if (nextRound===2 || nextRound===3) {
                  if (typeof rebuildSignalsFromAllAnswers==='function') {
                    rebuildSignalsFromAllAnswers();
                  }

                  if (typeof applySignalMappings==='function') {
                    applySignalMappings();
                  }
                }

                var nextQuestion=findNextQuestion(null);

                if (nextQuestion) {
                  CPOSL.qState.current=nextQuestion;
                  renderQuestionUI();
                  updateQuestionnaireUIState();
                  updateProgress();
                  setStatus(true, 'Round '+ nextRound + '/3 started');
                }
              }

              function qBack() {
                console.log('[Q] Back button clicked');

                var history=CPOSL.qState.history;

                if (history.length===0) {
                  console.warn('[Q] No previous questions in history');
                  return;
                }

                // Get previous question
                var previousQID=history.pop();

                // Remove answer for current question if not answered yet
                if (CPOSL.qState.current && !CPOSL.qState.answered[CPOSL.qState.current]) {
                  console.log('[Q] Current question not answered, just going back');
                }

                else {

                  // Remove answer for previous question to allow re-answering
                  if (CPOSL.qState.answered[previousQID]) {
                    delete CPOSL.qState.answered[previousQID];
                    console.log('[Q] Removed answer for:', previousQID);
                  }
                }

                // Set as current question
                CPOSL.qState.current=previousQID;
                CPOSL.qState.pendingProbe=null;
                CPOSL.qState.pendingWarning=null;
                document.getElementById('qNavStatus').textContent='';

                // Re-render question
                renderQuestionUI();
                updateQuestionnaireUIState();
                updateProgress();

                console.log('[Q] Went back to:', previousQID);
              }

              function qSkip() {
                console.log('[Q] Skip button clicked');

                var qid=CPOSL.qState.current;
                if ( !qid) return;

                // Can't skip probe questions
                if (String(qid).indexOf('PROBE_')===0) {
                  alert('Cannot skip verification questions.');
                  return;
                }

                var qDef=CPOSL.q.idx.qBankById.get(qid);

                // Check if question is required
                if (qDef && qDef.Is_Required) {
                  alert('This question is required and cannot be skipped.');
                  return;
                }

                // Mark as skipped
                CPOSL.qState.answered[qid]= {
                  Question_ID: qid,
                  Answer_Raw: '__SKIPPED__',
                  Answer_Normalized: '__SKIPPED__',
                  Answered_At: new Date().toISOString()
                }

                ;

                console.log('[Q] Question skipped:', qid);

                // Proceed to next question
                proceedToNextQuestion();
              }

              function qFinish() {
                console.log('[Q] Finishing questionnaire...');

                // Track if this is an early finish
                var currentRound=CPOSL.rounds.current;
                var isEarlyFinish=currentRound <=CPOSL.rounds.total;
                var answeredCount=Object.keys(CPOSL.qState.answered).length;

                if (isEarlyFinish) {
                  console.log('[Q] ‚ö†Ô∏è EARLY FINISH after Round', currentRound, '| Answered:', answeredCount, 'questions');
                }

                else {
                  console.log('[Q] ‚úì COMPLETE FINISH after all rounds | Answered:', answeredCount, 'questions');
                }

                // Rebuild signals
                rebuildSignalsFromAllAnswers();

                // Apply signal-to-factor mappings
                var mapped=applySignalMappings();
                console.log('[Q] Signal mappings applied:', mapped.length);

                // Apply estimation rules
                var estimated=applyEstimationMappings();
                console.log('[Q] Estimations applied:', estimated.length);

                // Update UI
                CPOSL.qState.current=null;

                var answeredCountValid=Object.keys(CPOSL.qState.answered).filter(function(k) {
                    return CPOSL.qState.answered[k].Answer_Normalized !=='SKIPPED';
                  }

                ).length;
                var signalCount=Object.keys(CPOSL.qState.signals).length;
                var factorCount=Object.keys(CPOSL.selections).length;

                // Show completion message with quality indicator
                var qualityBadge='';

                if (isEarlyFinish) {
                  qualityBadge='<span style="display:inline-block;padding:4px 12px;background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);border-radius:20px;font-size:12px;margin-left:10px">‚ö†Ô∏è Early Finish</span>';
                }

                else {
                  qualityBadge='<span style="display:inline-block;padding:4px 12px;background:rgba(40,167,69,0.2);border:1px solid rgba(40,167,69,0.5);border-radius:20px;font-size:12px;margin-left:10px">‚úì Complete</span>';
                }

                document.getElementById('qQuestionText').innerHTML='<div style="font-size:16px;font-weight:600">'+ t('msgQuestionnaireComplete', {
                    answered: answeredCountValid,
                    signals: signalCount,
                    factors: factorCount
                  }

                ) + qualityBadge + '</div>';

                document.getElementById('qHelpText').textContent='';
                document.getElementById('qAnswerBox').innerHTML='<div class="mutedBox">'+ t('msgClickFinish') + '</div>';

                // Hide progress section and finish button
                toggleProgressSection(false);
                toggleFinishButton(false, false);

                // ‚úÖ UPDATE ALL UI COMPONENTS
                updateQuestionnaireUIState();
                updateDerivedBox();
                updateProgress();
                buildFactorForm();
                updateExplainBox(); // ‚úÖ ADDED: Update explainability panel
                // ‚úÖ UNLOCK STEPS after Round 1 completion
                var wasLocked=document.querySelector('button.tab.locked') !==null;
                updateStepNavigation();

                setStatus(true, t('statusComplete', {
                      answered: answeredCountValid,
                      factors: factorCount
                    }

                  ));

                console.log('[Q] Final signals:', CPOSL.qState.signals);
                console.log('[Q] Final selections:', CPOSL.selections);
                console.log('[Q] Completion quality:', isEarlyFinish ? 'EARLY' : 'COMPLETE');
              }

              // PROGRESS TRACKING & UX FUNCTIONS

              /**
             * Update progress indicators
             */
              function updateProgress() {
                var answeredCount=Object.keys(CPOSL.qState.answered).length;
                var totalQuestions=CPOSL.q.idx.qBankById.size;
                var signalsCount=Object.keys(CPOSL.qState.signals).length;
                var factorsCount=Object.keys(CPOSL.selections).length;

                // Round-specific progress
                var currentRound=CPOSL.rounds.current;
                var answeredInRound=CPOSL.rounds.answered[currentRound] ? CPOSL.rounds.answered[currentRound].length : 0;
                var questionsPerRound=CPOSL.rounds.questionsPerRound;
                var roundPercent=questionsPerRound > 0 ? Math.round((answeredInRound / questionsPerRound) * 100) : 0;

                // Update counters
                var elCounter=document.getElementById('questionCounter');
                var elPercent=document.getElementById('progressPercentage');
                var elAnswered=document.getElementById('answeredCounter');
                var elSignals=document.getElementById('signalsCounter');
                var elFactors=document.getElementById('factorsCounter');
                var elBar=document.getElementById('progressBar');

                if (elCounter) {
                  elCounter.textContent='Round '+ currentRound + '/3 - Question '+ (answeredInRound + 1) + ' of '+ questionsPerRound;
                }

                if (elPercent) {
                  elPercent.textContent='('+ roundPercent + '% of Round '+ currentRound + ')';
                }

                if (elAnswered) {
                  elAnswered.innerHTML='‚úì <strong>'+ answeredCount + '</strong> total';
                }

                if (elSignals) {
                  elSignals.innerHTML='‚ö° <strong>'+ signalsCount + '</strong> signals';
                }

                if (elFactors) {
                  elFactors.innerHTML='üìä <strong>'+ factorsCount + '</strong> factors';
                }

                if (elBar) {
                  elBar.style.width=roundPercent + '%';
                }

                console.log('[Progress] Round', currentRound, ':', answeredInRound, '/', questionsPerRound, '|', roundPercent + '%');
              }

              /**
             * Show/hide progress section
             */
              function toggleProgressSection(show) {
                var el=document.getElementById('progressSection');
                if (el) el.style.display=show ? 'block' : 'none';
              }

              /**
             * Auto-save progress every 5 questions
             */
              function checkAutoSave() {
                var answeredCount=Object.keys(CPOSL.qState.answered).length;

                // Auto-save every 5 questions
                if (answeredCount > 0 && answeredCount % 5===0) {

                  // Check if we haven't already auto-saved at this count
                  if ( !CPOSL.qState.lastAutoSave || CPOSL.qState.lastAutoSave !==answeredCount) {
                    saveProgress();
                    CPOSL.qState.lastAutoSave=answeredCount;
                  }
                }
              }

              /**
             * Save progress (session only, not full assessment)
             */
              function saveProgress() {
                console.log('[Auto-Save] Saving progress...');

                var answeredCount=Object.keys(CPOSL.qState.answered).length;
                var signalsCount=Object.keys(CPOSL.qState.signals).length;

                // Calculate duration
                var durationMinutes=0;

                if (CPOSL.qState.startedAt) {
                  var startTime=new Date(CPOSL.qState.startedAt);
                  var now=new Date();
                  durationMinutes=Math.round((now - startTime) / 1000 / 60);
                }

                var sessionPayload= {

                  Session_ID: CPOSL.qState.sessionId,
                  Created_At: CPOSL.qState.startedAt || new Date().toISOString(),
                  Client_ID: 'Default',
                  Language: CPOSL.language || 'EN',
                  Mode: CPOSL.qState.mode || 'BASIC',
                  Answered_Count: answeredCount,
                  Signals_Derived_Count: signalsCount,
                  Duration_Minutes: durationMinutes,
                  Quality_Score: Math.min(100, (signalsCount * 8)),
                  Summary: {
                    questions: answeredCount,
                    signals: signalsCount,
                    in_progress: true
                  }

                  ,
                  Status: 'IN_PROGRESS',
                  Notes: 'Auto-saved progress'
                }

                ;

                google.script.run .withSuccessHandler(function(result) {
                    console.log('[Auto-Save] Success:', result);
                    showAutoSaveIndicator();
                  }

                ) .withFailureHandler(function(error) {
                    console.warn('[Auto-Save] Failed (non-critical):', error.message);
                  }

                ) .saveCPOSSession(sessionPayload);
              }

              /**
             * Show auto-save indicator briefly
             */
              function showAutoSaveIndicator() {
                var indicator=document.getElementById('autoSaveIndicator');
                if ( !indicator) return;

                indicator.style.display='block';

                setTimeout(function() {
                    indicator.style.display='none';
                  }

                  , 3000); // Hide after 3 seconds
              }


              // INTELLIGENT QUESTION ROUTING - 3 ROUND SYSTEM


              /**
             * Extract domain from question ID (COMPLETE MAPPING)
             */
              function extractDomain(questionId) {
                if ( !questionId) {
                  console.warn('[Domain] Invalid question ID:', questionId);
                  return 'OTHER';
                }

                // Match pattern: Q_XX or Q_X
                var match=questionId.match(/Q_([A-Z]+)/);

                if ( !match) {
                  console.warn('[Domain] Question ID doesnt match pattern Q_XX:', questionId);
                  return 'OTHER';
                }

                var prefix=match[1];

                var domainMap= {
                  // Original mappings
                  'S': 'SOIL',
                  'C': 'CROP',
                  'M': 'MANAGEMENT',
                  'A': 'AGRICULTURE',
                  'N': 'NUTRIENT',
                  'W': 'WATER',
                  'E': 'ECONOMIC',

                  // Multi-letter prefixes
                  'CL': 'CLIMATE',
                  'CR': 'CROP',

                  // üî¥ NEW: Add your actual question prefixes
                  'T': 'TILLAGE', // Q_T001-Q_T027 (27 questions)
                  'F': 'FERTILIZER', // Q_F001-Q_F006 (6 questions)
                  'B': 'BIOCHAR', // Q_B001-Q_B003 (3 questions)
                  'R': 'RESIDUE' // Q_R001-Q_R007 (7 questions)
                }

                ;

                var domain=domainMap[prefix] || 'OTHER';

                // Only log if it's OTHER (unexpected)
                if (domain==='OTHER') {
                  console.log('[Domain] Unmapped prefix:', prefix, 'for', questionId);
                }

                return domain;
              }

              // FARM CONTEXT ANALYSIS - Identifies farm characteristics from Round 1 answers

              /**
             * IDENTIFY FARM CONTEXT from Round 1 answers
             * Analyzes answered questions to determine crop type, soil type, management style
             */
              function identifyFarmContext() {
                var context= {
                  crops: [],
                  soilTypes: [],
                  managementStyle: 'UNKNOWN',
                  waterAvailability: 'UNKNOWN',
                  hasRice: false,
                  hasWheat: false,
                  hasMaize: false,
                  isClay: false,
                  isSand: false,
                  isLoam: false,
                  isIrrigated: false,
                  hasResidue: false,
                  contextTags: []
                }

                ;

                var signals=CPOSL.qState.signals;

                // CROP CONTEXT
                if (signals['CROP_RICE_DETECTED'] || (signals['MAIN_CROP'] && signals['MAIN_CROP'].value==='RICE')) {
                  context.crops.push('RICE');
                  context.hasRice=true;
                  context.contextTags.push('RICE');
                }

                if (signals['CROP_WHEAT_DETECTED'] || (signals['MAIN_CROP'] && signals['MAIN_CROP'].value==='WHEAT')) {
                  context.crops.push('WHEAT');
                  context.hasWheat=true;
                  context.contextTags.push('WHEAT');
                }

                if ((signals['CROP'] && signals['CROP'].value==='MAIZE') || (signals['MAIN_CROP'] && signals['MAIN_CROP'].value==='MAIZE')) {
                  context.crops.push('MAIZE');
                  context.hasMaize=true;
                  context.contextTags.push('MAIZE');
                }

                if (context.crops.length > 1) {
                  context.contextTags.push('MIXED_CROP');
                }

                // SOIL CONTEXT
                var texture=signals['SOIL_TEXTURE'] || signals['TEXTURE_PROXY'] || signals['TEXTURE'];

                if (texture) {
                  var textureValue=String(texture.value || texture).toUpperCase();

                  if (textureValue.indexOf('CLAY') >=0) {
                    context.soilTypes.push('CLAY');
                    context.isClay=true;
                    context.contextTags.push('CLAY');
                  }

                  if (textureValue.indexOf('SAND') >=0) {
                    context.soilTypes.push('SAND');
                    context.isSand=true;
                    context.contextTags.push('SAND');
                  }

                  if (textureValue.indexOf('LOAM') >=0) {
                    context.soilTypes.push('LOAM');
                    context.isLoam=true;
                    context.contextTags.push('LOAM');
                  }
                }

                // MANAGEMENT CONTEXT
                var tillage=signals['TILLAGE_TYPE'] || signals['TILLAGE'];

                if (tillage) {
                  var tillageValue=String(tillage.value || tillage).toUpperCase();

                  if (tillageValue.indexOf('ZERO') >=0 || tillageValue==='NONE') {
                    context.managementStyle='CONSERVATION';
                    context.contextTags.push('CONSERVATION');
                  }

                  else if (tillageValue.indexOf('REDUCED') >=0 || tillageValue.indexOf('MINIMUM') >=0) {
                    context.managementStyle='CONSERVATION';
                    context.contextTags.push('CONSERVATION');
                  }

                  else {
                    context.managementStyle='CONVENTIONAL';
                    context.contextTags.push('CONVENTIONAL');
                  }
                }

                var organic=signals['ORGANIC_AMENDMENT'] || signals['ORG_AMENDMENT'];

                if (organic && (organic.value==='YES'|| organic.value==='HIGH')) {
                  context.contextTags.push('ORGANIC');
                }

                // WATER CONTEXT
                var irrigation=signals['IRRIGATION'] || signals['IRRIGATION_TYPE'];

                if (irrigation) {
                  var irrigValue=String(irrigation.value || irrigation).toUpperCase();

                  if (irrigValue==='RAINFED'|| irrigValue==='NONE') {
                    context.waterAvailability='RAINFED';
                    context.contextTags.push('RAINFED');
                  }

                  else {
                    context.waterAvailability='IRRIGATED';
                    context.isIrrigated=true;
                    context.contextTags.push('IRRIGATED');
                  }
                }

                // RESIDUE CONTEXT
                var residue=signals['RESIDUE_RETENTION'] || signals['RESIDUE_AMOUNT'];

                if (residue && (residue.value==='HIGH'|| residue.value==='MODERATE')) {
                  context.hasResidue=true;
                  context.contextTags.push('HAS_RESIDUE');
                }

                // Add ALL tag (all questions match this)
                context.contextTags.push('ALL');

                console.log('[Context] Identified farm context:', context);
                return context;
              }

              /**
             * CALCULATE SIGNAL GAPS - Which high-value signals are missing?
             */
              function calculateSignalGaps() {
                var gaps= {
                  critical: [],
                  high: [],
                  medium: [],
                  low: []
                }

                ;

                // Define critical signals for each pathway
                var criticalSignals= {
                  'AWD': ['IRRIGATION_CONTROL', 'FLOODING_PATTERN', 'CROP'],
                  'RP': ['RESIDUE_RETENTION', 'TILLAGE_TYPE', 'SOC_MEASURED'],
                  'BIOCHAR': ['ORGANIC_AMENDMENT', 'RESIDUE_AVAILABLE', 'BIOCHAR_INTEREST'],
                  'ERW': ['SOIL_PH', 'SOIL_TEXTURE', 'RAINFALL_ANNUAL']
                }

                ;

                var currentSignals=CPOSL.qState.signals;

                // Check which critical signals are missing
                Object.keys(criticalSignals).forEach(function(pathway) {
                    criticalSignals[pathway].forEach(function(signal) {
                        if ( !currentSignals[signal]) {
                          gaps.critical.push( {
                              signal: signal,
                              pathway: pathway,
                              priority: 95
                            }

                          );
                        }
                      }

                    );
                  }

                );

                console.log('[Gaps] Signal gaps identified:', gaps.critical.length, 'critical gaps');
                return gaps;
              }

              /**
             * CALCULATE PATHWAY POTENTIAL SCORES based on current context
             */
              function calculatePathwayPotential(farmContext) {
                var scores= {
                  'AWD': 0,
                  'RP': 0,
                  'BIOCHAR': 0,
                  'ERW': 0
                }

                ;

                // AWD scoring
                if (farmContext.hasRice) scores['AWD'] +=50;
                if (farmContext.isIrrigated) scores['AWD'] +=30;
                if (farmContext.isClay) scores['AWD'] +=10;

                // RP scoring
                if (farmContext.hasResidue) scores['RP'] +=40;
                if (farmContext.managementStyle==='CONSERVATION') scores['RP'] +=30;
                if (farmContext.crops.length > 0) scores['RP'] +=20;

                // BIOCHAR scoring
                if (farmContext.hasResidue) scores['BIOCHAR'] +=35;
                if (farmContext.contextTags.indexOf('ORGANIC') >=0) scores['BIOCHAR'] +=25;
                scores['BIOCHAR'] +=30; // Base interest

                // ERW scoring
                if (farmContext.isClay) scores['ERW'] +=30;
                if (farmContext.isIrrigated) scores['ERW'] +=20;
                scores['ERW'] +=40; // Base potential

                console.log('[Pathway] Potential scores:', scores);
                return scores;
              }

              // INTELLIGENT QUESTION SCORING

              /**
             * CALCULATE QUESTION VALUE using native Q_Bank columns
             * @param {object} question - Question row from Q_Bank
             * @param {object} farmContext - Identified farm context
             * @param {object} signalGaps - Missing signals
             * @param {object} pathwayScores - Pathway potential scores
             * @returns {number} - Question value score (0-100)
             */
              function calculateQuestionValue(question, farmContext, signalGaps, pathwayScores) {
                var qid=question.Question_ID;
                var score=0;

                // 1. BASE PRIORITY (from sheet column - 45 to 70)
                var basePriority=toNum(question.Base_Priority) || 50;
                score=basePriority;

                // 2. MODE BONUS - Prefer BASIC in early rounds
                var mode=String(question.Mode || 'BASIC').toUpperCase();
                var currentRound=CPOSL.rounds.current;

                if (currentRound===1 && mode==='BASIC') {
                  score +=10; // Prefer basic questions in Round 1
                }

                else if (currentRound===2 && mode==='ADVANCED') {
                  score +=15; // Prefer advanced questions in Round 2
                }

                // 3. DOMAIN/GROUP RELEVANCE BONUS
                var domain=String(question.Domain || '').toUpperCase();
                var group=String(question.Group_Code || '').toUpperCase();

                // SOIL domain relevance
                if (domain==='SOIL') {
                  if (farmContext.isClay && group==='TEXTURE') score +=15;
                  if (farmContext.isSand && group==='TEXTURE') score +=15;
                  if (group==='CARBON') score +=10; // Always relevant
                }

                // CROP domain relevance
                if (domain==='CROP') {
                  if (farmContext.hasRice && qid.indexOf('RICE') >=0) score +=20;
                  if (farmContext.hasWheat && qid.indexOf('WHEAT') >=0) score +=20;
                  if (farmContext.crops.length > 0) score +=5; // Has crops
                }

                // MANAGEMENT domain relevance
                if (domain==='MANAGEMENT') {
                  if (farmContext.managementStyle==='CONSERVATION'&& group==='TILLAGE') score +=15;
                  if (farmContext.hasResidue && group==='RESIDUE') score +=15;
                  if (farmContext.contextTags.indexOf('ORGANIC') >=0 && group==='ORGANIC') score +=15;
                }

                // WATER/IRRIGATION relevance
                if (domain==='WATER'|| group==='IRRIGATION') {
                  if (farmContext.hasRice) score +=20; // Rice needs water questions
                  if (farmContext.isIrrigated) score +=10;
                }

                // 4. CONTEXT TEMPLATE CHECK - Does question have conditional trigger?
                var contextTemplate=String(question.Context_Template || '').trim();

                if (contextTemplate) {
                  // This is a follow-up question
                  // Check if the trigger condition is met
                  var isTriggerMet=checkContextTrigger(contextTemplate);

                  if (isTriggerMet) {
                    score +=25; // Big bonus for relevant follow-up
                  }

                  else {
                    score -=30; // Penalty if trigger not met
                  }
                }

                // 5. SIGNAL GAP BONUS - Does this question fill critical gaps?
                var derivRules=CPOSL.q.idx.qDerivByWhenQ.get(qid) || [];
                var fillsCriticalGap=false;

                derivRules.forEach(function(rule) {
                    var sigKey=rule.ThenSignalKey || rule.Then_Signal_Key || rule.SignalKey;

                    if (sigKey) {
                      signalGaps.critical.forEach(function(gap) {
                          if (gap.signal===sigKey) {
                            score +=30; // Big bonus for filling critical gap
                            fillsCriticalGap=true;
                          }
                        }

                      );
                    }
                  }

                );

                // 6. FACTOR CODE RELEVANCE
                var factorCode=String(question.Factor_Code || '').trim();

                if (factorCode) {
                  // Check if this factor is already filled
                  var factorsFilled=Object.keys(CPOSL.selections);
                  var factorNeeded=factorsFilled.length < 30; // Need more factors
                  if (factorNeeded) score +=10;
                }

                // 7. REQUIRED QUESTION BONUS
                if (question.Is_Required===true || question.Is_Required==='TRUE') {
                  score +=20; // High priority for required questions
                }

                // 8. ALREADY ANSWERED PENALTY (-1000 = exclude completely)
                if (CPOSL.qState.answered[qid]) {
                  return -1000;
                }

                // 9. SKIPPED BY INFERENCE PENALTY (-1000 = exclude completely)
                if (CPOSL.qState.skippedQuestions && CPOSL.qState.skippedQuestions[qid]) {
                  return -1000;
                }

                // 10. DOMAIN COVERAGE - Avoid asking too many from same domain in a row
                var recentDomains=getRecentDomains(5); // Last 5 questions

                var domainCount=recentDomains.filter(function(d) {
                    return d===domain;
                  }

                ).length;

                if (domainCount >=3) {
                  score -=15; // Penalty for domain repetition
                }

                return Math.max(0, score); // Never negative
              }

              /**
             * Check if context template trigger condition is met
             */
              function checkContextTrigger(template) {
                var lowerTemplate=template.toLowerCase();

                // Check for "You mentioned testing soil organic carbon"
                if (lowerTemplate.indexOf('testing soil organic carbon') >=0) {
                  return CPOSL.qState.answered['Q_S002'] && CPOSL.qState.answered['Q_S002'].Answer_Raw==='SOILTEST_YES';
                }

                // Check for rice-related triggers
                if (lowerTemplate.indexOf('rice') >=0 || lowerTemplate.indexOf('paddy') >=0) {
                  var signals=CPOSL.qState.signals;
                  return signals['CROP_RICE_DETECTED'] || (signals['MAIN_CROP'] && signals['MAIN_CROP'].value==='RICE');
                }

                // Check for irrigation-related triggers
                if (lowerTemplate.indexOf('irrigation') >=0) {
                  var signals=CPOSL.qState.signals;
                  return signals['IRRIGATION'] && signals['IRRIGATION'].value !=='NONE';
                }

                // Default: allow question
                return true;
              }

              /**
             * Get domains of recently asked questions
             */
              function getRecentDomains(count) {
                var recent=CPOSL.qState.history.slice(-count);
                var domains=[];

                recent.forEach(function(qid) {
                    var q=CPOSL.q.idx.qBankById.get(qid);

                    if (q && q.Domain) {
                      domains.push(String(q.Domain).toUpperCase());
                    }
                  }

                );

                return domains;
              }



              /**
             * Main question finder - Round-aware
             */
              function findNextQuestion(currentQid) {
                console.log('[Smart-Routing] Finding next question after:', currentQid);

                var currentRound=CPOSL.rounds.current;
                var answeredInRound=CPOSL.rounds.answered[currentRound] ? CPOSL.rounds.answered[currentRound].length : 0;
                var questionsPerRound=CPOSL.rounds.questionsPerRound;

                console.log('[Round] Current:', currentRound, '| Answered in round:', answeredInRound, '/', questionsPerRound);

                // Check if current round is complete
                if (answeredInRound >=questionsPerRound) {
                  if (currentRound < CPOSL.rounds.total) {
                    // Round complete, show transition
                    return null;
                  }

                  else {
                    // All rounds complete
                    return null;
                  }
                }

                // Apply inference rules to skip questions
                if (typeof applyInferenceRules==='function') {
                  applyInferenceRules();
                }

                // Get next question based on round strategy
                var roundConfig=CPOSL.rounds.config[currentRound];
                var nextQuestion=null;

                if (roundConfig.strategy==='DOMAIN_ROTATION') {
                  nextQuestion=getRound1Question();
                }

                else if (roundConfig.strategy==='SIGNAL_DRIVEN') {
                  nextQuestion=getRound2Question();
                }

                else if (roundConfig.strategy==='CONSISTENCY_CHECK') {
                  nextQuestion=getRound3Question();
                }

                console.log('[Round] Selected question:', nextQuestion);
                return nextQuestion;
              }



              /**
             * ROUND 1: BASIC overview using domain rotation + Base_Priority from sheet
             */
              function getRound1Question() {
                var config=CPOSL.rounds.config[1];
                var answeredInRound=CPOSL.rounds.answered[1].length;

                console.log('[Round 1] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('[Round 1] Finding question... Answered:', answeredInRound, '/ 15');

                // Count by domain
                var domainCounts= {}

                ;

                CPOSL.rounds.answered[1].forEach(function(qid) {
                    var q=CPOSL.q.idx.qBankById.get(qid);

                    if (q && q.Domain) {
                      var domain=String(q.Domain).toUpperCase();
                      domainCounts[domain]=(domainCounts[domain] || 0) + 1;
                    }
                  }

                );

                console.log('[Round 1] Domain counts:', domainCounts);

                // Find domain with fewest questions
                var targetDomain=null;
                var minCount=999;

                config.domains.forEach(function(domain) {
                    var count=domainCounts[domain] || 0;

                    if (count < config.maxPerDomain && count < minCount) {
                      minCount=count;
                      targetDomain=domain;
                    }
                  }

                );

                if ( !targetDomain) {
                  // All domains at max, pick any available domain
                  var availableDomains=Object.keys(domainCounts);

                  if (availableDomains.length > 0) {
                    targetDomain=availableDomains[0];
                  }

                  else {
                    targetDomain=config.domains[0];
                  }
                }

                console.log('[Round 1] Target domain:', targetDomain, '(current count:', domainCounts[targetDomain] || 0, ')');

                // Get all BASIC questions from target domain
                var candidates=Array.from(CPOSL.q.idx.qBankById.values()) .filter(function(q) {
                    return q.Is_Active !==false && !CPOSL.qState.answered[q.Question_ID] && ( !CPOSL.qState.skippedQuestions || !CPOSL.qState.skippedQuestions[q.Question_ID]) && String(q.Domain || '').toUpperCase()===targetDomain && String(q.Mode || 'BASIC').toUpperCase()==='BASIC'; // Prefer BASIC in Round 1
                  }

                );

                console.log('[Round 1] BASIC candidates in', targetDomain, ':', candidates.length);

                if (candidates.length===0) {
                  // No BASIC questions left, allow ADVANCED
                  console.log('[Round 1] No BASIC questions, trying ADVANCED...');

                  candidates=Array.from(CPOSL.q.idx.qBankById.values()) .filter(function(q) {
                      return q.Is_Active !==false && !CPOSL.qState.answered[q.Question_ID] && ( !CPOSL.qState.skippedQuestions || !CPOSL.qState.skippedQuestions[q.Question_ID]) && String(q.Domain || '').toUpperCase()===targetDomain;
                    }

                  );
                }

                if (candidates.length===0) {
                  // Try any domain
                  console.warn('[Round 1] No questions in target domain, trying ANY domain...');
                  return getAnyUnansweredQuestion();
                }

                // Sort by Base_Priority (highest first), then by Sequence
                candidates.sort(function(a, b) {
                    var priorityDiff=(toNum(b.Base_Priority) || 50) - (toNum(a.Base_Priority) || 50);
                    if (priorityDiff !==0) return priorityDiff;
                    return (a.Sequence || 999) - (b.Sequence || 999);
                  }

                );

                var selected=candidates[0];
                console.log('[Round 1] ‚úì SELECTED:', selected.Question_ID);
                console.log('[Round 1]   Domain:', selected.Domain, '| Mode:', selected.Mode, '| Priority:', selected.Base_Priority, '| Sequence:', selected.Sequence);
                console.log('[Round 1] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                return selected.Question_ID;
              }

              /**
             * ROUND 2: ADAPTIVE SELECTION using Q_Bank metadata + farm context
             */
              function getRound2Question() {
                console.log('[Round 2] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('[Round 2] Starting ADAPTIVE question selection...');

                // Step 1: Rebuild signals to ensure we have latest data
                console.log('[Round 2] Rebuilding signals from all answers...');

                if (typeof rebuildSignalsFromAllAnswers==='function') {
                  rebuildSignalsFromAllAnswers();
                }

                // Step 2: Apply signal mappings
                if (typeof applySignalMappings==='function') {
                  applySignalMappings();
                }

                // Step 3: Identify farm context from Round 1 answers
                var farmContext=identifyFarmContext();

                // Step 4: Calculate signal gaps
                var signalGaps=calculateSignalGaps();

                // Step 5: Calculate pathway potential scores
                var pathwayScores=calculatePathwayPotential(farmContext);

                console.log('[Round 2] Context summary:', {
                    crops: farmContext.crops.join(', ') || 'none',
                    soilTypes: farmContext.soilTypes.join(', ') || 'unknown',
                    management: farmContext.managementStyle,
                    water: farmContext.waterAvailability,
                    tags: farmContext.contextTags.length + ' tags'
                  }

                );

                // Step 6: Get all active, unanswered questions
                var allQuestions=Array.from(CPOSL.q.idx.qBankById.values()) .filter(function(q) {
                    return q.Is_Active !==false && !CPOSL.qState.answered[q.Question_ID] && ( !CPOSL.qState.skippedQuestions || !CPOSL.qState.skippedQuestions[q.Question_ID]);
                  }

                );

                console.log('[Round 2] Total candidates:', allQuestions.length);

                // Step 7: Score all questions
                var questionScores=[];

                allQuestions.forEach(function(q) {
                    var score=calculateQuestionValue(q, farmContext, signalGaps, pathwayScores);

                    if (score > 0) {

                      // Only include questions with positive scores
                      questionScores.push( {
                          qid: q.Question_ID,
                          score: score,
                          domain: q.Domain,
                          group: q.Group_Code,
                          mode: q.Mode,
                          priority: q.Base_Priority,
                          question: q
                        }

                      );
                    }
                  }

                );

                console.log('[Round 2] Positively scored candidates:', questionScores.length);

                // Step 8: Sort by score (highest first)
                questionScores.sort(function(a, b) {
                    return b.score - a.score;
                  }

                );

                // Step 9: Log top 10 candidates for debugging
                console.log('[Round 2] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                console.log('[Round 2] TOP 10 CANDIDATES:');

                questionScores.slice(0, 10).forEach(function(item, idx) {
                    console.log('[Round 2]   '+ (idx + 1) + '. '+ item.qid + ' | Score: '+ item.score.toFixed(1) + ' | Domain: '+ (item.domain || 'N/A') + ' | Group: '+ (item.group || 'N/A') + ' | Mode: '+ (item.mode || 'N/A') + ' | Priority: '+ (item.priority || 'N/A'));
                  }

                );
                console.log('[Round 2] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

                // Step 10: Return highest scoring question
                if (questionScores.length > 0) {
                  var selected=questionScores[0];
                  console.log('[Round 2] ‚úì SELECTED:', selected.qid, '(score:', selected.score.toFixed(1) + ')');
                  console.log('[Round 2] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                  return selected.qid;
                }

                // Fallback: If no questions scored positively, use domain rotation
                console.warn('[Round 2] ‚ö†Ô∏è No high-value questions found!');
                console.warn('[Round 2] Falling back to Round 1 strategy...');
                console.log('[Round 2] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                return getRound1Question();
              }

              /**
             * ROUND 3: VALIDATION & CONSISTENCY - Verify key answers
             */
              function getRound3Question() {
                console.log('[Round 3] Starting validation question selection...');

                // Build validation pairs if not done
                if (CPOSL.rounds.config[3].validationPairs.length===0) {
                  buildValidationPairs();
                }

                var pairs=CPOSL.rounds.config[3].validationPairs;

                // Find next unanswered validation question
                for (var i=0; i < pairs.length; i++) {
                  var pair=pairs[i];

                  if ( !CPOSL.qState.answered[pair.validationQuestionId]) {
                    console.log('[Round 3] ‚úì Validating:', pair.originalQuestionId, '‚Üí', pair.validationQuestionId);
                    return pair.validationQuestionId;
                  }
                }

                // All validations done - use adaptive selection for remaining slots
                console.log('[Round 3] All validations done, using adaptive selection...');

                // Reuse Round 2 adaptive logic
                var farmContext=identifyFarmContext();
                var signalGaps=calculateSignalGaps();
                var pathwayScores=calculatePathwayPotential(farmContext);

                var allQuestions=Array.from(CPOSL.q.idx.qBankById.values()) .filter(function(q) {
                    return q.Is_Active !==false && !CPOSL.qState.answered[q.Question_ID] && ( !CPOSL.qState.skippedQuestions || !CPOSL.qState.skippedQuestions[q.Question_ID]);
                  }

                );

                var questionScores=[];

                allQuestions.forEach(function(q) {
                    var score=calculateQuestionValue(q, farmContext, signalGaps, pathwayScores);

                    if (score > 0) {
                      questionScores.push( {
                          qid: q.Question_ID,
                          score: score
                        }

                      );
                    }
                  }

                );

                questionScores.sort(function(a, b) {
                    return b.score - a.score;
                  }

                );

                if (questionScores.length > 0) {
                  console.log('[Round 3] ‚úì Selected:', questionScores[0].qid, '(score:', questionScores[0].score.toFixed(1) + ')');
                  return questionScores[0].qid;
                }

                // Last resort fallback
                console.warn('[Round 3] Using fallback...');
                return getAnyUnansweredQuestion();
              }

              /**
             * Build validation pairs for Round 3
             */
              function buildValidationPairs() {
                var pairs=[];

                // Define validation pairs (original ‚Üí validation)
                var validationMap= {
                  'Q_S008': 'Q_S015', // Texture ‚Üí Drainage
                  'Q_S001': 'Q_S016', // Color ‚Üí Soil type
                  'Q_M040': 'Q_M042', // Organic use ‚Üí Type
                  'Q_M009': 'Q_M001', // Tillage type ‚Üí Passes
                  'Q_M015': 'Q_M016', // Irrigation ‚Üí Control
                  'Q_CR017': 'Q_CR019' // Residue ‚Üí Burning
                }

                ;

                Object.keys(validationMap).forEach(function(original) {
                    var validation=validationMap[original];

                    if (CPOSL.qState.answered[original] && CPOSL.q.idx.qBankById.has(validation)) {
                      pairs.push( {
                          originalQuestionId: original,
                          validationQuestionId: validation,
                          originalAnswer: CPOSL.qState.answered[original].Answer_Normalized
                        }

                      );
                    }
                  }

                );

                CPOSL.rounds.config[3].validationPairs=pairs;
                console.log('[Round 3] Built', pairs.length, 'validation pairs');
              }

              /**
             * Get next domain in rotation
             */
              function getNextDomain(currentDomain) {
                var rotation=['SOIL', 'CROP', 'MANAGEMENT', 'WATER', 'NUTRIENT', 'CLIMATE'];

                var currentIdx=rotation.indexOf(currentDomain);
                if (currentIdx < 0) return rotation[0];

                for (var i=1; i <=rotation.length; i++) {
                  var nextIdx=(currentIdx + i) % rotation.length;
                  var nextDomain=rotation[nextIdx];

                  if (getNextQuestionFromDomain(nextDomain)) {
                    return nextDomain;
                  }
                }

                return rotation[0];
              }



              /**
             * Get next unanswered question from domain (ENHANCED)
             */
              function getNextQuestionFromDomain(domain) {
                var allQuestions=Array.from(CPOSL.q.idx.qBankById.values()) .filter(function(q) {
                    return q.Is_Active !==false && extractDomain(q.Question_ID)===domain;
                  }

                ) .sort(function(a, b) {
                    return (a.Sequence || 999) - (b.Sequence || 999);
                  }

                );

                var totalInDomain=allQuestions.length;
                var answeredInDomain=0;
                var skippedInDomain=0;

                for (var i=0; i < allQuestions.length; i++) {
                  var q=allQuestions[i];

                  // Already answered?
                  if (CPOSL.qState.answered[q.Question_ID]) {
                    answeredInDomain++;
                    continue;
                  }

                  // Skipped by inference?
                  if (CPOSL.qState.skippedQuestions && CPOSL.qState.skippedQuestions[q.Question_ID]) {
                    skippedInDomain++;
                    continue;
                  }

                  // Available!
                  console.log('[Domain]', domain, '‚Üí Found:', q.Question_ID, '(total:', totalInDomain, ', answered:', answeredInDomain, ', skipped:', skippedInDomain, ')');
                  return q.Question_ID;
                }

                // Nothing available
                if (totalInDomain===0) {
                  console.log('[Domain]', domain, '‚Üí ‚ùå No questions in this domain at all!');
                }

                else {
                  console.log('[Domain]', domain, '‚Üí ‚ùå All questions used (total:', totalInDomain, ', answered:', answeredInDomain, ', skipped:', skippedInDomain, ')');
                }

                return null;
              }


              /**
             * Get any unanswered question (ENHANCED FALLBACK)
             */
              function getAnyUnansweredQuestion() {
                console.log('[Fallback] Searching for ANY unanswered question...');

                var allQuestions=Array.from(CPOSL.q.idx.qBankById.values()) .filter(function(q) {
                    return q.Is_Active !==false;
                  }

                ) .sort(function(a, b) {
                    return (a.Sequence || 999) - (b.Sequence || 999);
                  }

                );

                console.log('[Fallback] Total active questions in bank:', allQuestions.length);
                console.log('[Fallback] Already answered:', Object.keys(CPOSL.qState.answered).length);

                console.log('[Fallback] Skipped by inference:', Object.keys(CPOSL.qState.skippedQuestions || {}

                  ).length);

                for (var i=0; i < allQuestions.length; i++) {
                  var q=allQuestions[i];

                  if ( !CPOSL.qState.answered[q.Question_ID] && ( !CPOSL.qState.skippedQuestions || !CPOSL.qState.skippedQuestions[q.Question_ID])) {
                    console.log('[Fallback] ‚úì Found:', q.Question_ID, '(sequence:', q.Sequence, ')');
                    return q.Question_ID;
                  }
                }

                console.log('[Fallback] ‚ùå No unanswered questions found!');
                return null;
              }


              /**
             * HARDCODED FALLBACK RULES for missing derivation rules
             * These will be checked if no database rules match
             */
              var FALLBACK_DERIVATION_RULES= {
                'Q_S001': [ {
                  Is_Active: true,
                  WhenValue: 'COLOR_BLACK',
                  ThenSignalKey: 'SOIL_COLOR',
                  ThenSignalValue: 'BLACK',
                  ThenSignalScore: 1.0
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'COLOR_BROWN',
                  ThenSignalKey: 'SOIL_COLOR',
                  ThenSignalValue: 'BROWN',
                  ThenSignalScore: 1.0
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'COLOR_GREY',
                  ThenSignalKey: 'SOIL_COLOR',
                  ThenSignalValue: 'GREY',
                  ThenSignalScore: 1.0
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'COLOR_RED',
                  ThenSignalKey: 'SOIL_COLOR',
                  ThenSignalValue: 'REDDISH',
                  ThenSignalScore: 1.0
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'COLOR_YELLOW',
                  ThenSignalKey: 'SOIL_COLOR',
                  ThenSignalValue: 'YELLOWISH',
                  ThenSignalScore: 1.0
                }

                ],
                'Q_S002': [ {
                  Is_Active: true,
                  WhenValue: 'SOILTEST_YES',
                  ThenSignalKey: 'SOC_TESTED',
                  ThenSignalValue: 'YES',
                  ThenSignalScore: 1.0
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'SOILTEST_NO',
                  ThenSignalKey: 'SOC_TESTED',
                  ThenSignalValue: 'NO',
                  ThenSignalScore: 1.0
                }

                ],
                'Q_S008': [ {
                  Is_Active: true,
                  WhenValue: 'SOIL_CLAYEY',
                  ThenSignalKey: 'SOIL_TEXTURE',
                  ThenSignalValue: 'CLAYEY',
                  ThenSignalScore: 1.0
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'SOIL_SANDY',
                  ThenSignalKey: 'SOIL_TEXTURE',
                  ThenSignalValue: 'SANDY',
                  ThenSignalScore: 1.0
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'SOIL_LOAMY',
                  ThenSignalKey: 'SOIL_TEXTURE',
                  ThenSignalValue: 'LOAMY',
                  ThenSignalScore: 1.0
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'SOIL_BLACK',
                  ThenSignalKey: 'SOIL_TEXTURE',
                  ThenSignalValue: 'CLAYEY',
                  ThenSignalScore: 0.9
                }

                ],
                'Q_S011': [ {
                  Is_Active: true,
                  WhenValue: 'DRAIN_HOURS',
                  ThenSignalKey: 'DRAINAGE',
                  ThenSignalValue: 'GOOD',
                  ThenSignalScore: 0.8
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'DRAIN_DAYS',
                  ThenSignalKey: 'DRAINAGE',
                  ThenSignalValue: 'POOR',
                  ThenSignalScore: 0.8
                }

                ],
                'Q_S012': [ {
                  Is_Active: true,
                  WhenValue: 'PUDDLE_YES',
                  ThenSignalKey: 'DRAINAGE',
                  ThenSignalValue: 'POOR',
                  ThenSignalScore: 0.7
                }

                ,
                  {
                  Is_Active: true,
                  WhenValue: 'PUDDLE_NO',
                  ThenSignalKey: 'DRAINAGE',
                  ThenSignalValue: 'GOOD',
                  ThenSignalScore: 0.7
                }

                ]
              }

              ;

              /**
             * Normalize signal values to standard format
             * Maps variations (CLAY, CLAYEY, clay) ‚Üí canonical value
             */
              /**
             * SIGNAL VALUE NORMALIZATIONS - COMPREHENSIVE MAPPING
             * Maps all variant signal values from derivation rules ‚Üí canonical values expected by mappings
             * Based on CPOS_Q_Derivation_Rules and CPOS_Q_Signal_to_LiteFactor_Map sheets
             */
              var SIGNAL_VALUE_NORMALIZATIONS= {

                // SOIL TEXTURE VALUES
                // Derivation creates: CLAY, SAND, LOAM, SILT
                // Mapping expects: CLAYEY, SANDY, LOAMY, SILTY
                'CLAY': 'CLAYEY',
                'CLAYEY': 'CLAYEY', // Already canonical
                'SAND': 'SANDY',
                'SANDY': 'SANDY', // Already canonical
                'LOAM': 'LOAMY',
                'LOAMY': 'LOAMY', // Already canonical
                'SILT': 'SILTY',
                'SILTY': 'SILTY', // Already canonical

                // DRAINAGE VALUES
                // Derivation creates: POOR, GOOD, MODERATE
                // Mapping expects: POOR, WELL, VERY_POOR
                'GOOD': 'WELL',
                'WELL': 'WELL', // Already canonical
                'MODERATE': 'MODERATE', // Keep as is
                'POOR': 'POOR', // Already canonical
                'VERY_POOR': 'VERY_POOR', // Already canonical
                'EXCELLENT': 'WELL', // Alternative term
                'BAD': 'POOR', // Alternative term

                // SOIL COLOR VALUES
                // Derivation creates: BLACK, REDDISH, YELLOWISH, BROWN
                // Mapping may expect: BLACK, RED, YELLOW, BROWN
                'BLACK': 'BLACK',
                'BROWN': 'BROWN',
                'GREY': 'GREY',
                'GRAY': 'GREY', // US spelling
                'RED': 'RED',
                'REDDISH': 'RED', // Variant
                'YELLOW': 'YELLOW',
                'YELLOWISH': 'YELLOW', // Variant

                // YES/NO BOOLEAN VALUES
                'YES': 'YES',
                'NO': 'NO',
                'TRUE': 'YES',
                'FALSE': 'NO',
                '1': 'YES',
                '0': 'NO',

                // TILLAGE/DISTURBANCE VALUES
                // Common variations
                'NO_TILL': 'NONE',
                'NOTILL': 'NONE',
                'ZERO': 'NONE',
                'NONE': 'NONE',

                'REDUCED': 'LOW',
                'MINIMUM': 'LOW',
                'LOW': 'LOW',

                'CONVENTIONAL': 'HIGH',
                'INTENSIVE': 'HIGH',
                'HIGH': 'HIGH',

                'MODERATE': 'MODERATE',
                'MEDIUM': 'MODERATE',

                // CROP TYPE VALUES
                'RICE': 'RICE',
                'PADDY': 'RICE', // Alternative term
                'WHEAT': 'WHEAT',
                'MAIZE': 'MAIZE',
                'CORN': 'MAIZE', // US term
                'SOYBEAN': 'SOYBEAN',
                'SOYA': 'SOYBEAN', // Alternative
                'COTTON': 'COTTON',
                'SUGARCANE': 'SUGARCANE',
                'VEGETABLES': 'VEGETABLES',

                // SOIL pH VALUES
                'ACIDIC': 'LOW',
                'ACID': 'LOW',
                'LOW': 'LOW',

                'NEUTRAL': 'NEUTRAL',
                'MEDIUM': 'NEUTRAL',

                'ALKALINE': 'HIGH',
                'BASIC': 'HIGH',
                'HIGH': 'HIGH',

                // RESIDUE MANAGEMENT
                'REMOVED': 'LOW',
                'PARTIAL': 'MODERATE',
                'RETAINED': 'HIGH',
                'INCORPORATED': 'MODERATE',
                'MULCH': 'HIGH',

                // WATER MANAGEMENT (AWD)
                'CONTINUOUS': 'FLOOD_CONT',
                'FLOOD_CONT': 'FLOOD_CONT',
                'INTERMITTENT': 'FLOOD_INT',
                'FLOOD_INT': 'FLOOD_INT',
                'AWD': 'FLOOD_INT',
                'AEROBIC': 'AEROBIC',
                'RAINFED': 'RAINFED',

                // IRRIGATION TYPE
                'FLOOD': 'FLOOD',
                'FLOODING': 'FLOOD',
                'DRIP': 'DRIP',
                'SPRINKLER': 'SPRINKLER',
                'FURROW': 'FURROW',
                'NONE': 'RAINFED',
                'RAINFED': 'RAINFED',

                // ORGANIC AMENDMENTS
                'FYM': 'FYM',
                'FARMYARD': 'FYM',
                'MANURE': 'FYM',
                'COMPOST': 'COMPOST',
                'BIOCHAR': 'BIOCHAR',
                'GREEN_MANURE': 'GREEN_MANURE',
                'CROP_RESIDUE': 'RESIDUE',

                // COMPACTION RISK
                'COMPACT': 'HIGH',
                'COMPACTED': 'HIGH',
                'LOOSE': 'LOW',
                'NORMAL': 'MODERATE',

                // SLOPE/TOPOGRAPHY
                'FLAT': 'FLAT',
                'LEVEL': 'FLAT',
                'GENTLE': 'LOW',
                'SLOPING': 'MODERATE',
                'STEEP': 'HIGH',

                // SOIL ORGANIC CARBON LEVELS
                'VERY_LOW': 'VERY_LOW',
                'LOW': 'LOW',
                'MEDIUM': 'MEDIUM',
                'MODERATE': 'MEDIUM',
                'HIGH': 'HIGH',
                'VERY_HIGH': 'VERY_HIGH',

                // PRACTICE ADOPTION STATUS
                'ADOPTED': 'YES',
                'NOT_ADOPTED': 'NO',
                'PRACTICING': 'YES',
                'NOT_PRACTICING': 'NO',

                // MRV TIER VALUES
                'BASIC': 'BASIC',
                'STANDARD': 'STANDARD',
                'ADVANCED': 'ADVANCED',
                'PREMIUM': 'ADVANCED',
                'N/A': 'N/A',
                'UNKNOWN': 'N/A'
              }

              ;

              function normalizeSignalValues() {
                console.log('[Normalize-Values] Normalizing signal values...');

                Object.keys(CPOSL.qState.signals).forEach(function(signalKey) {
                    var signal=CPOSL.qState.signals[signalKey];
                    var currentValue=signal.value;
                    var normalizedValue=SIGNAL_VALUE_NORMALIZATIONS[currentValue];

                    if (normalizedValue && normalizedValue !==currentValue) {
                      signal.value=normalizedValue;
                      console.log('[Normalize-Values] ‚úì', signalKey, ':', currentValue, '‚Üí', normalizedValue);
                    }
                  }

                );
              }

              function applyDerivationsForQuestion(qid, answerRaw) {
                // Get database rules
                var dbRules=CPOSL.q.idx.qDerivByWhenQ.get(qid) || [];

                // Get fallback rules
                var fallbackRules=FALLBACK_DERIVATION_RULES[qid] || [];

                // Merge: database rules first, then fallback
                var allRules=dbRules.concat(fallbackRules);

                console.log('[Deriv] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('[Deriv] Processing question:', qid);
                console.log('[Deriv] Answer given:', answerRaw);
                console.log('[Deriv] Rules found:', allRules.length, '(DB:'+ dbRules.length + ', Fallback:'+ fallbackRules.length + ')');

                if (allRules.length===0) {
                  console.log('[Deriv] ‚ö†Ô∏è No rules for this question!');
                  return;
                }

                allRules.forEach(function(rule, idx) {
                    var active=toBool(rule.Is_Active !==undefined ? rule.Is_Active : rule.IsActive);

                    if (active===false) {
                      console.log('[Deriv] Rule '+ idx + ': SKIPPED (inactive)');
                      return;
                    }

                    var op=String(rule.WhenOperator || rule.When_Operator || 'EQUALS').toUpperCase();
                    var whenVal=String(rule.WhenValue || rule.When_Value || '');
                    var signalKey=String(rule.ThenSignalKey || rule.Then_Signal_Key || rule.SignalKey || '');
                    var signalVal=String(rule.ThenSignalValue || rule.Then_Signal_Value || '');
                    var conf=toNum(rule.ThenSignalScore || rule.Then_Signal_Score || rule.Confidence_0_1) || 1.0;

                    if ( !signalKey) {
                      console.warn('[Deriv] Rule '+ idx + ': ‚ùå No signal key!');
                      return;
                    }

                    var matches=false;
                    var ans=String(answerRaw).trim();

                    if (op==='EQUALS'|| op==='=') {
                      matches=ans===whenVal;
                    }

                    else if (op==='!='|| op==='NOT_EQUALS') {
                      matches=ans !==whenVal;
                    }

                    else if (op==='CONTAINS'|| op==='IN') {
                      matches=ans.toLowerCase().indexOf(whenVal.toLowerCase()) >=0;
                    }

                    else if (op==='>') {
                      matches=toNum(ans) > toNum(whenVal);
                    }

                    else if (op==='>=') {
                      matches=toNum(ans) >=toNum(whenVal);
                    }

                    else if (op==='<') {
                      matches=toNum(ans) < toNum(whenVal);
                    }

                    else if (op==='<=') {
                      matches=toNum(ans) <=toNum(whenVal);
                    }

                    else if (op==='') {
                      matches=true;
                    }

                    if (matches) {
                      console.log('[Deriv] Rule '+ idx + ': ‚úì MATCH "'+ ans + '" = "'+ whenVal + '"');

                      var existing=CPOSL.qState.signals[signalKey];

                      if ( !existing || conf > (existing.confidence || 0)) {
                        CPOSL.qState.signals[signalKey]= {
                          value: signalVal,
                          confidence: conf,
                          sourceQ: qid
                        }

                        ;
                        console.log('[Deriv]   ‚úì‚úì SIGNAL CREATED:', signalKey, '=', signalVal);
                      }

                      else {
                        console.log('[Deriv]   ‚ö†Ô∏è Signal exists with higher confidence');
                      }
                    }

                    else {
                      console.log('[Deriv] Rule '+ idx + ': ‚úó no match "'+ ans + '" ‚â† "'+ whenVal + '"');
                    }
                  }

                );

                console.log('[Deriv] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
              }


              function applyRoutingForQuestion(qid, answerRaw) {
                var rules=CPOSL.q.idx.qRoutesByCurrentQ.get(qid) || [];

                rules.forEach(function(rule) {
                    var active=toBool(getField(rule, ['Is_Active', 'IsActive'], true));
                    if ( !active) return;

                    var sigKey=getField(rule, ['Condition_Signal_Key', 'ConditionSignalKey']);
                    var op=String(getField(rule, ['Condition_Operator', 'ConditionOperator'], '')).toUpperCase();
                    var condVal=getField(rule, ['Condition_Value', 'ConditionValue']);
                    var nextQ=getField(rule, ['Next_Question_ID', 'NextQuestionID']);
                    var action=String(getField(rule, ['Route_Action', 'RouteAction'], 'ASK')).toUpperCase();

                    var matches=false;

                    if (sigKey && sigKey !=='ANY') {
                      var signal=CPOSL.qState.signals[sigKey];
                      if ( !signal) return;
                      var sigVal=String(signal.value || '');

                      if (op==='EQUALS'|| op==='=') matches=sigVal===condVal;
                      else if (op==='!=') matches=sigVal !==condVal;
                      else if (op==='CONTAINS') matches=sigVal.toLowerCase().indexOf(condVal.toLowerCase()) >=0;
                    }

                    else {
                      matches=true;
                    }

                    if ( !matches) return;

                    if (action==='ASK'&& nextQ) {
                      if ( !CPOSL.qState.answered[nextQ] && ( !CPOSL.qState.queue || CPOSL.qState.queue.indexOf(nextQ) < 0)) {
                        if ( !CPOSL.qState.queue) CPOSL.qState.queue=[];
                        CPOSL.qState.queue.push(nextQ);
                      }
                    }

                    else if (action==='SKIP_TO'&& nextQ) {
                      CPOSL.qState.queue=[nextQ];
                    }

                    else if (action==='END') {
                      CPOSL.qState.stop=true;
                    }
                  }

                );
              }

              /**
             * Debug: Check question bank distribution
             */
              function debugQuestionBank() {
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('QUESTION BANK ANALYSIS');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                var bankSize=CPOSL.q.idx.qBankById.size;
                console.log('Total questions in bank:', bankSize);

                if (bankSize===0) {
                  console.error('‚ùå QUESTION BANK IS EMPTY!');
                  console.log('Check if getCPOSQuestionnaireConfig() is loading data correctly');
                  return;
                }

                // Analyze by domain
                var byDomain= {}

                ;
                var sampleQuestions=[];

                Array.from(CPOSL.q.idx.qBankById.values()).forEach(function(q) {
                    var domain=extractDomain(q.Question_ID);
                    byDomain[domain]=(byDomain[domain] || 0) + 1;

                    if (sampleQuestions.length < 10) {
                      sampleQuestions.push( {
                          ID: q.Question_ID,
                          Domain: domain,
                          Active: q.Is_Active !==false,
                          Sequence: q.Sequence
                        }

                      );
                    }
                  }

                );

                console.log('\nQuestions by domain:');
                console.table(byDomain);

                console.log('\nSample questions:');
                console.table(sampleQuestions);

                console.log('\nCurrent state:');
                console.log('  Answered:', Object.keys(CPOSL.qState.answered).length);

                console.log('  Skipped:', Object.keys(CPOSL.qState.skippedQuestions || {}

                  ).length);
                console.log('  Current round:', CPOSL.rounds.current);
                console.log('  Answered in round 1:', CPOSL.rounds.answered[1].length);

                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
              }

              // COMPOSITE SIGNALS & INFERENCE RULES (FIX 3 & FIX 4)

              /**
             * FIX 3: Compute composite signals requiring multiple conditions
             * @param {Object} signals - Current signals object
             * @returns {Object} - Updated signals with composite signals
             */
              function computeCompositeSignals(signals) {

                // INF072: CONSERVATION_TILLAGE_PLUS_RESIDUE
                if (signals.CONSERVATION_TILLAGE && signals.CONSERVATION_TILLAGE.value==='YES'&& signals.RESIDUE_RETENTION && signals.RESIDUE_RETENTION.value==='HIGH') {
                  signals.CONSERVATION_TILLAGE_PLUS_RESIDUE= {
                    value: 'YES',
                    score: 1,
                    source: 'composite',
                    confidence: Math.min(signals.CONSERVATION_TILLAGE.confidence || 0.8,
                      signals.RESIDUE_RETENTION.confidence || 0.8)
                  }

                  ;
                }

                // INF073: ZERO_TILL_PLUS_COVER
                if (signals.TILLAGE_TYPE && signals.TILLAGE_TYPE.value==='ZERO_TILL'&& signals.COVER_CROPS && signals.COVER_CROPS.value==='YES') {
                  signals.ZERO_TILL_PLUS_COVER= {
                    value: 'YES',
                    score: 1,
                    source: 'composite',
                    confidence: Math.min(signals.TILLAGE_TYPE.confidence || 0.8,
                      signals.COVER_CROPS.confidence || 0.8)
                  }

                  ;
                }

                // INF074: HEAVY_MACHINERY_WET_SOIL
                if (signals.HEAVY_MACHINERY && signals.HEAVY_MACHINERY.value==='YES'&& signals.WET_SOIL_WORK && signals.WET_SOIL_WORK.value==='YES') {
                  signals.HEAVY_MACHINERY_WET_SOIL= {
                    value: 'YES',
                    score: 1,
                    source: 'composite',
                    confidence: Math.min(signals.HEAVY_MACHINERY.confidence || 0.7,
                      signals.WET_SOIL_WORK.confidence || 0.7)
                  }

                  ;
                }

                // INF075: RESIDUE_BURNING_PLUS_CONV_TILL
                if (signals.RESIDUE_BURNING && signals.RESIDUE_BURNING.value==='YES_ALWAYS'&& signals.TILLAGE_TYPE && signals.TILLAGE_TYPE.value==='CONVENTIONAL') {
                  signals.RESIDUE_BURNING_PLUS_CONV_TILL= {
                    value: 'YES',
                    score: 1,
                    source: 'composite',
                    confidence: Math.min(signals.RESIDUE_BURNING.confidence || 0.9,
                      signals.TILLAGE_TYPE.confidence || 0.9)
                  }

                  ;
                }

                return signals;
              }

              /**
             * FIX 4: Evaluate inference rule conditions with numeric and categorical support
             * @param {string} signal - Signal name
             * @param {string} operator - Comparison operator
             * @param {string|number} value - Value to compare
             * @returns {boolean}
             */
              function evaluateInferenceCondition(signal, operator, value) {
                var signalData=CPOSL.qState.signals[signal];

                // Signal doesn't exist
                if ( !signalData) return false;

                var signalValue=signalData.value;

                // Handle different operators
                switch (operator) {
                  case 'EQUALS': return signalValue===value;

                  case 'NOT_EQUALS': return signalValue !==value;

                  case 'CONTAINS': if (Array.isArray(signalValue)) {
                    return signalValue.indexOf(value) !==-1;
                  }

                  return String(signalValue).indexOf(String(value)) !==-1;

                  case 'LESS': case 'GREATER': return evaluateNumericOrCategorical(signalValue, operator, value);

                  case 'BETWEEN': var parts=String(value).split(',');
                  var min=parseFloat(parts[0]);
                  var max=parseFloat(parts[1]);
                  var numVal=parseFloat(signalValue);

                  if ( !isNaN(numVal) && !isNaN(min) && !isNaN(max)) {
                    return numVal >=min && numVal <=max;
                  }

                  return false;

                  default: console.warn('Unknown operator:', operator);
                  return false;
                }
              }

              /**
             * Handle numeric comparison with categorical fallback
             * @param {*} signalValue - Signal value (numeric or categorical)
             * @param {string} operator - 'LESS' or 'GREATER'
             * @param {*} threshold - Comparison threshold
             * @returns {boolean}
             */
              function evaluateNumericOrCategorical(signalValue, operator, threshold) {
                // Try numeric comparison first
                var numSignal=parseFloat(signalValue);
                var numThreshold=parseFloat(threshold);

                if ( !isNaN(numSignal) && !isNaN(numThreshold)) {
                  if (operator==='LESS') return numSignal < numThreshold;
                  if (operator==='GREATER') return numSignal > numThreshold;
                }

                // Categorical mapping for ordinal comparison
                var categoricalMap= {
                  'VERY_LOW': 0,
                  'LOW': 1,
                  'MEDIUM': 2,
                  'MODERATE': 2,
                  'HIGH': 3,
                  'VERY_HIGH': 4,
                  'EXCESSIVE': 5,
                  'NEVER': 0,
                  'RARE': 1,
                  'RARELY': 1,
                  'SOMETIMES': 2,
                  'OFTEN': 3,
                  'ALWAYS': 4,
                  'FREQUENT': 3,
                  'FLAT': 0,
                  'GENTLE': 1,
                  'STEEP': 3,
                  'VERY_STEEP': 4,
                  'SHORT': 0,
                  'LONG': 2,
                  'VERY_LONG': 3,
                  'POOR': 0,
                  'GOOD': 3,
                  'EXCELLENT': 4,
                  'NONE': 0,
                  'PARTIAL': 1,
                  'FULL': 2,
                  'YES': 1,
                  'NO': 0
                }

                ;

                var catSignal=categoricalMap[String(signalValue).toUpperCase()];
                var catThreshold=categoricalMap[String(threshold).toUpperCase()];

                if (catSignal !==undefined && catThreshold !==undefined) {
                  if (operator==='LESS') return catSignal < catThreshold;
                  if (operator==='GREATER') return catSignal > catThreshold;
                }

                console.warn('Cannot compare', signalValue, operator, threshold);
                return false;
              }

              /**
             * Apply inference rules to skip questions and infer new signals
             * Called after signal derivation and composite signal computation
             */
              function applyInferenceRules() {

                // Initialize skipped questions tracker if not exists
                if ( !CPOSL.qState.skippedQuestions) {
                  CPOSL.qState.skippedQuestions= {}

                  ;
                }

                // Load inference rules from your data
                // For now, using hardcoded rules matching your CPOS_Inference_Rules.tsv
                var inferenceRules=[ // üî¥ NEW: INF_SOILTEST_01 - If soil NOT tested, skip SOC value questions

                  {
                  Inference_ID: 'INF_SOILTEST_01',
                  Is_Active: true,
                  Priority: 10,
                  Trigger_Signal: 'SOC_TESTED',
                  Trigger_Operator: 'EQUALS',
                  Trigger_Value: 'NO',
                  Skip_Questions: 'Q_S003,Q_S004',
                  Infer_Signal: 'SOC_MEASURED',
                  Infer_Value: 'NOT_AVAILABLE',
                  Confidence_0_1: 0.98
                }

                ,
                // INF009: Burning = zero retention
                  {
                  Inference_ID: 'INF009',
                  Is_Active: true,
                  Priority: 10,
                  Trigger_Signal: 'RESIDUE_BURNING',
                  Trigger_Operator: 'EQUALS',
                  Trigger_Value: 'YES_ALWAYS',
                  Skip_Questions: 'Q_CR022,Q_CR023',
                  Infer_Signal: 'RESIDUE_RETAINED',
                  Infer_Value: 'NONE',
                  Confidence_0_1: 0.95
                }

                ,
                // INF015: Zero-till = 0 passes
                  {
                  Inference_ID: 'INF015',
                  Is_Active: true,
                  Priority: 10,
                  Trigger_Signal: 'TILLAGE_TYPE',
                  Trigger_Operator: 'EQUALS',
                  Trigger_Value: 'ZERO_TILL',
                  Skip_Questions: 'Q_M001,Q_M009,Q_M012,Q_M013',
                  Infer_Signal: 'TILLAGE_PASSES',
                  Infer_Value: '0',
                  Confidence_0_1: 0.98
                }

                ,
                // INF026: Low rainfall = irrigation needed
                  {
                  Inference_ID: 'INF026',
                  Is_Active: true,
                  Priority: 10,
                  Trigger_Signal: 'RAINFALL_ANNUAL',
                  Trigger_Operator: 'LESS',
                  Trigger_Value: '600',
                  Skip_Questions: 'Q_C010',
                  Infer_Signal: 'IRRIGATION_REQUIRED',
                  Infer_Value: 'YES',
                  Confidence_0_1: 0.95
                }

                ,
                // INF029: No organic = skip quantity questions
                  {
                  Inference_ID: 'INF029',
                  Is_Active: true,
                  Priority: 10,
                  Trigger_Signal: 'ORGANIC_AMENDMENT',
                  Trigger_Operator: 'EQUALS',
                  Trigger_Value: 'NO',
                  Skip_Questions: 'Q_M042,Q_M043,Q_M044,Q_M045,Q_M046',
                  Infer_Signal: 'ORGANIC_APPLICATION',
                  Infer_Value: 'ZERO',
                  Confidence_0_1: 0.98
                }

                ,
                // INF033: Sandy soil = low water holding
                  {
                  Inference_ID: 'INF033',
                  Is_Active: true,
                  Priority: 9,
                  Trigger_Signal: 'SOIL_TEXTURE',
                  Trigger_Operator: 'EQUALS',
                  Trigger_Value: 'SANDY',
                  Skip_Questions: 'Q_S007,Q_S011',
                  Infer_Signal: 'WATER_HOLDING',
                  Infer_Value: 'LOW',
                  Confidence_0_1: 0.9
                }

                ];

                inferenceRules.forEach(function(rule) {
                    if ( !rule.Is_Active) return;

                    // Evaluate condition
                    var conditionMet=evaluateInferenceCondition(rule.Trigger_Signal,
                      rule.Trigger_Operator,
                      rule.Trigger_Value);

                    if ( !conditionMet) return;

                    // Skip questions
                    if (rule.Skip_Questions) {
                      var questionsToSkip=rule.Skip_Questions.split(',').map(function(q) {
                          return q.trim();
                        }

                      );

                      questionsToSkip.forEach(function(qId) {
                          CPOSL.qState.skippedQuestions[qId]= {
                            reason: rule.Infer_Signal,
                            confidence: rule.Confidence_0_1,
                            ruleId: rule.Inference_ID
                          }

                          ;
                          console.log('[Inference] ‚úì Skipping', qId, '- triggered by', rule.Trigger_Signal, '=', rule.Trigger_Value);
                        }

                      );
                    }

                    // Infer new signal
                    if (rule.Infer_Signal && rule.Infer_Value) {
                      var existing=CPOSL.qState.signals[rule.Infer_Signal];

                      // Only infer if signal doesn't exist or has lower confidence
                      if ( !existing || (rule.Confidence_0_1 > (existing.confidence || 0))) {
                        CPOSL.qState.signals[rule.Infer_Signal]= {
                          value: rule.Infer_Value,
                          score: 1,
                          source: 'inference',
                          confidence: rule.Confidence_0_1,
                          triggeredBy: rule.Trigger_Signal,
                          ruleId: rule.Inference_ID
                        }

                        ;
                        console.log('[Inference] ‚úì Created signal:', rule.Infer_Signal, '=', rule.Infer_Value);
                      }
                    }
                  }

                );

                console.log('[Inference] Applied', inferenceRules.length, 'rules | Skipped', Object.keys(CPOSL.qState.skippedQuestions).length, 'questions');
              }

              // END OF FIX 3 & FIX 4


              function rebuildSignalsFromAllAnswers() {
                console.log('[Rebuild] Starting signal rebuild...');

                // 1. Clear all signals
                CPOSL.qState.signals= {}

                ;

                // 2. Rebuild basic signals from all answered questions
                var answeredQuestions=Object.keys(CPOSL.qState.answered);
                console.log('[Rebuild] Processing', answeredQuestions.length, 'answered questions');

                answeredQuestions.forEach(function(qid) {
                    var ans=CPOSL.qState.answered[qid];

                    if (ans && ans.Answer_Normalized !=='SKIPPED') {
                      applyDerivationsForQuestion(qid, ans.Answer_Raw || ans.Answer_Normalized);
                    }
                  }

                );

                console.log('[Rebuild] After derivations, signals created:', Object.keys(CPOSL.qState.signals).length);

                // 3. Compute composite signals
                CPOSL.qState.signals=computeCompositeSignals(CPOSL.qState.signals);

                // 4. Normalize signal KEYS (aliases: SOIL_TEXTURE ‚Üí TEXTURE_PROXY)
                console.log('[Rebuild] Running normalizeSignalKeys...');

                if (typeof normalizeSignalKeys==='function') {
                  normalizeSignalKeys();
                }

                // üî¥ 5. NORMALIZE SIGNAL VALUES (CLAY ‚Üí CLAYEY)
                console.log('[Rebuild] Running normalizeSignalValues...');

                if (typeof normalizeSignalValues==='function') {
                  normalizeSignalValues();
                }

                // 6. Apply inference rules
                console.log('[Rebuild] Running applyInferenceRules...');
                applyInferenceRules();

                console.log('[Rebuild] Final signal count:', Object.keys(CPOSL.qState.signals).length);
                console.log('Signals rebuilt:', Object.keys(CPOSL.qState.signals).length, 'signals created');
              }

              // EVALUATION & RESULTS

              function evaluateAndGo() {
                var sels=CPOSL.selections;

                if (Object.keys(sels).length===0) {
                  alert('Please select at least one factor.');
                  return;
                }

                setStatus(false, 'Evaluating...');

                gsRun('evaluateCPOS_Lite_v1', sels, {
                    signals: CPOSL.qState.signals
                  }

                ) .then(function(result) {
                    console.log('[CPOS] Evaluation result:', result);
                    CPOSL.lastResults=result;
                    renderResults(result);
                    goStep(2);
                    setStatus(true, 'Evaluation complete');
                  }

                ) .catch(function(err) {
                    console.error('[CPOS] Evaluation failed:', err);
                    setStatus(false, 'Evaluation failed: '+ (err && err.message ? err.message : err));
                  }

                );
              }

              function renderResults(result) {
                var grid=document.getElementById('screeningGrid');
                var recap=document.getElementById('selectionRecap');

                if ( !grid) return;
                grid.innerHTML='';

                var pathClasses= {
                  'RP-SOC': 'path-rp',
                  'AWD-CH‚ÇÑ': 'path-awd',
                  'BIOCHAR': 'path-bio',
                  'ERW': 'path-erw'
                }

                ;

                var results=(result && result.results) ? result.results : {}

                ;

                CPOSL.PATHWAYS.forEach(function(pw) {
                    var r=results[pw] || {}

                    ;
                    var card=document.createElement('div');
                    card.className='pathCard '+ (pathClasses[pw] || '');

                    var eligClass=r.eligibility==='YES'? 'ok' : (r.eligibility==='NO'? 'bad' : 'warn');
                    var prioClass=r.priority==='HIGH'? 'ok' : (r.priority==='LOW'? 'warn' : '');

                    var reasonsHtml='';

                    if (r.reasons && r.reasons.length) {
                      reasonsHtml='<ul class="list">';

                      r.reasons.forEach(function(x) {
                          reasonsHtml +='<li>'+ escapeHtml(x) + '</li>';
                        }

                      );
                      reasonsHtml +='</ul>';
                    }

                    card.innerHTML='<div class="pathTop">'+ '<h4 class="pathName">'+ escapeHtml(pw) + '</h4>'+ '<div class="pathMeta">'+ '<span class="pill '+ eligClass + '">'+ escapeHtml(r.eligibility || 'N/A') + '</span>'+ '<span class="pill '+ prioClass + '">'+ escapeHtml(r.priority || 'N/A') + '</span>'+ '</div>'+ '</div>'+ '<div class="small">'+ escapeHtml(r.final_text || '') + '</div>'+ reasonsHtml;
                    grid.appendChild(card);
                  }

                );

                if (recap) {
                  recap.innerHTML='';

                  // ‚úÖ FIX: Handle both object and string selections
                  var selectionsToDisplay=result.selections || CPOSL.selections || {}

                  ;

                  Object.keys(selectionsToDisplay).forEach(function(k) {
                      var selection=selectionsToDisplay[k];

                      // Extract value from object or use string directly
                      var displayValue='';

                      if (typeof selection==='object'&& selection !==null && selection.value !==undefined) {
                        displayValue=selection.value;
                      }

                      else if (typeof selection==='string') {
                        displayValue=selection;
                      }

                      if (displayValue) {
                        var chip=document.createElement('div');
                        chip.className='chip';

                        // Add badge if auto-filled
                        var badge='';

                        if (selection && selection.auto) {
                          badge=' <span style="background:#4caf50;color:white;padding:1px 4px;border-radius:3px;font-size:0.75em;margin-left:4px;">AUTO</span>';
                        }

                        chip.innerHTML='<span class="k">'+ escapeHtml(k) + '</span> <span>'+ escapeHtml(displayValue) + badge + '</span>';
                        recap.appendChild(chip);
                      }
                    }

                  );
                }

                updateSummaryPanel(results);
              }

              function updateSummaryPanel(results) {
                var recStack=document.getElementById('recStack');
                var condStack=document.getElementById('condStack');
                var exclStack=document.getElementById('exclStack');
                var headline=document.getElementById('headlineBox');

                if (recStack) recStack.innerHTML='';
                if (condStack) condStack.innerHTML='';
                if (exclStack) exclStack.innerHTML='';

                var rec=[],
                cond=[],
                excl=[];

                CPOSL.PATHWAYS.forEach(function(pw) {
                    var r=results[pw] || {}

                    ;
                    if (r.eligibility==='YES'&& r.priority==='HIGH') rec.push(pw);
                    else if (r.eligibility==='YES'|| r.eligibility==='CONDITIONAL') cond.push(pw);
                    else excl.push(pw);
                  }

                );

                rec.forEach(function(pw) {
                    if (recStack) recStack.innerHTML +='<span class="pill ok">'+ escapeHtml(pw) + '</span> ';
                  }

                );

                cond.forEach(function(pw) {
                    if (condStack) condStack.innerHTML +='<span class="pill warn">'+ escapeHtml(pw) + '</span> ';
                  }

                );

                excl.forEach(function(pw) {
                    if (exclStack) exclStack.innerHTML +='<span class="pill bad">'+ escapeHtml(pw) + '</span> ';
                  }

                );

                if (headline) {
                  headline.textContent=rec.length > 0 ? 'Recommended: '+ rec.join(', ') : 'No pathways strongly recommended. Consider conditional options.';
                }
              }

              // SAVE ASSESSMENT
              function saveAssessment() {
                console.log('[Save] Saving assessment...');

                // Calculate duration
                var durationMinutes=0;

                if (CPOSL.qState.startedAt) {
                  var startTime=new Date(CPOSL.qState.startedAt);
                  var endTime=new Date();
                  durationMinutes=Math.round((endTime - startTime) / 1000 / 60); // Convert ms to minutes
                }

                // Calculate session metadata
                var sessionId=CPOSL.qState.sessionId || ('SES-'+ Date.now());
                var answeredCount=Object.keys(CPOSL.qState.answered).length;
                var signalsCount=Object.keys(CPOSL.qState.signals).length;
                var factorCount=Object.keys(CPOSL.selections).length;

                // Build session payload (14 fields)
                var sessionPayload= {
                  Session_ID: sessionId,
                  Created_At: CPOSL.qState.startedAt || new Date().toISOString(),
                  Client_ID: 'Default',
                  Site_ID: '',
                  Language: CPOSL.language || 'EN',
                  Mode: CPOSL.qState.mode || 'BASIC',
                  Answered_Count: answeredCount,
                  Signals_Derived_Count: signalsCount,
                  Duration_Minutes: durationMinutes, // ‚Üê NOW CALCULATED!

                  Quality_Score: Math.min(100, (signalsCount * 8) + (factorCount * 10)),
                  Summary: {
                    questions: answeredCount,
                    signals: signalsCount,
                    factors: factorCount,
                    duration_minutes: durationMinutes
                  }

                  ,
                  Status: 'COMPLETED',
                  Notes: ''
                }

                ;

                // Build assessment payload (16 fields)
                var assessmentPayload= {

                  Session_ID: sessionId,
                  Client_ID: 'Default',
                  Site_ID: '',
                  Site_Name: '',
                  Crop_System: '',
                  results: CPOSL.lastResults || {}

                  ,
                  selections: CPOSL.selections || {}

                  ,
                  signals_count: signalsCount,
                  Notes: ''
                }

                ;

                console.log('[Save] Duration:', durationMinutes, 'minutes');
                console.log('[Save] Session payload:', sessionPayload);

                // Save session first
                google.script.run .withSuccessHandler(function(result) {
                    console.log('[Save] Session saved:', result);

                    // Then save assessment
                    google.script.run .withSuccessHandler(function(result) {
                        console.log('[Save] Assessment saved:', result);
                        setStatus(true, 'Assessment saved: '+ result.Assessment_ID);
                        alert('Assessment saved successfully!\n\nAssessment ID: '+ result.Assessment_ID + '\nSession ID: '+ sessionId + '\nDuration: '+ durationMinutes + ' minutes');
                      }

                    ) .withFailureHandler(function(error) {
                        console.error('[Save] Assessment save failed:', error);
                        setStatus(false, 'Save failed: '+ error.message);
                        alert('Error saving assessment: '+ error.message);
                      }

                    ) .saveCPOSLiteAssessment(assessmentPayload);
                  }

                ) .withFailureHandler(function(error) {
                    console.error('[Save] Session save failed:', error);
                    setStatus(false, 'Save failed: '+ error.message);
                    alert('Error saving session: '+ error.message);
                  }

                ) .saveCPOSSession(sessionPayload);
              }


              /**
                 * RESTART EVALUATION - Reset questionnaire and start fresh
                 */
              function restartEvaluation() {
                // Confirm with user
                var lang=CPOSL.language;
                var confirmMsg=lang==='HI'? '‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§ñ‡•ã ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§' : 'Are you sure you want to start a new evaluation? Current progress will be lost.';

                if ( !confirm(confirmMsg)) {
                  return; // User canceled
                }

                console.log('[Restart] Starting new evaluation...');

                // Reset questionnaire state
                CPOSL.qState= {

                  sessionId: null,
                  current: null,
                  history: [],
                  answered: {}

                  ,
                  signals: {}

                  ,
                  skippedQuestions: {}

                  ,
                  probeResults: {}

                  ,
                  startTime: null,
                  finishedEarly: false
                }

                ;

                // Reset round tracking
                CPOSL.rounds.current=0;

                CPOSL.rounds.answered= {
                  1: [],
                  2: [],
                  3: []
                }

                ;

                // Reset selections (factors)
                CPOSL.selections= {}

                ;

                // Clear UI
                document.getElementById('qQuestionText').innerHTML='<span id="qQuestionTextDefault">'+ t('msgClickStart') + '</span>';
                document.getElementById('qHelpText').textContent='';
                document.getElementById('qAnswerBox').innerHTML='';
                document.getElementById('qNavStatus').textContent='';
                document.getElementById('qDerivedBox').innerHTML='<span id="qDerivedBoxDefault">'+ t('msgSignalsWillAppear') + '</span>';

                // Reset progress section
                toggleProgressSection(false);

                // Go back to Panel 0 (Questionnaire)
                goStep(0);

                // Update button states
                updateQuestionnaireUIState();

                // Rebuild factor form (empty)
                buildFactorForm();

                // Clear results
                document.getElementById('screeningGrid').innerHTML='';
                document.getElementById('selectionRecap').innerHTML='';
                document.getElementById('headlineBox').innerHTML='<span id="headlineBoxDefault">'+ t('msgEvaluateToSummary') + '</span>';
                document.getElementById('recStack').innerHTML='';
                document.getElementById('condStack').innerHTML='';
                document.getElementById('exclStack').innerHTML='';

                setStatus(true, t('statusReady'));

                // üî¥ ADD THIS AT THE END:
                // Force update to show Start button
                setTimeout(function() {
                    updateQuestionnaireUIState();
                  }

                  , 100);

                console.log('[Restart] ‚úì Ready for new evaluation');
              }

              // LANGUAGE TOGGLE
              function wireLanguageToggle() {
                var en=document.getElementById('langEN');
                var hi=document.getElementById('langHI');
                if ( !en || !hi) return;

                function apply() {
                  CPOSL.language=hi.checked ? 'HI' : 'EN';
                  console.log('[Lang] Switched to:', CPOSL.language);

                  // üî¥ UPDATE ALL UI LABELS IMMEDIATELY
                  updateAllUILabels();

                  // Re-render current question if questionnaire is active
                  if (CPOSL.qState.current) {
                    renderQuestionUI();
                  }

                  // Update progress labels
                  updateProgress();

                  updateQuestionnaireUIState();
                }

                en.addEventListener('change', apply);
                hi.addEventListener('change', apply);
              }



              /**
                 * Update button labels based on current language
                 */
              function updateButtonLabels() {
                var setText=function(id, text) {
                  var el=document.getElementById(id);
                  if (el) el.innerHTML=text; // ‚Üê CHANGED from textContent to innerHTML
                }

                ;

                setText('btnQStartText', t('btnStart'));
                setText('btnQNextText', t('btnNext'));
                setText('btnQBackText', t('btnBack'));
                setText('btnQSkipText', t('btnSkip'));
                setText('btnQFinishText', t('btnFinish'));
                setText('btnQSaveText', t('btnSave'));
                setText('btnQDebugText', t('btnDebug'));

                console.log('[UI] Updated button labels to:', CPOSL.language);
              }


              // INITIALIZATION
              function init() {
                console.log('[CPOS-Lite] init() starting...');
                setStatus(false, 'Loading...');

                getCPOSLiteTables() .then(function(liteTables) {
                    console.log('[CPOS] getCPOSLiteTables() result:', liteTables);

                    if ( !liteTables || ( !liteTables.ok && !liteTables.bounds)) {
                      setStatus(false, 'Failed to load Lite tables');
                      return Promise.reject('No Lite tables');
                    }

                    // Store raw data arrays
                    CPOSL.data.bounds=liteTables.bounds || [];
                    CPOSL.data.desirability=liteTables.desirability || [];
                    CPOSL.data.weights=liteTables.weights || [];

                    // Store processed indexes and aspectsMap
                    CPOSL.data.wIdx=liteTables.wIdx || {}

                    ;

                    CPOSL.data.desirIdx=liteTables.desirIdx || {}

                    ;

                    CPOSL.aspectsMap=liteTables.aspectsMap || {}

                    ;

                    console.log('[CPOS] Aspects loaded:', Object.keys(CPOSL.aspectsMap).length, 'aspects');

                    buildLiteIndexes();

                    return getCPOSQuestionnaireConfig();
                  }

                ) .then(function(qConfig) {
                    console.log('[CPOS] getCPOSQuestionnaireConfig() result:', qConfig);

                    if (qConfig && (qConfig.ok || qConfig.bank)) {
                      CPOSL.q.bank=qConfig.bank || [];
                      CPOSL.q.options=qConfig.options || [];
                      CPOSL.q.derivationRules=qConfig.derivationRules || [];
                      CPOSL.q.routingRules=qConfig.routingRules || [];
                      CPOSL.q.signalToLiteMap=qConfig.signalToLiteMap || [];

                      buildQuestionnaireIndexes();
                    }

                    else {
                      console.warn('[CPOS] Questionnaire config not available');
                      CPOSL.q.available=false;
                    }

                    buildFactorForm();
                    updateQuestionnaireUIState();
                    wireLanguageToggle();

                    // Initialize all UI labels
                    updateAllUILabels();
                    updateButtonLabels();

                    // ‚úÖ ADDED: Initialize step locking after UI is ready
                    if (typeof initializeStepLocking==='function') {
                      setTimeout(function() {
                          console.log('[CPOS] Initializing step locking...');
                          initializeStepLocking();
                        }

                        , 300);
                    }

                    var factorCount=CPOSL.idx.boundsByVar.size;
                    var qBankCount=CPOSL.q.idx.qBankById.size;
                    var qReady=CPOSL.q.available;

                    var statusMsg='Ready ‚Ä¢ Factors='+ factorCount + ' ‚Ä¢ QBank='+ qBankCount + (qReady ? ' ‚úì' : '');
                    setStatus(factorCount > 0, statusMsg);

                    console.log('[CPOS-Lite] init() complete:', {
                        factors: factorCount,
                        qBank: qBankCount,
                        qReady: qReady
                      }

                    );
                  }

                ) .catch(function(err) {
                    console.error('[CPOS-Lite] init() failed:', err);
                    setStatus(false, 'Init failed: '+ (err && err.message ? err.message : err));
                  }

                );
              }

              // Start when DOM ready
              document.addEventListener('DOMContentLoaded', init);

              function showDebugInfo() {
                var info= {
                  signals: Object.keys(CPOSL.qState.signals).length,
                  signalDetails: CPOSL.qState.signals,
                  answers: Object.keys(CPOSL.qState.answered).length,
                  selections: Object.keys(CPOSL.selections).length,
                  selectionDetails: CPOSL.selections,
                  mappingsLoaded: CPOSL.q.signalToLiteMap.length,
                  boundsLoaded: CPOSL.idx.boundsByVar.size
                }

                ;

                console.log('=== CPOS DEBUG INFO ===');
                console.table(info);
                console.log('\nSignals:', CPOSL.qState.signals);
                console.log('\nSelections:', CPOSL.selections);
                console.log('\nMappings:', CPOSL.q.signalToLiteMap);

                alert('Debug info logged to console (F12)');
              }


              // DEBUG UTILITIES

              window.CPOSL=CPOSL; // Make globally accessible

              window.debugCPOS=function() {
                console.clear();
                console.log('%c=== CPOS DEBUG REPORT ===', 'font-size:16px;font-weight:bold;color:#2f6fb5');

                // 1. Signals
                console.log('%c1. SIGNALS', 'font-weight:bold;color:#3a8f4b');
                var signals=CPOSL.qState.signals;
                console.log('   Count:', Object.keys(signals).length);

                if (Object.keys(signals).length > 0) {
                  console.table(signals);
                }

                else {
                  console.log('   ‚ùå No signals created!');
                }

                // 2. Answers
                console.log('%c2. ANSWERS', 'font-weight:bold;color:#3a8f4b');
                var answers=CPOSL.qState.answered;
                console.log('   Count:', Object.keys(answers).length);

                var answerSummary= {}

                ;

                Object.keys(answers).forEach(function(qid) {
                    answerSummary[qid]=answers[qid].Answer_Normalized || answers[qid].Answer_Raw;
                  }

                );
                console.table(answerSummary);

                // 3. Auto-filled Factors
                console.log('%c3. AUTO-FILLED FACTORS', 'font-weight:bold;color:#3a8f4b');
                var selections=CPOSL.selections;
                console.log('   Count:', Object.keys(selections).length);

                if (Object.keys(selections).length > 0) {
                  console.table(selections);
                }

                else {
                  console.log('   ‚ùå No factors auto-filled!');
                }

                // 4. Signal Mappings
                console.log('%c4. SIGNAL MAPPINGS', 'font-weight:bold;color:#3a8f4b');
                var mappings=CPOSL.q.signalToLiteMap || [];
                console.log('   Loaded:', mappings.length);

                if (mappings.length===0) {
                  console.log('   ‚ùå NO MAPPINGS LOADED - This is the problem!');
                }

                else {
                  console.log('   First 3 mappings:');
                  console.table(mappings.slice(0, 3));
                }

                // 5. Derivation Rules
                console.log('%c5. DERIVATION RULES', 'font-weight:bold;color:#3a8f4b');
                var deriv=CPOSL.q.derivationRules || [];
                console.log('   Loaded:', deriv.length);

                if (deriv.length > 0) {
                  console.log('   First 3 rules:');
                  console.table(deriv.slice(0, 3));
                }

                // 6. Lite Factor Bounds
                console.log('%c6. LITE FACTOR BOUNDS', 'font-weight:bold;color:#3a8f4b');
                console.log('   Variables:', CPOSL.idx.boundsByVar.size);
                var firstVar=Array.from(CPOSL.idx.boundsByVar.keys())[0];

                if (firstVar) {
                  console.log('   Example:', firstVar, '‚Üí', CPOSL.idx.boundsByVar.get(firstVar).length, 'classes');
                }

                // 7. Test Mapping Logic
                console.log('%c7. MAPPING TEST', 'font-weight:bold;color:#e6a83a');

                if (mappings.length > 0 && Object.keys(signals).length > 0) {
                  var testMapping=mappings[0];
                  var sigKey=testMapping.SignalKey || testMapping.Signal_Key; // üî¥ UPDATED
                  var signal=signals[sigKey];
                  console.log('   Testing:', sigKey);
                  console.log('   Signal exists:',  ! !signal);

                  if (signal) {
                    console.log('   Signal value:', signal.value);
                    console.log('   Expected value:', testMapping.Signal_Value || testMapping.When_Signal_Value || testMapping.WhenValue); // üî¥ UPDATED
                    console.log('   Match:', signal.value===(testMapping.Signal_Value || testMapping.When_Signal_Value || testMapping.WhenValue)); // üî¥ UPDATED
                    console.log('   Would set factor:', testMapping.LiteVariableName, '=', testMapping.Lite_Class_Label); // üî¥ ADDED
                  }
                }

                console.log('%c=== END REPORT ===', 'font-size:16px;font-weight:bold;color:#2f6fb5');

                return {
                  signals: signals,
                  answers: answers,
                  selections: selections,
                  mappings: mappings,
                  derivationRules: deriv
                }

                ;
              }

              ;

              // Auto-run on console
              console.log('%cCPOS Loaded. Type debugCPOS() for diagnostic report.', 'color:#2f6fb5;font-weight:bold');


              function wireLanguageToggle() {
                var en=document.getElementById('langEN');
                var hi=document.getElementById('langHI');

                console.log('[Debug] wireLanguageToggle called, EN:', en, 'HI:', hi);

                if ( !en || !hi) {
                  console.error('[Debug] Language toggle elements not found!');
                  return;
                }

                function apply() {
                  CPOSL.language=hi.checked ? 'HI' : 'EN';
                  console.log('[Lang] ‚úì Switched to:', CPOSL.language);
                  console.log('[Lang] Calling updateAllUILabels...');

                  updateAllUILabels();

                  console.log('[Lang] Calling renderQuestionUI...');

                  if (CPOSL.qState.current) {
                    renderQuestionUI();
                  }

                  console.log('[Lang] Calling updateProgress...');
                  updateProgress();

                  console.log('[Lang] Calling updateQuestionnaireUIState...');
                  updateQuestionnaireUIState();

                  console.log('[Lang] Language change complete!');
                }

                en.addEventListener('change', apply);
                hi.addEventListener('change', apply);

                console.log('[Debug] Language toggle listeners attached');
              }


              // PROGRESS TABS LOCKING

              /**
                 * Update step navigation state based on questionnaire progress
                 */
              function updateStepNavigation() {
                // Check if at least Round 1 is complete
                var round1Complete=CPOSL.rounds.current >=1 || CPOSL.qState.roundsFinished >=1 || Object.keys(CPOSL.qState.answered).length >=15;

                var hasSelections=Object.keys(CPOSL.selections).length > 0;
                var canProceed=round1Complete || hasSelections;

                console.log('[STEPS] Round 1 complete:', round1Complete);
                console.log('[STEPS] Has selections:', hasSelections);
                console.log('[STEPS] Can proceed to steps 1-3:', canProceed);

                // Get all tab buttons
                var allTabs=document.querySelectorAll('button.tab');

                allTabs.forEach(function(tab) {
                    // Get step number from text content
                    var text=tab.textContent.trim();
                    var stepNum=parseInt(text.charAt(0)); // First character is the number

                    // Only lock steps 1, 2, 3 (not step 0)
                    if (stepNum===0 || isNaN(stepNum)) return;

                    if (canProceed) {
                      // ‚úÖ UNLOCK STEP
                      tab.classList.remove('locked', 'disabled');
                      tab.disabled=false;
                      tab.style.opacity='1';
                      tab.style.cursor='pointer';
                      tab.style.pointerEvents='auto';
                      tab.title='';

                      // Remove lock icon if present
                      var lockIcon=tab.querySelector('.lock-icon');
                      if (lockIcon) lockIcon.remove();

                      console.log('[STEPS] ‚úÖ Unlocked Step', stepNum);
                    }

                    else {
                      // üîí LOCK STEP
                      tab.classList.add('locked', 'disabled');
                      tab.disabled=true;
                      tab.style.opacity='0.5';
                      tab.style.cursor='not-allowed';
                      tab.style.pointerEvents='none';
                      tab.title='Complete at least Round 1 of the questionnaire to unlock this step';

                      // Add lock icon if not present
                      var lockIcon=tab.querySelector('.lock-icon');

                      if ( !lockIcon) {
                        lockIcon=document.createElement('span');
                        lockIcon.className='lock-icon';
                        lockIcon.textContent=' üîí';
                        lockIcon.style.cssText='margin-left:6px;font-size:12px;';
                        tab.appendChild(lockIcon);
                      }

                      console.log('[STEPS] üîí Locked Step', stepNum);
                    }
                  }

                );
              }


              /**
                 * Initialize step locking on page load
                 */
              function initializeStepLocking() {
                console.log('[STEPS] Initializing step locking...');

                var allTabs=document.querySelectorAll('button.tab');

                allTabs.forEach(function(tab) {
                    var text=tab.textContent.trim();
                    var stepNum=parseInt(text.charAt(0));

                    // Only add click prevention to steps 1, 2, 3
                    if (stepNum===0 || isNaN(stepNum)) return;

                    // Add click handler to check if locked
                    tab.addEventListener('click', function(e) {
                        if (tab.classList.contains('locked') || tab.disabled) {
                          e.preventDefault();
                          e.stopPropagation();
                          e.stopImmediatePropagation();

                          var answeredCount=Object.keys(CPOSL.qState.answered).length;
                          var questionsNeeded=Math.max(0, 15 - answeredCount);

                          // Show alert
                          alert('‚ö†Ô∏è Step Locked\n\n'+ 'Please complete at least Round 1 of the questionnaire (15 questions) before accessing this step.\n\n'+ 'Progress:\n'+ '‚Ä¢ Questions answered: '+ answeredCount + ' / 15\n'+ '‚Ä¢ Questions remaining: '+ questionsNeeded + '\n\n'+ 'Click "Adaptive Questionnaire (Fast Setup)" to continue.'
                          );

                          console.log('[STEPS] ‚ùå Blocked navigation to locked Step', stepNum);
                          return false;
                        }
                      }

                      , true); // Use capture phase
                  }

                );

                // Set initial lock state
                updateStepNavigation();

                console.log('[STEPS] ‚úÖ Step locking initialized');
              }

              /**
                 * Show notification when steps are unlocked
                 */
              function showStepUnlockNotification() {
                // Add unlock animation to newly unlocked tabs
                var unlockedTabs=document.querySelectorAll('button.tab:not(.locked)');

                unlockedTabs.forEach(function(tab, index) {
                    var text=tab.textContent.trim();
                    var stepNum=parseInt(text.charAt(0));

                    if (stepNum >=1 && stepNum <=3) {
                      setTimeout(function() {
                          tab.classList.add('just-unlocked');

                          setTimeout(function() {
                              tab.classList.remove('just-unlocked');
                            }

                            , 500);
                        }

                        , index * 100);
                    }
                  }

                );

                // Show toast notification
                var notification=document.createElement('div');
                notification.style.cssText='position:fixed;top:80px;right:20px;'+ 'background:linear-gradient(135deg, #4caf50 0%, #45a049 100%);'+ 'color:white;padding:16px 24px;border-radius:12px;'+ 'box-shadow:0 6px 20px rgba(76,175,80,0.4);'+ 'z-index:10000;font-size:15px;font-weight:600;'+ 'display:flex;align-items:center;gap:12px;'+ 'animation:slideInRight 0.4s ease;';

                notification.innerHTML='<span style="font-size:24px;">üîì</span>'+ '<div>'+ '<div style="font-weight:700;margin-bottom:4px;">Steps Unlocked!</div>'+ '<div style="font-size:13px;opacity:0.9;">Steps 1, 2, and 3 are now accessible</div>'+ '</div>';

                document.body.appendChild(notification);

                // Auto-remove after 4 seconds
                setTimeout(function() {
                    notification.style.opacity='0';
                    notification.style.transform='translateX(400px)';
                    notification.style.transition='all 0.4s ease';

                    setTimeout(function() {
                        notification.remove();
                      }

                      , 400);
                  }

                  , 4000);
              }

// ADVANCED ASSESSMENT MODULE - COMPLETE JAVASCRIPT

var ADVANCED = {
  state: {
    active: false,
    sessionId: null,
    currentQuestionIndex: 0,
    questions: [],
    answers: {},
    startTime: null,
    currentDimension: null
  }
};

/**
 * Start Advanced Assessment
 */
function startAdvancedAssessment() {
  console.log('[Advanced] Starting assessment - loading from sheets...');
  
  document.getElementById('advancedWelcome').style.display = 'none';
  document.getElementById('advancedInterface').style.display = 'block';
  document.getElementById('advQuestionText').innerHTML = `
    <div style="text-align:center; padding:40px;">
      <div style="font-size:48px; margin-bottom:16px;">‚è≥</div>
      <div style="font-size:18px; color:rgba(255,255,255,0.9);">Loading questions from database...</div>
    </div>
  `;
  document.getElementById('advAnswerBox').innerHTML = '';
  
  google.script.run
    .withSuccessHandler(function(sessionResult) {
      if (!sessionResult.ok) {
        alert('Error creating session: ' + sessionResult.error);
        return;
      }
      
      ADVANCED.state.sessionId = sessionResult.interviewId;
      console.log('[Advanced] Session created:', sessionResult.interviewId);
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.ok) {
            alert('Error loading questionnaire: ' + result.error);
            return;
          }
          
          console.log('[Advanced] Loaded', result.questions.length, 'questions');
          
          ADVANCED.state = {
            active: true,
            sessionId: sessionResult.interviewId,
            currentQuestionIndex: 0,
            questions: result.questions,
            answers: {},
            startTime: new Date(),
            currentDimension: null
          };
          
          advRenderCurrentQuestion();
        })
        .withFailureHandler(function(error) {
          alert('Failed to load questions: ' + error.message);
          console.error('[Advanced] Error:', error);
        })
        .getAdvancedQuestionnaire('AWD');
    })
    .withFailureHandler(function(error) {
      alert('Failed to create session: ' + error.message);
      console.error('[Advanced] Error:', error);
    })
    .createAdvancedSession('DEFAULT', 'AWD');
}

/**
 * Render current question
 */
function advRenderCurrentQuestion() {
  var idx = ADVANCED.state.currentQuestionIndex;
  var questions = ADVANCED.state.questions;
  
  if (idx >= questions.length) {
    advShowResults();
    return;
  }
  
  var q = questions[idx];
  var lang = CPOSL.language || 'EN';
  
  var progress = Math.round((idx / questions.length) * 100);
  document.getElementById('advProgressBar').style.width = progress + '%';
  document.getElementById('advProgressPercent').textContent = progress + '%';
  document.getElementById('advAnsweredCount').textContent = idx;
  document.getElementById('advQuestionCounter').textContent = `Question ${idx + 1} of ${questions.length}`;
  
  var avgTimePerQ = 90;
  var remaining = (questions.length - idx) * avgTimePerQ;
  var minutes = Math.ceil(remaining / 60);
  document.getElementById('advTimeEstimate').textContent = `~${minutes} min left`;
  
  var dimName = q.dimensionName || q.dimension;
  document.getElementById('advTierBadge').innerHTML = `<span>üìç</span><span>${escapeHtml(dimName)}</span>`;
  
  document.getElementById('advQuestionNumber').textContent = `QUESTION ${idx + 1}`;
  
  var qText = lang === 'HI' && q.text_HI ? q.text_HI : q.text_EN;
  document.getElementById('advQuestionText').innerHTML = escapeHtml(qText);
  
  var contextEl = document.getElementById('advQuestionContext');
  var helpText = lang === 'HI' && q.help_HI ? q.help_HI : q.help_EN;
  if (helpText) {
    document.getElementById('advContextText').innerHTML = escapeHtml(helpText);
    contextEl.style.display = 'flex';
  } else {
    contextEl.style.display = 'none';
  }
  
  var answerBox = document.getElementById('advAnswerBox');
  answerBox.innerHTML = '';
  
  var qType = String(q.type || '').toLowerCase();
  
  if (qType.indexOf('single') >= 0 || qType === 'categorical_direct') {
    var grid = document.createElement('div');
    grid.className = 'adv-option-grid';
    
    if (!q.options || q.options.length === 0) {
      answerBox.innerHTML = '<div style="padding:20px; text-align:center; color:#ef4444;">No options available for this question</div>';
      return;
    }
    
    q.options.forEach(function(opt) {
      var label = lang === 'HI' && opt.label_HI ? opt.label_HI : opt.label_EN;
      var icon = opt.icon || '‚óè';
      
      var div = document.createElement('div');
      div.className = 'adv-option-item';
      div.innerHTML = `
        <div class="adv-option-icon">${icon}</div>
        <input type="radio" name="adv_q_${q.id}" value="${escapeHtml(opt.code)}" 
          id="adv_${q.id}_${opt.code}" class="adv-option-radio" 
          data-score="${opt.score || 0}" data-confidence="${opt.confidence || 0.85}">
        <label for="adv_${q.id}_${opt.code}" class="adv-option-label">
          ${escapeHtml(label)}
        </label>
      `;
      
      grid.appendChild(div);
      
      var radio = div.querySelector('input');
      radio.addEventListener('change', function() {
        grid.querySelectorAll('.adv-option-item').forEach(function(item) {
          item.classList.remove('selected');
        });
        if (radio.checked) {
          div.classList.add('selected');
          document.getElementById('btnAdvNext').disabled = false;
        }
      });
      
      div.addEventListener('click', function(e) {
        if (e.target.tagName !== 'INPUT') {
          radio.checked = true;
          radio.dispatchEvent(new Event('change'));
        }
      });
    });
    
    answerBox.appendChild(grid);
    
  } else if (qType === 'number' || qType === 'numeric_direct') {
    var placeholder = lang === 'HI' ? '‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç' : 'Enter number';
    if (q.unit) {
      placeholder += ' (' + q.unit + ')';
    }
    
    var input = document.createElement('input');
    input.type = 'number';
    input.className = 'adv-numeric-input';
    input.placeholder = placeholder;
    input.step = '0.1';
    input.min = '0';
    
    input.addEventListener('input', function() {
      document.getElementById('btnAdvNext').disabled = !input.value;
    });
    
    answerBox.appendChild(input);
  } else {
    answerBox.innerHTML = `<div style="padding:20px; text-align:center; color:#f59e0b;">Question type "${qType}" not yet supported</div>`;
  }
  
  document.getElementById('btnAdvBack').style.display = idx > 0 ? 'inline-flex' : 'none';
  document.getElementById('btnAdvNext').disabled = true;
  document.getElementById('btnAdvNext').style.display = 'inline-flex';
  document.getElementById('btnAdvSkip').style.display = 'inline-flex';
  
  console.log('[Advanced] Rendered question', idx + 1, ':', q.id);
}

/**
 * Go to next question
 */
function advNextQuestion() {
  var idx = ADVANCED.state.currentQuestionIndex;
  var q = ADVANCED.state.questions[idx];
  
  var answer = null;
  var qType = String(q.type || '').toLowerCase();
  
  if (qType.indexOf('single') >= 0 || qType === 'categorical_direct') {
    var selected = document.querySelector(`input[name="adv_q_${q.id}"]:checked`);
    if (selected) {
      answer = {
        questionId: q.id,
        dimension: q.dimension,
        answerCode: selected.value,
        answerLabel: selected.parentElement.querySelector('.adv-option-label').textContent,
        score: Number(selected.getAttribute('data-score')) || 0,
        confidence: Number(selected.getAttribute('data-confidence')) || 0.85,
        timestamp: new Date().toISOString()
      };
    }
  } else if (qType === 'number' || qType === 'numeric_direct') {
    var input = document.querySelector('.adv-numeric-input');
    if (input && input.value) {
      answer = {
        questionId: q.id,
        dimension: q.dimension,
        answerValue: parseFloat(input.value),
        unit: q.unit || '',
        timestamp: new Date().toISOString()
      };
    }
  }
  
  if (!answer) {
    alert('Please provide an answer');
    return;
  }
  
  ADVANCED.state.answers[q.id] = answer;
  console.log('[Advanced] Saved answer:', answer);
  
  document.getElementById('btnAdvNext').disabled = true;
  document.getElementById('btnAdvNext').innerHTML = '<span>Saving...</span>';
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.ok) {
        console.log('[Advanced] Saved to sheet:', result.responseId);
        
        if (advCheckDisqualifiers(answer)) {
          return;
        }
        
        if (advCheckCheckpoint(idx)) {
          return;
        }
        
        ADVANCED.state.currentQuestionIndex++;
        advRenderCurrentQuestion();
      } else {
        alert('Error saving answer: ' + result.error);
        document.getElementById('btnAdvNext').disabled = false;
        document.getElementById('btnAdvNext').innerHTML = '<span>Next</span><span>‚Üí</span>';
      }
    })
    .withFailureHandler(function(error) {
      alert('Failed to save: ' + error.message);
      document.getElementById('btnAdvNext').disabled = false;
      document.getElementById('btnAdvNext').innerHTML = '<span>Next</span><span>‚Üí</span>';
    })
    .saveAdvancedResponse(ADVANCED.state.sessionId, q.id, answer);
}

/**
 * Go back
 */
function advGoBack() {
  if (ADVANCED.state.currentQuestionIndex > 0) {
    ADVANCED.state.currentQuestionIndex--;
    advRenderCurrentQuestion();
  }
}

/**
 * Skip question
 */
function advSkipQuestion() {
  ADVANCED.state.currentQuestionIndex++;
  advRenderCurrentQuestion();
}

/**
 * Check disqualifiers
 */
function advCheckDisqualifiers(answer) {
  var disqualifiers = [
    { questionId: 'ADV_D2_001', code: 'RAINFED', reason: 'RAINFED' },
    { questionId: 'ADV_D4_001', code: 'SHARECROP', reason: 'SHARECROP' },
    { questionId: 'ADV_D4_003', code: 'AWD_ALREADY', reason: 'ALREADY_AWD' }
  ];
  
  for (var i = 0; i < disqualifiers.length; i++) {
    var dq = disqualifiers[i];
    if (answer.questionId === dq.questionId && answer.answerCode === dq.code) {
      advShowDisqualification(dq.reason);
      return true;
    }
  }
  
  return false;
}

/**
 * Check checkpoint
 */
function advCheckCheckpoint(currentIdx) {
  var q = ADVANCED.state.questions[currentIdx];
  var nextQ = ADVANCED.state.questions[currentIdx + 1];
  
  if (nextQ && q.dimension !== nextQ.dimension) {
    advShowCheckpoint(q.dimension);
    return true;
  }
  
  return false;
}

/**
 * Show checkpoint
 */
function advShowCheckpoint(dimension) {
  var lang = CPOSL.language || 'EN';
  var answers = ADVANCED.state.answers;
  
  var dimNames = {
    'D1': { en: 'Biophysical Suitability', hi: '‡§≠‡•å‡§§‡§ø‡§ï ‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§‡§§‡§æ', icon: 'üåæ' },
    'D2': { en: 'Infrastructure & Access', hi: '‡§¨‡•Å‡§®‡§ø‡§Ø‡§æ‡§¶‡•Ä ‡§¢‡§æ‡§Ç‡§ö‡§æ', icon: 'üíß' },
    'D3': { en: 'Location & Context', hi: '‡§∏‡•ç‡§•‡§æ‡§®', icon: 'üìç' },
    'D4': { en: 'Legal & Carbon Eligibility', hi: '‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ', icon: 'üìú' },
    'D5': { en: 'Economic Viability', hi: '‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞‡•ç‡§Ø‡§§‡§æ', icon: 'üí∞' },
    'D6': { en: 'Carbon Potential', hi: '‡§ï‡§æ‡§∞‡•ç‡§¨‡§® ‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ', icon: 'üåç' }
  };
  
  var dimInfo = dimNames[dimension];
  if (!dimInfo) return;
  
  var title = lang === 'HI' ? dimInfo.hi : dimInfo.en;
  var icon = dimInfo.icon;
  
  var dimAnswers = Object.values(answers).filter(function(a) { return a.dimension === dimension; });
  
  var statsHTML = '';
  var totalScore = 0;
  var count = 0;
  
  dimAnswers.forEach(function(ans) {
    var label = ans.answerLabel || ans.answerValue || '‚Äî';
    
    statsHTML += `
      <div class="adv-summary-stat">
        <div class="label">${escapeHtml(ans.questionId)}</div>
        <div class="value">${escapeHtml(String(label).substring(0, 30))}</div>
        <div class="icon">‚úì</div>
      </div>
    `;
    
    if (ans.score !== undefined) {
      totalScore += ans.score;
      count++;
    }
  });
  
  var avgScore = count > 0 ? Math.round(totalScore / count) : 0;
  var scoreLabel = lang === 'HI' ? '‡§∏‡•ç‡§ï‡•ã‡§∞' : 'Score';
  var suitLabel = lang === 'HI' ? '‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§‡§§‡§æ' : 'suitability';
  var continueBtn = lang === 'HI' ? '‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç ‚Üí' : 'Continue ‚Üí';
  
  var cardHTML = `
    <div class="adv-checkpoint-card">
      <div class="adv-checkpoint-header">
        <div class="adv-checkpoint-icon">${icon}</div>
        <div class="adv-checkpoint-title">${escapeHtml(title)}</div>
      </div>
      <div class="adv-summary-grid">${statsHTML}</div>
      <div class="adv-confidence-bar">
        <div class="label">${scoreLabel}</div>
        <div class="bar"><div class="fill" style="width:${avgScore}%"></div></div>
        <div class="text">${avgScore}% ${suitLabel}</div>
      </div>
      <div class="adv-checkpoint-actions">
        <button class="btn primary" onclick="advConfirmCheckpoint()">${continueBtn}</button>
      </div>
    </div>
  `;
  
  document.getElementById('advQuestionCard').innerHTML = cardHTML;
  document.getElementById('advQuestionContext').style.display = 'none';
  document.getElementById('advAnswerBox').innerHTML = '';
  document.getElementById('btnAdvNext').style.display = 'none';
  document.getElementById('btnAdvBack').style.display = 'none';
  document.getElementById('btnAdvSkip').style.display = 'none';
}

/**
 * Confirm checkpoint
 */
function advConfirmCheckpoint() {
  document.getElementById('btnAdvNext').style.display = 'inline-flex';
  document.getElementById('btnAdvBack').style.display = 'inline-flex';
  document.getElementById('btnAdvSkip').style.display = 'inline-flex';
  
  ADVANCED.state.currentQuestionIndex++;
  advRenderCurrentQuestion();
}

/**
 * Show disqualification
 */
function advShowDisqualification(reason) {
  var lang = CPOSL.language || 'EN';
  
  var messages = {
    'RAINFED': {
      title_EN: 'AWD Not Applicable',
      title_HI: 'AWD ‡§≤‡§æ‡§ó‡•Ç ‡§®‡§π‡•Ä‡§Ç',
      reason_EN: 'AWD requires irrigation control. Your field is rainfed.',
      reason_HI: 'AWD ‡§ï‡•ã ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§Ü‡§™‡§ï‡§æ ‡§ñ‡•á‡§§ ‡§µ‡§∞‡•ç‡§∑‡§æ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§π‡•à‡•§',
      suggestion_EN: 'Consider SRI or Biochar pathways instead.',
      suggestion_HI: 'SRI ‡§Ø‡§æ ‡§¨‡§æ‡§Ø‡•ã‡§ö‡§æ‡§∞ ‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§™‡§∞ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§'
    },
    'SHARECROP': {
      title_EN: 'Carbon Credits Require Ownership',
      title_HI: '‡§ï‡§æ‡§∞‡•ç‡§¨‡§® ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§µ‡§æ‡§Æ‡§ø‡§§‡•ç‡§µ ‡§ö‡§æ‡§π‡§ø‡§è',
      reason_EN: 'Carbon credits require land ownership. Sharecropping does not qualify.',
      reason_HI: '‡§ï‡§æ‡§∞‡•ç‡§¨‡§® ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‡§µ‡§æ‡§Æ‡§ø‡§§‡•ç‡§µ ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§¨‡§ü‡§æ‡§à ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç‡•§',
      suggestion_EN: 'AWD can still save water. Consider without carbon credits.',
      suggestion_HI: 'AWD ‡§™‡§æ‡§®‡•Ä ‡§¨‡§ö‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡§æ‡§∞‡•ç‡§¨‡§® ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§¨‡§ø‡§®‡§æ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§'
    },
    'ALREADY_AWD': {
      title_EN: 'Already Practicing AWD',
      title_HI: '‡§™‡§π‡§≤‡•á ‡§∏‡•á AWD',
      reason_EN: 'You already practice AWD. Carbon credits need additionality.',
      reason_HI: '‡§Ü‡§™ ‡§™‡§π‡§≤‡•á ‡§∏‡•á AWD ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§ï‡§æ‡§∞‡•ç‡§¨‡§® ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡•ã ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§‡§§‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§',
      suggestion_EN: 'Great! Consider Biochar or ERW pathways.',
      suggestion_HI: '‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ! ‡§¨‡§æ‡§Ø‡•ã‡§ö‡§æ‡§∞ ‡§Ø‡§æ ERW ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§'
    }
  };
  
  var msg = messages[reason];
  if (!msg) return;
  
  var title = lang === 'HI' ? msg.title_HI : msg.title_EN;
  var reasonText = lang === 'HI' ? msg.reason_HI : msg.reason_EN;
  var suggestion = lang === 'HI' ? msg.suggestion_HI : msg.suggestion_EN;
  var altLabel = lang === 'HI' ? '‡§µ‡§ø‡§ï‡§≤‡•ç‡§™' : 'Alternative';
  var btnLabel = lang === 'HI' ? '‡§®‡§Ø‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç' : 'Start New';
  
  var alertHTML = `
    <div class="adv-disqualification">
      <div class="header">
        <div class="icon">üö´</div>
        <div class="title">${escapeHtml(title)}</div>
      </div>
      <div class="reason">${escapeHtml(reasonText)}</div>
      <div class="suggestion">
        <div class="suggestion-title">üí° ${altLabel}</div>
        <div class="suggestion-text">${escapeHtml(suggestion)}</div>
      </div>
      <div style="margin-top:24px;text-align:center;">
        <button class="btn primary" onclick="restartAdvancedAssessment()">üîÑ ${btnLabel}</button>
      </div>
    </div>
  `;
  
  document.getElementById('advQuestionCard').innerHTML = alertHTML;
  document.getElementById('advQuestionContext').style.display = 'none';
  document.getElementById('advAnswerBox').innerHTML = '';
  document.getElementById('btnAdvNext').style.display = 'none';
  document.getElementById('btnAdvBack').style.display = 'none';
  document.getElementById('btnAdvSkip').style.display = 'none';
  
  ADVANCED.state.active = false;
}

/**
 * Restart
 */
function restartAdvancedAssessment() {
  document.getElementById('advancedInterface').style.display = 'none';
  document.getElementById('advancedWelcome').style.display = 'block';
}

/**
 * Show results
 */
function advShowResults() {
  console.log('[Advanced] Loading results...');
  
  document.getElementById('advQuestionCard').innerHTML = `
    <div style="text-align:center; padding:40px;">
      <div style="font-size:48px; margin-bottom:16px;">üìä</div>
      <div style="font-size:18px;">Calculating your scores...</div>
    </div>
  `;
  document.getElementById('advAnswerBox').innerHTML = '';
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (!result.ok) {
        alert('Error calculating scores: ' + result.error);
        return;
      }
      
      advRenderResults(result);
    })
    .withFailureHandler(function(error) {
      alert('Failed to calculate scores: ' + error.message);
    })
    .calculateAdvancedScores(ADVANCED.state.sessionId);
}

/**
 * Render results
 */
/**
 * Render results
 */
function advRenderResults(scores) {
  var lang = CPOSL.language || 'EN';
  
  var landScore = scores.landScore || 0;
  var implScore = scores.implementationScore || 0;
  var realFeasibility = scores.realFeasibility || 0;
  
  // Calculate recommendation
  var recommendation = '';
  if (realFeasibility >= 80) {
    recommendation = lang === 'HI' ? '‡§Ö‡§§‡•ç‡§Ø‡§ß‡§ø‡§ï ‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§ø‡§§' : 'Highly Recommended';
  } else if (realFeasibility >= 70) {
    recommendation = lang === 'HI' ? '‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§ø‡§§' : 'Recommended';
  } else if (realFeasibility >= 60) {
    recommendation = lang === 'HI' ? '‡§∏‡§∂‡§∞‡•ç‡§§' : 'Conditional';
  } else {
    recommendation = lang === 'HI' ? '‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç' : 'Not Recommended';
  }
  
  var completeLabel = lang === 'HI' ? '‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§™‡•Ç‡§∞‡•ç‡§£!' : 'Assessment Complete!';
  var feasLabel = lang === 'HI' ? '‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞‡•ç‡§Ø‡§§‡§æ' : 'Real Feasibility';
  var landLabel = lang === 'HI' ? '‡§≠‡•Ç‡§Æ‡§ø ‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§‡§§‡§æ' : 'Land Suitability';
  var readyLabel = lang === 'HI' ? '‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä' : 'Readiness';
  var newBtn = lang === 'HI' ? '‡§®‡§Ø‡§æ' : 'New';
  var downloadBtn = lang === 'HI' ? '‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°' : 'Download';
  
  var resultsHTML = `
    <div class="content-section">
      <div style="text-align:center; margin-bottom:32px;">
        <h1 style="font-size:32px; font-weight:700; margin-bottom:12px;">
          üéØ ${completeLabel}
        </h1>
      </div>
      
      <div style="background:linear-gradient(135deg,#667eea,#764ba2); border-radius:24px; padding:40px; margin-bottom:32px; color:white; text-align:center; box-shadow:0 20px 40px rgba(102,126,234,0.4);">
        <div style="font-size:18px; font-weight:600; margin-bottom:16px; opacity:0.9;">
          ${feasLabel}
        </div>
        <div style="font-size:72px; font-weight:700; margin-bottom:16px;">
          ${realFeasibility}%
        </div>
        <div style="font-size:24px; font-weight:600; padding:12px 24px; background:rgba(255,255,255,0.2); border-radius:20px; display:inline-block;">
          ${recommendation}
        </div>
      </div>
      
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:32px;">
        <div style="text-align:center; padding:20px; background:linear-gradient(135deg,#fef3c7,#fde68a); border-radius:16px;">
          <div style="font-size:14px; color:#92400e; font-weight:600; margin-bottom:8px;">
            ${landLabel}
          </div>
          <div style="font-size:40px; font-weight:700; color:#78350f;">
            ${landScore}%
          </div>
        </div>
        <div style="text-align:center; padding:20px; background:linear-gradient(135deg,#ddd6fe,#c4b5fd); border-radius:16px;">
          <div style="font-size:14px; color:#5b21b6; font-weight:600; margin-bottom:8px;">
            ${readyLabel}
          </div>
          <div style="font-size:40px; font-weight:700; color:#4c1d95;">
            ${implScore}%
          </div>
        </div>
      </div>
      
      <div style="display:flex; gap:16px; justify-content:center; flex-wrap:wrap;">
        <button class="btn ghost" onclick="restartAdvancedAssessment()">
          üîÑ ${newBtn}
        </button>
        <button class="btn primary" onclick="alert('Export coming soon!')">
          üìÑ ${downloadBtn}
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('advancedInterface').style.display = 'none';
  document.getElementById('advancedResults').style.display = 'block';
  document.getElementById('advancedResults').innerHTML = resultsHTML;
}

/**
 * Show help
 */
function showAdvancedHelp() {
  alert('Advanced Assessment:\n\n‚Ä¢ 35-50 questions\n‚Ä¢ 11 dimensions (D1-D6, I1-I5)\n‚Ä¢ 25-35 minutes\n‚Ä¢ Investment-grade report');
}

/**
 * Helper function
 */
function escapeHtml(text) {
  if (!text) return '';
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
}



            // Advanced module resiliency: restore missing question shell after checkpoint transitions
            function ensureAdvancedQuestionShell_() {
                var card = document.getElementById('advQuestionCard');
                var answerBox = document.getElementById('advAnswerBox');
                if (!card || !answerBox) return;

                if (!document.getElementById('advQuestionNumber')) {
                    card.innerHTML =
                        '<div id="advQuestionNumber" style="display:inline-block;background:rgba(255,255,255,0.2);padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;margin-bottom:12px;letter-spacing:0.5px;">Question 1 / 59</div>' +
                        '<div id="advQuestionText" style="font-size:20px;font-weight:600;line-height:1.4;margin-bottom:12px;">Loading question‚Ä¶</div>' +
                        '<div id="advQuestionContext" style="display:none;align-items:flex-start;gap:10px;background:rgba(255,255,255,0.15);padding:12px 16px;border-radius:12px;font-size:14px;line-height:1.5;margin-top:12px;border-left:4px solid rgba(255,255,255,0.4);">' +
                        '<div id="advContextText"></div>' +
                        '</div>';
                }
            }

            function installAdvancedRenderGuard_() {
                if (typeof window.advRenderCurrentQuestion !== 'function' || window.__advRenderGuardInstalled) return;
                var originalRender = window.advRenderCurrentQuestion;
                window.advRenderCurrentQuestion = function() {
                    ensureAdvancedQuestionShell_();
                    try {
                        return originalRender.apply(this, arguments);
                    } catch (err) {
                        if (err && /Cannot set properties of null/.test(String(err))) {
                            console.warn('[Advanced] Recovered missing question shell; retrying render once');
                            ensureAdvancedQuestionShell_();
                            return originalRender.apply(this, arguments);
                        }
                        throw err;
                    }
                };
                window.__advRenderGuardInstalled = true;
            }

            document.addEventListener('DOMContentLoaded', function() {
                var attempts = 0;
                var t = setInterval(function() {
                    attempts++;
                    installAdvancedRenderGuard_();
                    if (window.__advRenderGuardInstalled || attempts > 40) clearInterval(t);
                }, 250);
            });

      </script>
</body>


</html>
