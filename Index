<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CP-OS v1.0 DSS (Lite)</title>

  <!-- ✅ DROP-IN (CLEAN) CSS: keeps your look, removes unrelated legacy overrides -->
  <style>
    :root{
      --bg:#f5f6fb;
      --surface:#ffffff;
      --surface2:#f2f3f7;
      --surface3:#e9edf5;

      --text:#1f2937;
      --muted:#5b6472;
      --muted2:#7a8494;

      --stroke:rgba(31,41,55,0.14);
      --stroke2:rgba(31,41,55,0.10);
      --divider:rgba(31,41,55,0.08);

      --brandBlue1:#2f6fb5;
      --brandBlue2:#3c83c9;
      --brandField:#8fbf78;

      --primary:#2f6fb5;
      --primary2:#245ea6;

      --lemon:#f4d06f;
      --ok:#3a8f4b;
      --warn:#e6a83a;

      --recommended:#3c64b1;
      --conditional:#d77a1f;

      --shadow:0 10px 24px rgba(28,38,63,0.16);
      --shadow2:0 16px 40px rgba(28,38,63,0.18);

      --radius:16px;
      --radius2:22px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .app{max-width:1200px;margin:0 auto;padding:20px 18px 28px}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      margin-bottom:16px;padding:12px 12px;border-radius:var(--radius2);
      background:
        linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.00)),
        linear-gradient(90deg,var(--brandBlue2),var(--brandField));
      color:#fff;box-shadow:var(--shadow2);border:1px solid rgba(255,255,255,0.20);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,rgba(47,111,181,0.95),rgba(143,191,120,0.95));
      box-shadow:0 12px 30px rgba(28,38,63,0.22);position:relative;
    }
    .logo:after{
      content:"";position:absolute;inset:10px;border-radius:10px;
      background:rgba(255,255,255,0.35);border:1px solid rgba(255,255,255,0.35);
    }
    .titleblock .h1{font-size:18px;font-weight:900;margin:0}

    .status-pill{
      display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,0.22);border:1px solid rgba(255,255,255,0.28);color:#fff;
      max-width:520px;
    }
    .dot{width:9px;height:9px;border-radius:50%;background:rgba(255,255,255,0.65)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:#ef4444}
    .status-text{
      font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      color:rgba(255,255,255,0.95);
    }

    .tabs{
      display:flex;gap:10px;padding:10px;border-radius:999px;
      background:rgba(255,255,255,0.70);border:1px solid var(--stroke2);
      margin-bottom:16px;overflow:auto;box-shadow:var(--shadow);
    }
    .tab{
      flex:1;min-width:260px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:999px;cursor:pointer;border:1px solid transparent;
      background:rgba(255,255,255,0.85);color:var(--text);transition:all 120ms ease;user-select:none;
    }
    .tab:hover{background:rgba(255,255,255,0.95)}
    .tab.active{
      background:linear-gradient(180deg,rgba(244,208,111,0.60),rgba(255,255,255,0.92));
      border-color:rgba(244,208,111,0.90);box-shadow:0 10px 22px rgba(28,38,63,0.14);
    }
    .badgeNum{
      width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;
      border-radius:999px;font-weight:950;font-size:12px;background:rgba(31,41,55,0.08);
      border:1px solid rgba(31,41,55,0.12);
    }
    .tab.active .badgeNum{background:rgba(244,208,111,0.65);border-color:rgba(244,208,111,0.95)}
    .tabText{display:flex;flex-direction:column;gap:2px}
    .tab .label{font-weight:900;font-size:13px}
    .tab .desc{font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1.25fr 0.75fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--surface);border:1px solid var(--stroke);
      border-radius:var(--radius2);box-shadow:var(--shadow);overflow:hidden;
    }
    .cardHeader{
      padding:14px 16px;border-bottom:1px solid var(--divider);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:linear-gradient(180deg,rgba(233,237,245,0.75),rgba(255,255,255,0));
    }
    .cardHeader .h2{
      margin:0;font-size:13px;letter-spacing:0.35px;font-weight:950;text-transform:uppercase;color:var(--text);
    }
    .cardHeader .hint{font-size:12px;color:var(--muted)}
    .cardBody{padding:14px 16px 16px}

    .btnRow{display:flex;flex-wrap:wrap;gap:10px}
    .btn{
      border-radius:999px;padding:10px 14px;border:1px solid var(--stroke2);
      background:rgba(233,237,245,0.85);color:var(--text);cursor:pointer;
      font-weight:900;font-size:13px;transition:all 120ms ease;user-select:none;
    }
    .btn:hover{background:rgba(233,237,245,1)}
    .btn.primary{
      background:linear-gradient(180deg,rgba(47,111,181,0.95),rgba(36,94,166,0.95));
      border-color:rgba(36,94,166,0.85);color:#fff;
    }
    .btn.ghost{background:rgba(255,255,255,0.90)}
    .btn:disabled{opacity:0.55;cursor:not-allowed}

    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:980px){.formGrid{grid-template-columns:1fr}}

    .field{
      background:rgba(255,255,255,0.92);border:1px solid var(--stroke2);
      border-radius:14px;padding:10px 12px;
    }
    .field label{
      display:flex;justify-content:space-between;gap:8px;font-size:12px;color:var(--muted);margin-bottom:8px;
    }
    .field label .cat{
      font-size:11px;color:var(--muted2);border:1px solid var(--stroke2);
      padding:2px 8px;border-radius:999px;background:rgba(233,237,245,0.70);white-space:nowrap;
    }
        /* === Unit label pill (only the small % / mg/kg / etc chip) === */
    .field label .cat{
      background: rgb(220, 245, 225);   /* light green fill */
      border-color: rgb(160, 215, 170); /* soft green border */
      color: rgb(35, 95, 55);           /* dark green text */
      font-weight: 800;
    }

    
    input, textarea{
      width:100%;border-radius:12px;border:1px solid var(--stroke2);
      background:rgba(255,255,255,0.95);color:var(--text);padding:10px 10px;font-size:13px;outline:none;
    }
    textarea{min-height:84px;resize:vertical}

    .small{font-size:13px;color:var(--muted);line-height:1.55}
    .mutedBox{
      border:1px dashed rgba(47,111,181,0.28);
      border-radius:14px;padding:12px 12px;
      background:linear-gradient(180deg,rgba(47,111,181,0.10),rgba(255,255,255,0.92));
      color:#111827;font-size:13px;line-height:1.6;
      white-space:pre-line;
    }

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:8px 11px;border-radius:999px;
      border:1px solid var(--stroke2);background:rgba(255,255,255,0.85);
      font-size:13px;color:var(--text);
    }
    .chip .k{font-family:var(--mono);font-size:11.5px;color:var(--muted2)}

    .pill{
      display:inline-flex;align-items:center;border-radius:999px;padding:7px 11px;
      font-weight:950;font-size:12px;letter-spacing:0.25px;border:1px solid var(--stroke2);
      background:rgba(233,237,245,0.85);text-transform:uppercase;color:var(--text);
    }
    .pill.ok{background:rgba(58,143,75,0.18);border-color:rgba(58,143,75,0.35);color:#1f5f2f}
    .pill.warn{background:rgba(215,122,31,0.18);border-color:rgba(215,122,31,0.35);color:#7a3f0a}
    .pill.bad{background:rgba(239,68,68,0.10);border-color:rgba(239,68,68,0.35);color:#991b1b}
    .pill.blue{background:rgba(60,100,177,0.18);border-color:rgba(60,100,177,0.35);color:#25408c}
    

    .pathGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:980px){.pathGrid{grid-template-columns:1fr}}

    .pathCard{
      position:relative;border:1px solid rgba(31,41,55,0.10);
      box-shadow:0 10px 24px rgba(28,38,63,0.10);overflow:hidden;border-radius:18px;
      padding:14px;background:linear-gradient(180deg,rgba(47,111,181,0.07),rgba(255,255,255,1) 60%);
    }
    .pathCard::before{
      content:"";position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:18px 0 0 18px;
      background:rgba(47,111,181,0.55);
    }
    .pathCard.path-rp{background:linear-gradient(180deg,rgba(58,143,75,0.10),rgba(255,255,255,1) 60%)}
    .pathCard.path-rp::before{background:rgba(58,143,75,0.60)}
    .pathCard.path-awd{background:linear-gradient(180deg,rgba(215,122,31,0.10),rgba(255,255,255,1) 60%)}
    .pathCard.path-awd::before{background:rgba(215,122,31,0.60)}
    .pathCard.path-bio{background:linear-gradient(180deg,rgba(60,100,177,0.10),rgba(255,255,255,1) 60%)}
    .pathCard.path-bio::before{background:rgba(60,100,177,0.60)}
    .pathCard.path-erw{background:linear-gradient(180deg,rgba(15,118,110,0.10),rgba(255,255,255,1) 60%)}
    .pathCard.path-erw::before{background:rgba(15,118,110,0.60)}

    .pathTop{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:12px}
    .pathName{font-weight:1000;font-size:15px;margin:0;color:var(--text)}
    .pathMeta{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .list{margin:8px 0 0;padding-left:16px;color:rgba(31,41,55,0.78);font-size:13px;line-height:1.6}

    .flag-chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      border:1px solid #cbd5e1;background:#f8fafc;color:#0f172a;font-size:12px;line-height:1;white-space:nowrap;
    }
    .flag-good{background:#DCFCE7;border-color:#86EFAC;color:#166534}
    .flag-bad{background:#FEE2E2;border-color:#FCA5A5;color:#991B1B}
    .flag-neutral{background:#F1F5F9;border-color:#CBD5E1;color:#334155}

    .panel{display:none}
    .panel.active{display:block}

    .foot{margin-top:14px;font-size:12px;color:rgba(31,41,55,0.45);text-align:center}

/* Data entry field title (e.g. Sand fraction) */
.field > label > span:first-child {
  font-weight: 800;                 /* bold */
  color: rgb(128, 0, 32);           /* maroon */
}



  </style>
</head>

<body>
  <div class="app">
    <!-- Top Bar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="titleblock">
          <div class="h1">Soil Carbon Pathway-Optimization System (SCP-OS) v1.0</div>
        </div>
      </div>
      <div class="status-pill">
        <div id="statusDot" class="dot"></div>
        <div id="statusText" class="status-text">Loading CPOS_Lite tables…</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="CP-OS stages">
      <button class="tab active" role="tab" aria-selected="true" data-step="1" onclick="goStep(1)">
        <span class="badgeNum">1</span>
        <span class="tabText">
          <span class="label">Land and Management context</span>
          <span class="desc">Enter values (auto-classify)</span>
        </span>
      </button>

      <button class="tab" role="tab" aria-selected="false" data-step="2" onclick="goStep(2)">
        <span class="badgeNum">2</span>
        <span class="tabText">
          <span class="label">Carbon Opportunity Analysis</span>
          <span class="desc">Scores • Eligibility • MRV tier</span>
        </span>
      </button>

      <button class="tab" role="tab" aria-selected="false" data-step="3" onclick="goStep(3)">
        <span class="badgeNum">3</span>
        <span class="tabText">
          <span class="label">Decision Summary</span>
          <span class="desc">Stack + Save</span>
        </span>
      </button>
    </div>

    <!-- PANELS -->
    <div id="panel1" class="panel active">
      <div class="grid">
        <!-- Left -->
        <div class="card">
          <div class="cardHeader">
            <h3 class="h2">Inputs</h3>
            <div class="hint">Grouped by Factor_Category • Numeric entry auto-classifies</div>
          </div>
          <div class="cardBody">
            <div class="formGrid" id="factorForm"></div>

            <div id="evalGate" style="margin-top:12px;">
              <div class="btnRow">
                <button class="btn ghost" onclick="clearSelections()">Clear</button>
                <button class="btn primary" id="btnEvaluate" onclick="evaluateAndGo()" disabled>Evaluate →</button>
              </div>
              <div id="evalGateHint" class="small" style="margin-top:8px"></div>
            </div>

            <div style="margin-top:10px" class="small" id="selectionHint">
              Tip: Enter any soil + climate + management values you have. You can evaluate even with partial inputs.
            </div>
          </div>
        </div>

        <!-- Right -->
        <div class="card">
          <div class="cardHeader">
            <h3 class="h2">Explainability</h3>
            <div class="hint">Weights × desirability + Pathway_context</div>
          </div>
          <div class="cardBody">
            <div id="notesBox" class="mutedBox">
              Enter values to view class, desirability, and pathway context here.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="panel2" class="panel">
      <div class="grid">
        <!-- Left: results -->
        <div class="card">
          <div class="cardHeader">
            <h3 class="h2">Pathway Screening</h3>
            <div class="hint">Computed from CPOS_Lite_Bounds + CPOS_Lite_Desirability + CPOS_Lite_Weights</div>
          </div>
          <div class="cardBody">
            <div id="screeningGrid" class="pathGrid"></div>

            <div style="margin-top:12px" class="btnRow">
              <button class="btn ghost" onclick="goStep(1)">← Back</button>
              <button class="btn primary" onclick="goStep(3)">Decision Summary →</button>
            </div>
          </div>
        </div>

        <!-- Right: selection recap -->
        <div class="card">
          <div class="cardHeader">
            <h3 class="h2">Current Inputs</h3>
            <div class="hint">Observed_Value + classified Class_Label</div>
          </div>
          <div class="cardBody">
            <div id="selectionRecap" class="chips"></div>
            <div style="margin-top:12px" class="mutedBox" id="mrvStrip">
              MRV focus strip will appear after evaluation.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="panel3" class="panel">
      <div class="grid">
        <!-- Left: decision summary -->
        <div class="card">
          <div class="cardHeader">
            <h3 class="h2">Decision Summary</h3>
            <div class="hint">Recommended stack + key cautions</div>
          </div>
          <div class="cardBody">
            <div id="headlineBox" class="mutedBox">Evaluate at least one input to generate a decision summary.</div>

            <div class="small" style="margin-bottom:8px;color:var(--muted)"><b>Recommended</b></div>
            <div id="recStack" class="chips" style="margin-bottom:12px"></div>

            <div class="small" style="margin-bottom:8px;color:var(--muted)"><b>Conditional</b></div>
            <div id="condStack" class="chips" style="margin-bottom:12px"></div>

            <div class="small" style="margin-bottom:8px;color:var(--muted)"><b>Excluded</b></div>
            <div id="exclStack" class="chips" style="margin-bottom:8px"></div>

            <div style="margin-top:12px" class="btnRow">
              <button class="btn ghost" onclick="goStep(2)">← Back</button>
              <button class="btn primary" onclick="openSaveDrawer()">Save Assessment</button>
            </div>
          </div>
        </div>

        <!-- Right: save drawer -->
        <div class="card">
          <div class="cardHeader">
            <h3 class="h2">Save Assessment</h3>
            <div class="hint">Optional (Apps Script)</div>
          </div>
          <div class="cardBody">
            <div class="small" style="margin-bottom:10px">
              Optional in v1.0. If your assessment sheet + backend function is ready, fill fields and save.
            </div>

            <div class="formGrid">
              <div class="field">
                <label>Client_ID <span class="cat">meta</span></label>
                <input id="metaClientId" placeholder="Default">
              </div>
              <div class="field">
                <label>Site_ID <span class="cat">meta</span></label>
                <input id="metaSiteId" placeholder="SITE-001">
              </div>
              <div class="field">
                <label>Site_Name <span class="cat">meta</span></label>
                <input id="metaSiteName" placeholder="Village / Farm / Plot">
              </div>
              <div class="field">
                <label>Crop_System <span class="cat">meta</span></label>
                <input id="metaCropSystem" placeholder="Rice paddy / Upland cereal / etc.">
              </div>
              <div class="field">
                <label>Latitude <span class="cat">meta</span></label>
                <input id="metaLat" placeholder="26.1234">
              </div>
              <div class="field">
                <label>Longitude <span class="cat">meta</span></label>
                <input id="metaLon" placeholder="81.9876">
              </div>
              <div class="field">
                <label>State <span class="cat">meta</span></label>
                <input id="metaState" placeholder="UP">
              </div>
              <div class="field">
                <label>District <span class="cat">meta</span></label>
                <input id="metaDistrict" placeholder="Sonbhadra">
              </div>
              <div class="field" style="grid-column:1/-1">
                <label>Notes <span class="cat">meta</span></label>
                <textarea id="metaNotes" placeholder="Any assumptions, site notes, constraints…"></textarea>
              </div>
            </div>

            <div style="margin-top:12px" class="btnRow">
              <button class="btn ghost" onclick="fillDemoMeta()">Fill Demo</button>
              <button class="btn primary" onclick="saveAssessment()">Save → Sheet</button>
            </div>

            <div id="saveStatus" style="margin-top:10px" class="small"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="foot">CP-OS v1.0 • CPOS-Lite (Bounds + Desirability + Weights)</div>
  </div>

  <script>
    // ============================================================
    // ✅ CPOS-LITE FRONTEND (DROP-IN)
    // Removes: CPOS_classes/CPOS_rules usage, funnel logic, draft saves, server evaluation calls.
    // Uses ONLY: CPOS_Lite_Bounds, CPOS_Lite_Desirability, CPOS_Lite_Weights
    // ============================================================

    function setStatus(ok, msg) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      dot.classList.remove('ok','bad');
      dot.classList.add(ok ? 'ok' : 'bad');
      text.textContent = msg || (ok ? 'Ready' : 'Error');
    }

    function goStep(n) {
      document.querySelectorAll('.tab').forEach(el => {
        const isActive = Number(el.dataset.step) === Number(n);
        el.classList.toggle('active', isActive);
        el.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      document.getElementById('panel1').classList.toggle('active', n === 1);
      document.getElementById('panel2').classList.toggle('active', n === 2);
      document.getElementById('panel3').classList.toggle('active', n === 3);
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function makePill(type, text) {
      const span = document.createElement('span');
      span.className = 'pill ' + (type || '');
      span.textContent = text;
      return span;
    }

    function makeChip(label, value) {
      const div = document.createElement('div');
      div.className = 'chip';
      div.innerHTML = `<span class="k">${escapeHtml(label)}</span> <span>${escapeHtml(value)}</span>`;
      return div;
    }

    function toNum(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    function toBool(v){
      if (typeof v === 'boolean') return v;
      const s = String(v || '').trim().toLowerCase();
      return (s === 'true' || s === '1' || s === 'yes' || s === 'y');
    }

    // ---------------------------
    // CPOS-Lite state + indexes
    // ---------------------------
    const CPOSL = {
      PATHWAYS: ['Regenerative Ag','Biochar','ERW','AWD'],
      data: { bounds:[], desirability:[], weights:[] },
      idx: {
        boundsByVar: new Map(),          // var -> {meta, classes[]}
        factorsByCat: new Map(),         // cat -> [factorMeta]
        desirByVarPathClass: new Map(),  // `${var}||${path}||${class}` -> {d, shape, ctx}
        weightByVarPath: new Map()       // `${var}||${path}` -> weight
      },
      selections: {},  // var -> {Observed_Value, Class_Label, Class_Order, meta...}
      computed: {},    // var -> {path -> {desir, weight, score, shape, ctx}}
      lastResults: null
    };

    // ---------------------------
    // Backend loader (single call)
    // ---------------------------
function getCPOSLiteTables() {
  return new Promise((resolve, reject) => {
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      reject(new Error('Apps Script runtime not available (local mode).'));
      return;
    }
    google.script.run
      .withSuccessHandler(res => resolve(res || {}))
      .withFailureHandler(err => reject(err))
      .getCPOSLiteTables(); // ✅ backend function added above
  });
}


    // ---------------------------
    // Build indexes from 3 sheets
    // ---------------------------
    function buildIndexes_() {
  // ---------------------------
  // Pathway normalization (matches backend intent)
  // ---------------------------
  function normPathway_(p) {
    const s = String(p || '').trim();
    const k = s.toLowerCase();

    // map common variants -> canonical
    if (k === 'rp-soc' || k === 'rp soc' || k === 'regenerative ag' || k === 'regenerative agriculture') return 'RP-SOC';
    if (k === 'awd' || k === 'awd-ch4' || k === 'awd-ch₄' || k === 'awd-ch₄' || k === 'awd ch4') return 'AWD-CH₄';
    if (k === 'biochar') return 'BIOCHAR';
    if (k === 'erw') return 'ERW';

    // if already canonical or unknown, keep as-is
    return s;
  }

  // ---------------------------
  // Reset indexes
  // ---------------------------
  CPOSL.idx.boundsByVar = new Map();
  CPOSL.idx.factorsByCat = new Map();
  CPOSL.idx.desirByVarPathClass = new Map();
  CPOSL.idx.weightByVarPath = new Map();

  // ---------------------------
  // Bounds (CPOS_Lite_Bounds)
  // ---------------------------
  for (const r of (CPOSL.data.bounds || [])) {
    const varName = String(r.Variable_Name || '').trim();
    if (!varName) continue;

    const f = CPOSL.idx.boundsByVar.get(varName) || {
      Variable_Name: varName,
      Factor_ID: String(r.Factor_ID || '').trim(),
      Factor_Category: String(r.Factor_Category || 'Other').trim(),
      Factor_Display_Name: String(r.Factor_Display_Name || varName).trim(),
      Unit: String(r.Unit || '').trim(),
      classes: []
    };

    const classLabel = String(r.Class_Label || '').trim(); // ✅ canonical header
    if (!classLabel) continue;

    f.classes.push({
      Class_Order: toNum(r.Class_Order),
      Class_Label: classLabel,
      Lower_Bound: toNum(r.Lower_Bound),
      Upper_Bound: toNum(r.Upper_Bound),
      Lower_Inclusive: toBool(r.Lower_Inclusive),
      Upper_Inclusive: toBool(r.Upper_Inclusive)
    });

    CPOSL.idx.boundsByVar.set(varName, f);
  }

  // Sort classes, group factors by category
  for (const [, f] of CPOSL.idx.boundsByVar.entries()) {
    f.classes.sort((a, b) => (a.Class_Order ?? 0) - (b.Class_Order ?? 0));

    const cat = f.Factor_Category || 'Other';
    if (!CPOSL.idx.factorsByCat.has(cat)) CPOSL.idx.factorsByCat.set(cat, []);
    CPOSL.idx.factorsByCat.get(cat).push(f);
  }

  for (const [, arr] of CPOSL.idx.factorsByCat.entries()) {
    arr.sort((a, b) => (a.Factor_Display_Name || '').localeCompare(b.Factor_Display_Name || ''));
  }

  // ---------------------------
  // Desirability (CPOS_Lite_Desirability)
  // key: `${Variable_Name}||${Pathway}||${Class_Label}`
  // ---------------------------
  for (const r of (CPOSL.data.desirability || [])) {
    const varName = String(r.Variable_Name || '').trim();
    const pathway = normPathway_(r.Pathway);
    const classLabel = String(r.Class_Label || '').trim(); // ✅ canonical header
    if (!varName || !pathway || !classLabel) continue;

    const d = toNum(r.Desirability_0_1);
    if (!Number.isFinite(d)) continue;

    const key = `${varName}||${pathway}||${classLabel}`;
    CPOSL.idx.desirByVarPathClass.set(key, {
      d,
      shape: String(r.Shape || '').trim(),
      ctx: String(r.Pathway_Context || '').trim()
    });
  }

  // ---------------------------
  // Weights (CPOS_Lite_Weights)
  // key: `${Variable_Name}||${Pathway}`
  // ---------------------------
  for (const r of (CPOSL.data.weights || [])) {
    const varName = String(r.Variable_Name || '').trim();
    const pathway = normPathway_(r.Pathway);
    if (!varName || !pathway) continue;

    const w = toNum(r.Sensitivity_Weight_0_10);
    if (!Number.isFinite(w)) continue;

    const key = `${varName}||${pathway}`;
    CPOSL.idx.weightByVarPath.set(key, w);
  }

  // ---------------------------
  // Optional: quick diagnostics (safe)
  // ---------------------------
  try {
    console.log('[CPOS] buildIndexes_',
      'bounds vars=', CPOSL.idx.boundsByVar.size,
      'desir keys=', CPOSL.idx.desirByVarPathClass.size,
      'weight keys=', CPOSL.idx.weightByVarPath.size
    );
  } catch (e) {}
}


    // ---------------------------
    // Classification from bounds
    // ---------------------------
    function classifyValue_(factor, observedValue) {
      if (observedValue === null || !Number.isFinite(observedValue)) return null;

      for (const c of (factor.classes || [])) {
        const lo = c.Lower_Bound;
        const hi = c.Upper_Bound;

        const passLo = (lo === null) ? true : (c.Lower_Inclusive ? (observedValue >= lo) : (observedValue > lo));
        const passHi = (hi === null) ? true : (c.Upper_Inclusive ? (observedValue <= hi) : (observedValue < hi));

        if (passLo && passHi) return { Class_Order: c.Class_Order, Class_Label: c.Class_Label };
      }
      return null;
    }

    // ---------------------------
    // UI render (group by Factor_Category)
    // ---------------------------
    function renderFactorForm() {
      const host = document.getElementById('factorForm');
      host.innerHTML = '';

      if (!CPOSL.idx.factorsByCat.size) {
        host.innerHTML = `<div class="mutedBox" style="grid-column:1/-1">No factors loaded.</div>`;
        updateEvalGateUI_();
        return;
      }

      for (const [cat, factors] of CPOSL.idx.factorsByCat.entries()) {
        // category header as full-width field
        const catField = document.createElement('div');
        catField.className = 'field';
catField.style.background = 'rgba(245, 238, 220, 1)';   // light beige
catField.style.borderColor = 'rgba(214, 198, 160, 1)'; // muted beige border

        catField.style.gridColumn = '1/-1';
        catField.innerHTML = `<label><span><b>${escapeHtml(cat)}</b></span><span class="cat">Factor_Category</span></label>
          <div class="small">Enter values for factors in this category. Class_Label will be auto-derived from Bounds.</div>`;
        host.appendChild(catField);

        // factor fields (2-column grid continues)
        for (const f of factors) {
          const field = document.createElement('div');
          field.className = 'field';

          const id = 'inp_' + f.Variable_Name.replaceAll(/[^a-zA-Z0-9]+/g,'_');
          const cur = CPOSL.selections[f.Variable_Name] || {};
          const curVal = (cur.Observed_Value ?? '');

          field.innerHTML = `
            <label>
              <span>${escapeHtml(f.Factor_Display_Name || f.Variable_Name)}</span>
              <span class="cat">${escapeHtml(f.Unit || '—')}</span>
            </label>
            <input id="${id}" type="number" step="any" placeholder="Observed value (e.g., 0.2)" value="${escapeHtml(curVal)}">
            <div class="small" style="margin-top:8px">
<!--     <b>Variable_Name:</b> <span style="font-family:var(--mono)">${escapeHtml(f.Variable_Name)}</span><br>      -->
              <b>Class:</b> <span id="${id}_cls">${escapeHtml(cur.Class_Label || '—')}</span>
            </div>
          `;

          host.appendChild(field);

          // bind
          const inp = field.querySelector('#' + id);
          inp.addEventListener('input', () => {
            const raw = inp.value;
            const val = raw === '' ? null : Number(raw);
            onValueChange_(f, val);
            const clsEl = document.getElementById(id + '_cls');
            if (clsEl) clsEl.textContent = CPOSL.selections[f.Variable_Name]?.Class_Label || '—';
            renderNotesBox();
            updateEvalGateUI_();
          });
        }
      }

      renderNotesBox();
      updateEvalGateUI_();
    }

    function onValueChange_(factor, observedValue) {
      const varName = factor.Variable_Name;
      const classified = classifyValue_(factor, observedValue);

      CPOSL.selections[varName] = {
        Variable_Name: varName,
        Factor_ID: factor.Factor_ID,
        Factor_Category: factor.Factor_Category,
        Factor_Display_Name: factor.Factor_Display_Name,
        Unit: factor.Unit || '',
        Observed_Value: observedValue,
        Class_Order: classified ? classified.Class_Order : null,
        Class_Label: classified ? classified.Class_Label : null
      };

      // compute by pathway for this var
      CPOSL.computed[varName] = {};
      for (const p of CPOSL.PATHWAYS) {
        const cls = classified?.Class_Label || '';
        const dKey = `${varName}||${p}||${cls}`;
        const wKey = `${varName}||${p}`;

        const dRow = CPOSL.idx.desirByVarPathClass.get(dKey) || null;
        const w = CPOSL.idx.weightByVarPath.get(wKey);

        const desir = dRow ? dRow.d : null;
        const shape = dRow ? dRow.shape : '';
        const ctx = dRow ? dRow.ctx : '';

        const score = (Number.isFinite(desir) && Number.isFinite(w)) ? (desir * w) : null;

        CPOSL.computed[varName][p] = { desir, w, score, shape, ctx };
      }
    }

    function countInputs_() {
      let c = 0;
      for (const k of Object.keys(CPOSL.selections)) {
        const v = CPOSL.selections[k]?.Observed_Value;
        if (v !== null && v !== undefined && v !== '' && Number.isFinite(Number(v))) c++;
      }
      return c;
    }

    function updateEvalGateUI_() {
      const hint = document.getElementById('evalGateHint');
      const btn = document.getElementById('btnEvaluate');
      const n = countInputs_();

      const MIN_REQUIRED = 1;
      const ok = n >= MIN_REQUIRED;

      if (hint) {
        hint.textContent = ok
          ? `Ready to evaluate. Entered ${n} value(s).`
          : `Enter at least ${MIN_REQUIRED} value to evaluate.`;
      }
      if (btn) btn.disabled = !ok;
    }

    // ---------------------------
    // Explainability panel
    // ---------------------------
    function classifyFlagFromDesirability_(d) {
      if (d === null || d === undefined || isNaN(Number(d))) return { cls: 'flag-neutral', txt: 'NA' };
      const x = Number(d);
      if (x <= 0.33) return { cls: 'flag-bad', txt: 'Adverse' };
      if (x >= 0.67) return { cls: 'flag-good', txt: 'Supportive' };
      return { cls: 'flag-neutral', txt: 'Mixed' };
    }

    function renderNotesBox() {
      const box = document.getElementById('notesBox');
      if (!box) return;

      const parts = [];
      const vars = Object.keys(CPOSL.selections || {});
      vars.forEach(varName => {
        const sel = CPOSL.selections[varName] || {};
        if (!sel || sel.Observed_Value === null || sel.Observed_Value === undefined || sel.Observed_Value === '') return;
        if (!sel.Class_Label) return;

        const rows = CPOSL.PATHWAYS.map(p => {
          const c = CPOSL.computed?.[varName]?.[p] || {};
          const dOk = Number.isFinite(c.desir);
          const wOk = Number.isFinite(c.w);
          const sOk = Number.isFinite(c.score);

          const badge = classifyFlagFromDesirability_(dOk ? c.desir : null);

          const ctx = c.ctx ? ` — ${c.ctx}` : '';
          const shape = c.shape ? ` ${c.shape}` : '';

          return `- ${p}: d=${dOk ? c.desir.toFixed(2) : 'NA'}, w=${wOk ? c.w.toFixed(1) : 'NA'}, score=${sOk ? c.score.toFixed(2) : 'NA'}${shape} [${badge.txt}]${ctx}`;
        }).join('\n');

        parts.push(
          `${sel.Factor_Display_Name || varName} (${varName})\n` +
          `Observed_Value: ${sel.Observed_Value} ${sel.Unit || ''}\n` +
          `Class_Label: ${sel.Class_Label}\n` +
          `${rows}\n`
        );
      });

      box.textContent = parts.length
        ? parts.join('\n--------------------------------\n')
        : 'Enter values to view class, desirability, and pathway context here.';
    }

    // ---------------------------
    // Evaluation -> pathway screening (local compute)
    // ---------------------------
    function computePathwayResults_() {
      const results = {};
      const pathways = CPOSL.PATHWAYS;

      // accumulate per pathway
      const acc = {};
      pathways.forEach(p => acc[p] = { sumScore:0, sumW:0, n:0, bad:[], good:[], mrvBad:false, mrvGood:true });

      for (const varName of Object.keys(CPOSL.computed || {})) {
        const sel = CPOSL.selections[varName] || {};
        const hasInput = sel && sel.Class_Label && Number.isFinite(Number(sel.Observed_Value));
        if (!hasInput) continue;

        for (const p of pathways) {
          const c = CPOSL.computed[varName]?.[p] || {};
          const d = c.desir;
          const w = c.w;
          if (!Number.isFinite(d) || !Number.isFinite(w)) continue;

          acc[p].sumScore += (d * w);
          acc[p].sumW += w;
          acc[p].n += 1;

          const isMRV = String(sel.Factor_Category || '').trim().toLowerCase() === 'mrv';
          if (isMRV) {
            if (d <= 0.33) acc[p].mrvBad = true;
            if (d < 0.67) acc[p].mrvGood = false;
          }

          if (d <= 0.33) acc[p].bad.push(`${sel.Factor_Display_Name || varName} (${sel.Class_Label})`);
          if (d >= 0.67) acc[p].good.push(`${sel.Factor_Display_Name || varName} (${sel.Class_Label})`);
        }
      }

      // map to UI keys + construct payload similar to your old renderer
      // UI order: RP-SOC, AWD-CH₄, BIOCHAR, ERW
      const mapUI = [
        { ui:'RP-SOC', path:'Regenerative Ag' },
        { ui:'AWD-CH₄', path:'AWD' },
        { ui:'BIOCHAR', path:'Biochar' },
        { ui:'ERW', path:'ERW' }
      ];

      for (const m of mapUI) {
        const a = acc[m.path] || { sumScore:0,sumW:0,n:0,bad:[],good:[],mrvBad:false,mrvGood:true };
        const avg = a.sumW > 0 ? (a.sumScore / a.sumW) : 0; // normalized 0..1

        // Eligibility from normalized score bands (same semantics as desirability bands)
        let eligibility = 'CONDITIONAL';
        if (avg >= 0.67) eligibility = 'YES';
        else if (avg <= 0.33) eligibility = 'NO';

        // Priority
        let priority = 'MEDIUM';
        if (avg >= 0.75 && a.n >= 3) priority = 'HIGH';
        else if (avg < 0.50) priority = 'LOW';

        // MRV tier (only uses MRV category if present)
        let mrv_tier = 'STANDARD';
        if (a.mrvBad) mrv_tier = 'HIGH';
        else if (a.n && a.mrvGood && (String(m.path) !== '')) mrv_tier = 'LIGHT';

        const reasons = [];
        if (a.good.length) reasons.push(`Supportive factors: ${a.good.slice(0,3).join('; ')}`);
        if (a.bad.length) reasons.push(`Adverse factors: ${a.bad.slice(0,3).join('; ')}`);
        if (!reasons.length) reasons.push('No desirability signals found for entered inputs.');

        const flags = a.bad.slice(0, 10);

        results[m.ui] = {
          eligibility,
          priority,
          mrv_tier,
          reasons,
          flags,
          final_text: `Score=${avg.toFixed(3)} (n=${a.n}, weight_sum=${a.sumW.toFixed(1)})`
        };
      }

      return results;
    }

    function evaluateAndGo() {
      const n = countInputs_();
      if (n < 1) {
        setStatus(false, 'Enter at least 1 value before evaluating.');
        setTimeout(() => setStatus(true, 'Ready'), 1200);
        return;
      }

      setStatus(true, 'Evaluating…');
      const results = computePathwayResults_();
      CPOSL.lastResults = results;

      try { renderSelectionRecap(); } catch(e){ console.warn('renderSelectionRecap failed:', e); }
      try { renderScreening(results); } catch(e){ console.warn('renderScreening failed:', e); }
      try { renderMRVStrip(results); } catch(e){ console.warn('renderMRVStrip failed:', e); }
      try { renderDecisionSummary(results); } catch(e){ console.warn('renderDecisionSummary failed:', e); }

      setStatus(true, 'Evaluation complete');
      goStep(2);
    }

    function renderSelectionRecap() {
      const box = document.getElementById('selectionRecap');
      box.innerHTML = '';
      const sels = CPOSL.selections || {};

      let any = false;
      Object.keys(sels).forEach(varName => {
        const s = sels[varName];
        if (!s || s.Observed_Value === null || s.Observed_Value === undefined || s.Observed_Value === '' || !s.Class_Label) return;
        any = true;
        const label = s.Factor_Display_Name || varName;
        const val = `${s.Observed_Value}${s.Unit ? ' ' + s.Unit : ''} → ${s.Class_Label}`;
        box.appendChild(makeChip(label, val));
      });

      if (!any) box.innerHTML = '<div class="small">No inputs.</div>';
    }

    function pillForEligibility(e){
      if (e === 'YES') return makePill('ok', 'YES');
      if (e === 'NO') return makePill('bad', 'NO');
      return makePill('warn', 'CONDITIONAL');
    }
    function pillForPriority(p){
      if (p === 'HIGH') return makePill('ok', 'PRIORITY: HIGH');
      if (p === 'LOW') return makePill('bad', 'PRIORITY: LOW');
      return makePill('blue', 'PRIORITY: MEDIUM');
    }
    function pillForMRV(m){
      if (m === 'HIGH') return makePill('warn', 'MRV: HIGH');
      if (m === 'LIGHT') return makePill('ok', 'MRV: LIGHT');
      return makePill('blue', 'MRV: STANDARD');
    }

    function renderScreening(results) {
      const grid = document.getElementById('screeningGrid');
      if (!grid) return;
      grid.innerHTML = '';

      const order = ["RP-SOC","AWD-CH₄","BIOCHAR","ERW"];
      order.forEach(k => {
        const r = results?.[k] || {};
        const card = document.createElement('div');
        card.className = 'pathCard';
        if (k === 'RP-SOC') card.classList.add('path-rp');
        else if (k === 'AWD-CH₄') card.classList.add('path-awd');
        else if (k === 'BIOCHAR') card.classList.add('path-bio');
        else if (k === 'ERW') card.classList.add('path-erw');

        const top = document.createElement('div');
        top.className = 'pathTop';

        const name = document.createElement('div');
        name.innerHTML = `
          <div class="pathName">${escapeHtml(k)}</div>
          <div class="small" style="margin-top:3px">
            ${
              (k === "RP-SOC") ? "SOC accumulation (biological)" :
              (k === "AWD-CH₄") ? "Avoided methane in rice paddies" :
              (k === "BIOCHAR") ? "SOC permanence + resilience amplifier" :
              "Durable inorganic CDR (silicate weathering)"
            }
          </div>
        `;

        const meta = document.createElement('div');
        meta.className = 'pathMeta';
        meta.appendChild(pillForEligibility(r.eligibility || 'CONDITIONAL'));
        meta.appendChild(pillForPriority(r.priority || 'MEDIUM'));
        meta.appendChild(pillForMRV(r.mrv_tier || 'STANDARD'));

        top.appendChild(name);
        top.appendChild(meta);
        card.appendChild(top);

        const reasonsArr = Array.isArray(r.reasons) ? r.reasons.filter(Boolean) : [];
        const narrative = String(r.final_text || '').trim();

        if (reasonsArr.length) {
          const ul = document.createElement('ul');
          ul.className = 'list';
          reasonsArr.slice(0, 4).forEach(x => {
            const li = document.createElement('li');
            li.textContent = String(x);
            ul.appendChild(li);
          });
          card.appendChild(ul);
        } else {
          const mb = document.createElement('div');
          mb.className = 'mutedBox';
          mb.textContent = narrative || 'No computed signals (with current inputs).';
          card.appendChild(mb);
        }

        const flagsArr = Array.isArray(r.flags) ? r.flags.filter(Boolean) : [];
        if (flagsArr.length) {
          const wrap = document.createElement('div');
          wrap.className = 'chips';
          wrap.style.marginTop = '10px';
          flagsArr.slice(0, 10).forEach(f => {
            const el = document.createElement('span');
            el.className = `flag-chip flag-bad`;
            el.textContent = String(f);
            wrap.appendChild(el);
          });
          card.appendChild(wrap);
        }

        grid.appendChild(card);
      });
    }

    function renderMRVStrip(results) {
      const box = document.getElementById('mrvStrip');
      const tiers = Object.values(results || {}).map(r => r?.mrv_tier || 'STANDARD');
      let level = 'STANDARD';
      if (tiers.includes('HIGH')) level = 'HIGH';
      else if (tiers.includes('LIGHT')) level = 'LIGHT';

      let msg = '';
      if (level === 'HIGH') msg = 'MRV focus: High-tier monitoring likely needed (MRV category indicates adverse conditions for at least one pathway).';
      else if (level === 'LIGHT') msg = 'MRV focus: Light MRV feasible (MRV category supportive for current inputs).';
      else msg = 'MRV focus: Standard MRV is generally sufficient for current inputs.';

      box.innerHTML = `<b style="color:rgba(47,111,181,0.95)">MRV Focus Strip</b><div style="margin-top:6px">${escapeHtml(msg)}</div>`;
    }

    // ---------------------------
    // Decision summary (kept, but now driven by local results)
    // ---------------------------
    function buildDecisionSummary(results) {
      const pathways = ["RP-SOC","AWD-CH₄","BIOCHAR","ERW"];
      const prRank = { "HIGH":3,"MEDIUM":2,"LOW":1 };
      const mrvRank = { "LIGHT":3,"STANDARD":2,"HIGH":1 };

      const items = pathways.map(k => {
        const r = results[k] || {};
        return {
          k,
          eligibility: r.eligibility || "CONDITIONAL",
          priority: r.priority || "MEDIUM",
          mrv_tier: r.mrv_tier || "STANDARD",
          reasons: r.reasons || [],
          flags: r.flags || []
        };
      });

      const recommended = items
        .filter(x => x.eligibility === "YES")
        .sort((a,b) => prRank[b.priority] - prRank[a.priority] || mrvRank[b.mrv_tier] - mrvRank[a.mrv_tier])
        .map(x => x.k);

      const conditional = items
        .filter(x => x.eligibility === "CONDITIONAL")
        .sort((a,b) => prRank[b.priority] - prRank[a.priority] || mrvRank[b.mrv_tier] - mrvRank[a.mrv_tier])
        .map(x => x.k);

      const excluded = items.filter(x => x.eligibility === "NO").map(x => x.k);

      const riskFlags = [...new Set(items.flatMap(x => x.flags || []))].slice(0, 12);

      const topReasons = {};
      items.forEach(x => {
        if ((x.reasons || []).length) topReasons[x.k] = x.reasons.slice(0, 2);
      });

      const headParts = [];
      if (recommended.length) headParts.push(`${recommended.join(" + ")} recommended`);
      if (conditional.length) headParts.push(`${conditional.join(" + ")} conditional`);
      if (excluded.length) headParts.push(`${excluded.join(" + ")} excluded`);
      const headline = headParts.join("; ") || "No decision available.";

      return { recommended, conditional, excluded, headline, topReasons, riskFlags };
    }

    function renderStackChips(elId, arr, label) {
      const box = document.getElementById(elId);
      if (!box) return;
      box.innerHTML = '';
      if (!arr || !arr.length) {
        box.innerHTML = `<div class="small" style="color:var(--muted)">None</div>`;
        return;
      }
      arr.forEach(k => box.appendChild(makeChip(label, k)));
    }

    function renderDecisionSummary(results) {
      const sum = buildDecisionSummary(results);
      const headlineBox = document.getElementById('headlineBox');

      const reasonsBits = [];
      Object.keys(sum.topReasons || {}).forEach(k => {
        const rr = sum.topReasons[k] || [];
        if (!rr.length) return;
        reasonsBits.push(
          `<div style="margin-top:10px"><b>${escapeHtml(k)}</b><ul class="list">${rr.map(x => `<li>${escapeHtml(x)}</li>`).join('')}</ul></div>`
        );
      });

      const flagsBits = (sum.riskFlags || []).length
        ? `<div style="margin-top:10px"><b>Risk flags</b><div class="chips" style="margin-top:8px">${sum.riskFlags.map(f => `<span class="chip"><span class="k">Flag</span> ${escapeHtml(f)}</span>`).join('')}</div></div>`
        : '';

      headlineBox.innerHTML =
        `<div style="font-weight:1000; font-size:13px">${escapeHtml(sum.headline)}</div>` +
        (reasonsBits.length ? reasonsBits.join('') : `<div style="margin-top:10px;color:var(--muted)">No reasons triggered (with current inputs).</div>`) +
        flagsBits;

      renderStackChips('recStack', sum.recommended, 'Recommended');
      renderStackChips('condStack', sum.conditional, 'Conditional');
      renderStackChips('exclStack', sum.excluded, 'Excluded');
    }

    // ---------------------------
    // Actions
    // ---------------------------
    function clearSelections() {
      CPOSL.selections = {};
      CPOSL.computed = {};
      CPOSL.lastResults = null;
      renderFactorForm();
      renderSelectionRecap();
      document.getElementById('notesBox').textContent =
        'Enter values to view class, desirability, and pathway context here.';
      setStatus(true, 'Selections cleared');
    }

    function openSaveDrawer() {
      if (!CPOSL.lastResults) setStatus(false, 'Evaluate before saving.');
      else setStatus(true, 'Ready to save (optional)');
    }

    function fillDemoMeta(){
      document.getElementById('metaClientId').value = 'Default';
      document.getElementById('metaSiteId').value = 'SITE-001';
      document.getElementById('metaSiteName').value = 'Demo Site';
      document.getElementById('metaCropSystem').value = 'Rice paddy';
      document.getElementById('metaLat').value = '26.1234';
      document.getElementById('metaLon').value = '81.9876';
      document.getElementById('metaState').value = 'UP';
      document.getElementById('metaDistrict').value = 'Sonbhadra';
      document.getElementById('metaNotes').value = 'Demo assessment for CP-OS Lite UI test.';
    }

    function saveAssessment() {
      const out = document.getElementById('saveStatus');
      out.textContent = '';

      if (!CPOSL.lastResults) {
        out.textContent = 'Nothing to save (evaluate first).';
        return;
      }

      const payload = {
        Client_ID: document.getElementById('metaClientId').value || 'Default',
        Site_ID: document.getElementById('metaSiteId').value || '',
        Site_Name: document.getElementById('metaSiteName').value || '',
        Crop_System: document.getElementById('metaCropSystem').value || '',
        Latitude: document.getElementById('metaLat').value || '',
        Longitude: document.getElementById('metaLon').value || '',
        State: document.getElementById('metaState').value || '',
        District: document.getElementById('metaDistrict').value || '',
        selections: CPOSL.selections || {},
        results: CPOSL.lastResults || {},
        notes: document.getElementById('metaNotes').value || ''
      };

      out.textContent = 'Saving…';

      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        out.textContent = 'Save unavailable (local mode).';
        return;
      }

      google.script.run
        .withSuccessHandler(res => {
          if (res && res.ok) {
            out.innerHTML = `<span style="color:rgba(58,143,75,0.95); font-weight:900">Saved:</span> ${escapeHtml(res.Assessment_ID || '')}`;
          } else {
            out.textContent = 'Save failed (bad response).';
          }
        })
        .withFailureHandler(err => {
          out.textContent = 'Save error: ' + (err?.message || err);
        })
        .saveCPOSLiteAssessment(payload); // <-- implement/rename backend if needed
    }

    // ---------------------------
    // Init
    // ---------------------------
    async function init() {
      console.log('[CPOS-Lite] init() start');
      setStatus(true, 'Loading CPOS_Lite tables…');

      try {
        const res = await getCPOSLiteTables();
        if (!res || res.ok === false) {
          setStatus(false, 'Failed to load CPOS_Lite tables (bad response).');
          return;
        }

        CPOSL.data.bounds = res.bounds || [];
        CPOSL.data.desirability = res.desirability || [];
        CPOSL.data.weights = res.weights || [];

        buildIndexes_();

        const nFactors = CPOSL.idx.boundsByVar.size;
        setStatus(true, `Ready • Factors=${nFactors}`);
        renderFactorForm();
      } catch (err) {
        console.error('[CPOS-Lite] load error:', err);
        setStatus(false, 'Load error: ' + (err?.message || String(err)));
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
